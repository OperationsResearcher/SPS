{% extends "base.html" %}
{% block title %}Admin Panel - Stratejik Planlama Sistemi{% endblock %}
{% block content %}
<style>
    /* Yetki Matrisi Stilleri */
    .yetki-card {
        transition: all 0.3s ease;
        border-left: 4px solid;
    }
    .yetki-card.sistem-admin {
        border-left-color: #dc3545;
    }
    .yetki-card.kurum-admin {
        border-left-color: #fd7e14;
    }
    .yetki-card.ust-yonetim {
        border-left-color: #0dcaf0;
    }
    .yetki-card.kurum-user {
        border-left-color: #198754;
    }
    .yetki-switch {
        cursor: pointer;
    }
    .yetki-row:hover {
        background-color: #f8f9fa;
    }
    .rol-badge {
        font-size: 0.9rem;
        padding: 8px 16px;
    }
</style>
{% if current_user.sistem_rol in ['admin', 'kurum_yoneticisi', 'ust_yonetim'] %}
<div class="container-fluid py-4">
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-xl-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center">
                    <div class="stat-icon primary me-3">
                        <i class="fas fa-building"></i>
                    </div>
                    <div>
                        <span class="text-muted small text-uppercase fw-semibold">Toplam Kurum</span>
                        <h3 class="fw-bold mb-0">{{ kurumlar|length }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center">
                    <div class="stat-icon success me-3">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <span class="text-muted small text-uppercase fw-semibold">Toplam Kullanıcı</span>
                        <h3 class="fw-bold mb-0">{{ total_users }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center">
                    <div class="stat-icon warning me-3">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div>
                        <span class="text-muted small text-uppercase fw-semibold">Toplam Süreç</span>
                        <h3 class="fw-bold mb-0">{{ surecler|length }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="stat-card h-100">
                <div class="d-flex align-items-center">
                    <div class="stat-icon info me-3">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div>
                        <span class="text-muted small text-uppercase fw-semibold">Ana Strateji</span>
                        <h3 class="fw-bold mb-0">{{ total_strategies }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <ul class="nav nav-tabs nav-fill mb-4" id="adminTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="organizations-tab" data-bs-toggle="tab" data-bs-target="#organizations" type="button" role="tab" aria-controls="organizations" aria-selected="true">
                                <i class="fas fa-building me-2"></i>Kurumlar
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="false">
                                <i class="fas fa-user-friends me-2"></i>Kullanıcılar
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rol-matrisi2-tab" data-bs-toggle="tab" data-bs-target="#rol-matrisi2" type="button" role="tab" aria-controls="rol-matrisi2" aria-selected="false">
                                <i class="fas fa-check-double me-2"></i>Yetki Matrisi
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="adminTabContent">
                        <!-- Kurum Yönetimi Tab -->
                        <div class="tab-pane fade show active" id="organizations" role="tabpanel" aria-labelledby="organizations-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Kurum Listesi</h5>
                                {% if current_user.sistem_rol == 'admin' %}
                                <button class="btn btn-success" onclick="openNewOrganizationModal()">
                                    <i class="fas fa-plus me-2"></i>Yeni Kurum Ekle
                                </button>
                                {% endif %}
                            </div>
                            {% if kurumlar %}
                            <div class="table-responsive">
                                <table class="table table-striped align-middle">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">Logo</th>
                                            <th style="width: 220px;">Kurum</th>
                                            <th style="width: 220px;">Ticari Ünvan</th>
                                            <th style="width: 160px;">Sektör</th>
                                            <th style="width: 120px;">Çalışan</th>
                                            <th style="width: 200px;">İletişim</th>
                                            <th style="width: 140px;">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for kurum in kurumlar %}
                                        <tr>
                                            <td>
                                                {% if kurum.logo_url %}
                                                    <img src="{{ kurum.logo_url }}" alt="{{ kurum.kisa_ad }}" class="rounded-circle border" style="width: 46px; height: 46px; object-fit: cover;">
                                                {% else %}
                                                    <div class="rounded-circle text-white fw-bold d-flex align-items-center justify-content-center" style="width: 46px; height: 46px; background: linear-gradient(135deg, #667eea, #764ba2);">
                                                        {{ (kurum.kisa_ad or '?')[:2]|upper }}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="fw-bold">{{ kurum.kisa_ad }}</div>
                                                <small class="text-muted">{{ kurum.faaliyet_alani or 'Faaliyet alanı belirtilmemiş' }}</small>
                                            </td>
                                            <td>
                                                <div class="fw-semibold">{{ kurum.ticari_unvan or '-' }}</div>
                                                <small class="text-muted">{{ kurum.web_adresi or 'Web adresi eklenmemiş' }}</small>
                                            </td>
                                            <td>{{ kurum.sektor or '-' }}</td>
                                            <td>
                                                {% if kurum.calisan_sayisi %}
                                                    {{ kurum.calisan_sayisi }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="small">
                                                    <div><i class="fas fa-envelope me-2 text-primary"></i>{{ kurum.email or '-' }}</div>
                                                    <div><i class="fas fa-phone me-2 text-success"></i>{{ kurum.telefon or '-' }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group" aria-label="Kurum işlemleri">
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrganization('{{ kurum.kisa_ad }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% if current_user.sistem_rol in ['admin', 'kurum_yoneticisi', 'ust_yonetim'] %}
                                                    <button class="btn btn-sm btn-outline-warning" onclick="editOrganization('{{ kurum.kisa_ad }}')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if current_user.sistem_rol == 'admin' %}
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteOrganization('{{ kurum.kisa_ad }}', '{{ kurum.id }}')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-building fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Henüz kurum eklenmemiş</h5>
                                <p class="text-muted">İlk kurumu eklemek için yukarıdaki butonu kullanın.</p>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Kullanıcı Yönetimi Tab -->
                        <div class="tab-pane fade" id="users" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Kullanıcı Listesi</h5>
                                <div>
                                    {% if current_user.sistem_rol in ['admin', 'kurum_yoneticisi', 'ust_yonetim'] %}
                                    <button class="btn btn-info me-2" onclick="downloadUserTemplate()">
                                        <i class="fas fa-download me-2"></i>Excel Şablonu İndir
                                    </button>
                                    <button class="btn btn-primary me-2" onclick="openBulkYükleModal()">
                                        <i class="fas fa-upload me-2"></i>Toplu Kullanıcı Yükle
                                    </button>
                                    <button class="btn btn-success" onclick="openNewUserModal()">
                                        <i class="fas fa-plus me-2"></i>Yeni Kullanıcı Ekle
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Ara and filter controls -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" id="user-search-input" class="form-control" placeholder="Kullanıcı adı, e-posta veya kurumda ara...">
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="width: 80px;">Profil</th>
                                            <th style="width: 150px;">Kullanıcı Adı</th>
                                            <th style="width: 200px;">Adı Soyadı</th>
                                            <th style="width: 200px;">E-posta</th>
                                            <th style="width: 220px;" class="text-center">
                                                Ana Rol & Süreç Rolleri
                                                <br><small class="text-muted fw-normal">Kurum içi konum ve süreç atamaları</small>
                                            </th>
                                            <th style="width: 140px;" class="text-center">Kurum</th>
                                            <th style="width: 140px;" class="text-center">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
{% for user in kullanicilar %}
<tr>
    <td class="text-center fw-semibold">{{ user.username[:2]|upper if user.username else '-' }}</td>
    <td>{{ user.username }}</td>
    <td>{{ (user.first_name or '') ~ ' ' ~ (user.last_name or '') }}</td>
    <td>{{ user.email or '-' }}</td>
    <td class="text-center">{{ user.sistem_rol }}</td>
    <td class="text-center">{{ user.kurum.kisa_ad if user.kurum else '-' }}</td>
    <td class="text-center">
        <div class="btn-group" role="group" aria-label="Kullanıcı işlemleri">
            <button class="btn btn-sm btn-outline-info" onclick="viewUser({{ user.id }})" title="Görüntüle">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ user.id }})" title="Düzenle">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username | escape }}')" title="Sil">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
</tr>
{% endfor %}
</tbody>
                                </table>
                            </div>
                            <div id="userTableEmpty" class="text-center py-5" style="display:none;">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Kullanıcı bulunamadı.</h5>
                                <p class="text-muted">Arama kriterlerinizi deÝiþtirin veya yeni kullanıcı ekleyin.</p>
                            </div>
                            <div id="userPagination" class="d-flex justify-content-center mt-3"></div>
                        </div>
                    <div class="tab-pane fade" id="rol-matrisi2" role="tabpanel">
                        <div class="container-fluid p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-check-double"></i> Yetki Matrisi</h4>
                                <div>
                                    <button class="btn btn-success btn-sm me-2" onclick="saveRolMatrisi2()">
                                        <i class="fas fa-save"></i> Kaydet
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="loadRolMatrisi2()">
                                        <i class="fas fa-sync"></i> Yenile
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Bilgi:</strong> Admin tüm kullanıcıları görür; kurum yöneticisi ve üst yönetim sadece kendi kurumundaki kullanıcıları görür.
                            </div>
                            <div id="rol-matrisi2-loading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                                <p class="mt-3 text-muted">Rol matrisi 2 yükleniyor...</p>
                            </div>
                            <div id="rol-matrisi2-content" style="display:none;"></div>
                            <div id="rol-matrisi2-error" style="display:none;" class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>Hata:</strong> Rol matrisi 2 yüklenirken bir hata oluştu.
                                <button class="btn btn-sm btn-danger ms-3" onclick="loadRolMatrisi2()">Tekrar Dene</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Yeni Kurum Modal -->
<div class="modal fade" id="newOrgModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Yeni Kurum Ekle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newOrgForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Kısa Ad <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newOrgKisaAd" required placeholder="Örn: ABC A.Ş.">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ticari Ünvan <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newOrgTicariUnvan" required placeholder="ABC Teknoloji Anonim Şirketi">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Faaliyet Alanı</label>
                                <input type="text" class="form-control" id="newOrgFaaliyetAlani" placeholder="Yazılım Geliştirme">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Çalışan Sayısı</label>
                                <input type="number" class="form-control" id="newOrgCalisanSayisi" placeholder="50">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sektör</label>
                                <select class="form-control" id="newOrgSektor">
                                    <option value="">Seçiniz...</option>
                                    <option value="Teknoloji">Teknoloji</option>
                                    <option value="İmalat">İmalat</option>
                                    <option value="Hizmet">Hizmet</option>
                                    <option value="Eğitim">Eğitim</option>
                                    <option value="Sağlık">Sağlık</option>
                                    <option value="Finans">Finans</option>
                                    <option value="Ticaret">Ticaret</option>
                                    <option value="Kamu">Kamu</option>
                                    <option value="Tarım">Tarım</option>
                                    <option value="İnşaat">İnşaat</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">E-posta</label>
                                <input type="email" class="form-control" id="newOrgEmail" placeholder="info@abc.com">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Telefon</label>
                                <input type="tel" class="form-control" id="newOrgTelefon" placeholder="+90 212 555 0123">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Web Adresi</label>
                                <input type="url" class="form-control" id="newOrgWeb" placeholder="https://www.abc.com">
                            </div>
                        </div>
                    </div>
                    <!-- Logo Seçimi -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-image me-2"></i>Kurum Logosu
                            </h6>
                            <div class="card">
                                <div class="card-body">
                                    <!-- Logo Seçim Seçenekleri -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-upload me-1"></i>Bilgisayardan Logo Yükle
                                                </label>
                                                <input type="file" class="form-control" id="logoFile" accept=".png,.jpg,.jpeg,.gif,.svg,.webp" onchange="handleLogoYukle(this)">
                                                <small class="text-muted">PNG, JPG, JPEG, GIF, SVG, WEBP formatları desteklenir. Maksimum 16MB.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-link me-1"></i>Logo URL'si
                                                </label>
                                                <input type="url" class="form-control" id="newOrgLogoUrl" placeholder="https://example.com/logo.png" onchange="handleLogoUrl(this)">
                                                <small class="text-muted">Veya internetten logo URL'si girin.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Logo Önizleme -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div id="logoPreview" style="display: none;">
                                                <hr>
                                                <div class="text-center">
                                                    <p class="mb-2"><strong>Logo Önizleme:</strong></p>
                                                    <img id="logoPreviewImage" src="" alt="Logo Önizleme" style="max-width: 200px; max-height: 120px; border: 1px solid #ddd; border-radius: 8px;">
                                                    <br>
                                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearLogo()">
                                                        <i class="fas fa-trash me-1"></i>Logoyu Kaldır
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Vergi Dairesi</label>
                                <input type="text" class="form-control" id="newOrgVergiDairesi" placeholder="Kadıköy Vergi Dairesi">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Vergi Numarası</label>
                                <input type="text" class="form-control" id="newOrgVergiNumarasi" placeholder="1234567890">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" id="createOrgSubmitBtn" onclick="createNewOrganization(event)">
                    <i class="fas fa-save me-2"></i>Kurum Oluştur
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Toplu Kullanıcı Yükleme Modal -->
<div class="modal fade" id="bulkYükleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Toplu Kullanıcı Yükleme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Adım Göstergesi -->
                <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <div class="text-center flex-fill">
                                    <div class="badge bg-info rounded-circle mb-2" style="width: 40px; height: 40px; line-height: 40px; font-size: 1.2rem;">1</div>
                                    <div><small>Şablon İndir</small></div>
                                </div>
                                <div class="text-center flex-fill">
                                    <div class="badge bg-secondary rounded-circle mb-2" style="width: 40px; height: 40px; line-height: 40px; font-size: 1.2rem;">2</div>
                                    <div><small>Şablonu Doldur</small></div>
                                </div>
                                <div class="text-center flex-fill">
                                    <div class="badge bg-success rounded-circle mb-2" style="width: 40px; height: 40px; line-height: 40px; font-size: 1.2rem;">3</div>
                                    <div><small>Dosyayı Yükle</small></div>
                                </div>
                            </div>
                </div>
                <!-- Bilgilendirme -->
                <div class="alert alert-info">
                    <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Toplu Kullanıcı Ekleme Hakkında</h6>
                    <ul class="mb-0 small">
                        <li>İlk olarak Excel Şablonunu İndirin</li>
                        <li>Şablonu doldurun (zorunlu alanlar * ile işaretlidir)</li>
                        <li>Tüm kullanıcılar <strong>{{ current_user.kurum.kisa_ad }}</strong> kurumuna <strong>"Kurum Kullanıcısı"</strong> rolü ile eklenecektir</li>
                        <li><strong>Yönetici rolleri:</strong> Sistem yöneticisi, kurum yetkilisi gibi roller sadece Admin Panel üzerinden atanabilir</li>
                        <li>Mevcut kullanıcı adları ve e-postalar atlanacaktır</li>
                    </ul>
                </div>
                <!-- Dosya Seçimi -->
                <div class="card">
                    <div class="card-body">
                        <label class="form-label fw-bold">
                            <i class="fas fa-file-excel me-2 text-success"></i>Excel Dosyası Seçin
                        </label>
                        <input type="file" class="form-control" id="bulkYükleFile" accept=".xlsx,.xls">
                        <small class="text-muted">Sadece .xlsx ve .xls dosyaları kabul edilir</small>
                        <!-- Yükleme Durumu -->
                        <div id="uploadProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-spinner fa-spin me-2"></i>Dosya yükleniyor...
                            </small>
                        </div>
                        <!-- Sonuç Mesajı -->
                        <div id="uploadResult" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
                <!-- Yardım -->
                <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="downloadUserTemplate()">
                        <i class="fas fa-download me-2"></i>Excel Şablonunu İndir
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-success" onclick="uploadBulkUsers()">
                    <i class="fas fa-upload me-2"></i>Kullanıcıları Yükle
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Yeni Kullanıcı Modal -->
<div class="modal fade" id="newUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Yeni Kullanıcı Ekle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Kullanıcı Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newUserUsername" required placeholder="ahmet.yilmaz">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newUserFirstAd" required placeholder="Ahmet">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Soyadı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newUserLastAd" required placeholder="Yılmaz">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">E-posta <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="newUserEmail" required placeholder="ahmet@abc.com">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Şifre <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="newUserPassword" required placeholder="Güçlü bir şifre">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sistem Rolü <span class="text-danger">*</span></label>
                                <select class="form-control" id="newUserRole" required onchange="showRoleAçıklama(this.value)">
                                    <option value="">Sistem rolü seçiniz...</option>
                                </select>
                                <div id="roleAçıklama" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="roleDescText"></span>
                                    </small>
                                </div>
                                {% if current_user.sistem_rol != 'admin' %}
                                <div class="mt-2">
                                    <small class="text-warning">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>Güvenlik:</strong> Sadece Sistem Admin rolü atayabilir veya kendinizle aynı seviyedeki rolleri seçebilirsiniz.
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Süreç Rolü (Opsiyonel)</label>
                                <select class="form-control" id="newUserProcessRole">
                                    <option value="">Süreç rolü seçiniz...</option>
                                </select>
                                <small class="text-muted d-block mt-1">
                                    Süreç rolü, kullanıcıyı varsayılan olarak süreç lideri/üyesi yapar. Boş bırakırsanız süreç bazlı atamalarla yönetebilirsiniz.
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kurum <span class="text-danger">*</span></label>
                                <select class="form-control" id="newUserKurum" required {% if current_user.sistem_rol in ['kurum_yoneticisi', 'ust_yonetim'] %}disabled{% endif %}>
                                    <option value="">Seçiniz...</option>
                                    {% for kurum in kurumlar %}
                                    <option value="{{ kurum.id }}" {% if current_user.sistem_rol in ['kurum_yoneticisi', 'ust_yonetim'] and kurum.id == current_user.kurum_id %}selected{% endif %}>{{ kurum.kisa_ad }}</option>
                                    {% endfor %}
                                </select>
                                {% if current_user.sistem_rol in ['kurum_yoneticisi', 'ust_yonetim'] %}
                                <small class="text-muted">Sadece kendi kurumunuza kullanıcı ekleyebilirsiniz.</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Profil Fotoğrafı Seçimi -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-user-circle me-2"></i>Profil Fotoğrafı
                            </h6>
                            <div class="card">
                                <div class="card-body">
                                    <!-- Fotoğraf Seçim Seçenekleri -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-upload me-1"></i>Fotoğraf Yükle
                                                </label>
                                                <input type="file" class="form-control" id="profilePhotoFile" accept=".png,.jpg,.jpeg,.gif,.webp" onchange="handleProfilPhotoYükle(this)">
                                                <small class="text-muted">PNG, JPG, JPEG, GIF, WEBP formatları desteklenir. Maksimum 16MB.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-link me-1"></i>Fotoğraf URL'si
                                                </label>
                                                <input type="url" class="form-control" id="newUserProfilUrl" placeholder="https://example.com/photo.jpg" onchange="handleProfilPhotoUrl(this)">
                                                <small class="text-muted">Veya internetten fotoğraf URL'si girin.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hazır Avatar Seçimi -->
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="form-label">
                                                <i class="fas fa-palette me-1"></i>Hazır Avatar Seç
                                            </label>
                                            <!-- Avatar Tema Tabları -->
                                            <ul class="nav nav-pills nav-fill mb-3" id="avatarThemeTabs" role="tablist" style="font-size: 0.85rem;">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active small" id="nature-tab" data-bs-toggle="pill" data-bs-target="#nature-avatars" type="button" role="tab">
                                                        <i class="fas fa-leaf me-1"></i>Doğa
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="animals-tab" data-bs-toggle="pill" data-bs-target="#animals-avatars" type="button" role="tab">
                                                        <i class="fas fa-paw me-1"></i>Hayvan
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="space-tab" data-bs-toggle="pill" data-bs-target="#space-avatars" type="button" role="tab">
                                                        <i class="fas fa-rocket me-1"></i>Uzay
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="sports-tab" data-bs-toggle="pill" data-bs-target="#sports-avatars" type="button" role="tab">
                                                        <i class="fas fa-futbol me-1"></i>Spor
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="music-tab" data-bs-toggle="pill" data-bs-target="#music-avatars" type="button" role="tab">
                                                        <i class="fas fa-music me-1"></i>Müzik
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="food-tab" data-bs-toggle="pill" data-bs-target="#food-avatars" type="button" role="tab">
                                                        <i class="fas fa-utensils me-1"></i>Yemek
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="travel-tab" data-bs-toggle="pill" data-bs-target="#travel-avatars" type="button" role="tab">
                                                        <i class="fas fa-plane me-1"></i>Seyahat
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link small" id="business-tab" data-bs-toggle="pill" data-bs-target="#business-avatars" type="button" role="tab">
                                                        <i class="fas fa-briefcase me-1"></i>İş
                                                    </button>
                                                </li>
                                            </ul>
                                            <!-- Avatar Tema İçeriği -->
                                            <div class="tab-content" id="avatarThemeContent">
                                                <!-- Doğa Teması -->
                                                <div class="tab-pane fade show active" id="nature-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #74b9ff, #0984e3); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'ocean', 'linear-gradient(135deg, #74b9ff, #0984e3)', 'fas fa-water')"
                                                             title="Okyanus">
                                                            <i class="fas fa-water"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fdcb6e, #f39c12); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'sun', 'linear-gradient(135deg, #fdcb6e, #f39c12)', 'fas fa-sun')"
                                                             title="Güneþ">
                                                            <i class="fas fa-sun"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00b894, #00a085); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'leaf', 'linear-gradient(135deg, #00b894, #00a085)', 'fas fa-leaf')"
                                                             title="Yaprak">
                                                            <i class="fas fa-leaf"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00cec9, #55efc4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'tree', 'linear-gradient(135deg, #00cec9, #55efc4)', 'fas fa-tree')"
                                                             title="AÝaç">
                                                            <i class="fas fa-tree"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #81ecec, #00b894); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'snowflake', 'linear-gradient(135deg, #81ecec, #00b894)', 'fas fa-snowflake')"
                                                             title="Kar Tanesi">
                                                            <i class="fas fa-snowflake"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #e17055, #d63031); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'fire', 'linear-gradient(135deg, #e17055, #d63031)', 'fas fa-fire')"
                                                             title="Ateþ">
                                                            <i class="fas fa-fire"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Hayvanlar Teması -->
                                                <div class="tab-pane fade" id="animals-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #a29bfe, #6c5ce7); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'cat', 'linear-gradient(135deg, #a29bfe, #6c5ce7)', 'fas fa-cat')"
                                                             title="Kedi">
                                                            <i class="fas fa-cat"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #ffeaa7, #fdcb6e); display: flex; align-items: center; justify-content: center; color: #2d3436; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'dog', 'linear-gradient(135deg, #ffeaa7, #fdcb6e)', 'fas fa-dog')"
                                                             title="Köpek">
                                                            <i class="fas fa-dog"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd79a8, #fdcb6e); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'butterfly', 'linear-gradient(135deg, #fd79a8, #fdcb6e)', 'fas fa-butterfly')"
                                                             title="Kelebek">
                                                            <i class="fas fa-butterfly"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #74b9ff, #0984e3); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'fish', 'linear-gradient(135deg, #74b9ff, #0984e3)', 'fas fa-fish')"
                                                             title="Balık">
                                                            <i class="fas fa-fish"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #ff7675, #d63031); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'dove', 'linear-gradient(135deg, #ff7675, #d63031)', 'fas fa-dove')"
                                                             title="Güvercin">
                                                            <i class="fas fa-dove"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00b894, #55efc4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'frog', 'linear-gradient(135deg, #00b894, #55efc4)', 'fas fa-frog')"
                                                             title="KurbaÝa">
                                                            <i class="fas fa-frog"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Uzay Teması -->
                                                <div class="tab-pane fade" id="space-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd79a8, #e84393); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'star', 'linear-gradient(135deg, #fd79a8, #e84393)', 'fas fa-star')"
                                                             title="Yıldız">
                                                            <i class="fas fa-star"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #2d3436, #636e72); display: flex; align-items: center; justify-content: center; color: #fdcb6e; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'moon', 'linear-gradient(135deg, #2d3436, #636e72)', 'fas fa-moon')"
                                                             title="Ay">
                                                            <i class="fas fa-moon"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00cec9, #55a3ff); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'rocket', 'linear-gradient(135deg, #00cec9, #55a3ff)', 'fas fa-rocket')"
                                                             title="Roket">
                                                            <i class="fas fa-rocket"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #a29bfe, #74b9ff); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'satellite', 'linear-gradient(135deg, #a29bfe, #74b9ff)', 'fas fa-satellite')"
                                                             title="Uydu">
                                                            <i class="fas fa-satellite"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd79a8, #6c5ce7); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'planet', 'linear-gradient(135deg, #fd79a8, #6c5ce7)', 'fas fa-globe')"
                                                             title="Gezegen">
                                                            <i class="fas fa-globe"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fab1a0, #e17055); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'meteor', 'linear-gradient(135deg, #fab1a0, #e17055)', 'fas fa-meteor')"
                                                             title="Meteor">
                                                            <i class="fas fa-meteor"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Spor Teması -->
                                                <div class="tab-pane fade" id="sports-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00b894, #00a085); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'football', 'linear-gradient(135deg, #00b894, #00a085)', 'fas fa-futbol')"
                                                             title="Futbol">
                                                            <i class="fas fa-futbol"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd7e14, #e84393); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'basketball', 'linear-gradient(135deg, #fd7e14, #e84393)', 'fas fa-basketball-ball')"
                                                             title="Basketbol">
                                                            <i class="fas fa-basketball-ball"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #74b9ff, #0984e3); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'swimming', 'linear-gradient(135deg, #74b9ff, #0984e3)', 'fas fa-swimmer')"
                                                             title="Yüzme">
                                                            <i class="fas fa-swimmer"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #a29bfe, #6c5ce7); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'cycling', 'linear-gradient(135deg, #a29bfe, #6c5ce7)', 'fas fa-biking')"
                                                             title="Bisiklet">
                                                            <i class="fas fa-biking"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fdcb6e, #f39c12); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'running', 'linear-gradient(135deg, #fdcb6e, #f39c12)', 'fas fa-running')"
                                                             title="Koþu">
                                                            <i class="fas fa-running"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #ff7675, #d63031); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'trophy', 'linear-gradient(135deg, #ff7675, #d63031)', 'fas fa-trophy')"
                                                             title="Kupa">
                                                            <i class="fas fa-trophy"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Müzik Teması -->
                                                <div class="tab-pane fade" id="music-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #e17055, #d63031); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'music', 'linear-gradient(135deg, #e17055, #d63031)', 'fas fa-music')"
                                                             title="Müzik Notası">
                                                            <i class="fas fa-music"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #6c5ce7, #a29bfe); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'guitar', 'linear-gradient(135deg, #6c5ce7, #a29bfe)', 'fas fa-guitar')"
                                                             title="Gitar">
                                                            <i class="fas fa-guitar"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd79a8, #e84393); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'headphones', 'linear-gradient(135deg, #fd79a8, #e84393)', 'fas fa-headphones')"
                                                             title="Kulaklık">
                                                            <i class="fas fa-headphones"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00b894, #55efc4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'microphone', 'linear-gradient(135deg, #00b894, #55efc4)', 'fas fa-microphone')"
                                                             title="Mikrofon">
                                                            <i class="fas fa-microphone"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fdcb6e, #f39c12); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'drum', 'linear-gradient(135deg, #fdcb6e, #f39c12)', 'fas fa-drum')"
                                                             title="Davul">
                                                            <i class="fas fa-drum"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #74b9ff, #0984e3); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'piano', 'linear-gradient(135deg, #74b9ff, #0984e3)', 'fas fa-piano')"
                                                             title="Piyano">
                                                            <i class="fas fa-piano"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Yemek Teması -->
                                                <div class="tab-pane fade" id="food-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd7e14, #e84393); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'pizza', 'linear-gradient(135deg, #fd7e14, #e84393)', 'fas fa-pizza-slice')"
                                                             title="Pizza">
                                                            <i class="fas fa-pizza-slice"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #ff7675, #d63031); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'hamburger', 'linear-gradient(135deg, #ff7675, #d63031)', 'fas fa-hamburger')"
                                                             title="Hamburger">
                                                            <i class="fas fa-hamburger"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00cec9, #55efc4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'ice-cream', 'linear-gradient(135deg, #00cec9, #55efc4)', 'fas fa-ice-cream')"
                                                             title="Dondurma">
                                                            <i class="fas fa-ice-cream"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #a29bfe, #6c5ce7); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'coffee', 'linear-gradient(135deg, #a29bfe, #6c5ce7)', 'fas fa-coffee')"
                                                             title="Kahve">
                                                            <i class="fas fa-coffee"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #ffeaa7, #fdcb6e); display: flex; align-items: center; justify-content: center; color: #2d3436; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'cake', 'linear-gradient(135deg, #ffeaa7, #fdcb6e)', 'fas fa-birthday-cake')"
                                                             title="Pasta">
                                                            <i class="fas fa-birthday-cake"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00b894, #00a085); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'apple', 'linear-gradient(135deg, #00b894, #00a085)', 'fas fa-apple-alt')"
                                                             title="Elma">
                                                            <i class="fas fa-apple-alt"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Seyahat Teması -->
                                                <div class="tab-pane fade" id="travel-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #74b9ff, #0984e3); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'plane', 'linear-gradient(135deg, #74b9ff, #0984e3)', 'fas fa-plane')"
                                                             title="Uçak">
                                                            <i class="fas fa-plane"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fd79a8, #e84393); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'suitcase', 'linear-gradient(135deg, #fd79a8, #e84393)', 'fas fa-suitcase-rolling')"
                                                             title="Valiz">
                                                            <i class="fas fa-suitcase-rolling"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00cec9, #55efc4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'ship', 'linear-gradient(135deg, #00cec9, #55efc4)', 'fas fa-ship')"
                                                             title="Gemi">
                                                            <i class="fas fa-ship"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fdcb6e, #f39c12); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'camera', 'linear-gradient(135deg, #fdcb6e, #f39c12)', 'fas fa-camera')"
                                                             title="Kamera">
                                                            <i class="fas fa-camera"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #e17055, #d63031); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'map', 'linear-gradient(135deg, #e17055, #d63031)', 'fas fa-map')"
                                                             title="Harita">
                                                            <i class="fas fa-map"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #a29bfe, #6c5ce7); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'compass', 'linear-gradient(135deg, #a29bfe, #6c5ce7)', 'fas fa-compass')"
                                                             title="Pusula">
                                                            <i class="fas fa-compass"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Ýþ Teması -->
                                                <div class="tab-pane fade" id="business-avatars" role="tabpanel">
                                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #2d3436, #636e72); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'briefcase', 'linear-gradient(135deg, #2d3436, #636e72)', 'fas fa-briefcase')"
                                                             title="Çanta">
                                                            <i class="fas fa-briefcase"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #ff7675, #fd79a8); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'crown', 'linear-gradient(135deg, #ff7675, #fd79a8)', 'fas fa-crown')"
                                                             title="Taç">
                                                            <i class="fas fa-crown"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #6c5ce7, #a29bfe); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'gem', 'linear-gradient(135deg, #6c5ce7, #a29bfe)', 'fas fa-gem')"
                                                             title="Mücevher">
                                                            <i class="fas fa-gem"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fab1a0, #e17055); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'heart', 'linear-gradient(135deg, #fab1a0, #e17055)', 'fas fa-heart')"
                                                             title="Kalp">
                                                            <i class="fas fa-heart"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #fdcb6e, #f39c12); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'lightbulb', 'linear-gradient(135deg, #fdcb6e, #f39c12)', 'fas fa-lightbulb')"
                                                             title="Ampul">
                                                            <i class="fas fa-lightbulb"></i>
                                                        </div>
                                                        <div class="avatar-option" 
                                                             style="width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
                                                                    background: linear-gradient(135deg, #00cec9, #55efc4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"
                                                             onclick="selectIconAvatar(this, 'cog', 'linear-gradient(135deg, #00cec9, #55efc4)', 'fas fa-cog')"
                                                             title="Ayar">
                                                            <i class="fas fa-cog"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="text-muted small mb-0">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Yukarıdaki kategorilerden birini seçin ve beğendiğiniz avatar'a tıklayın
                                            </p>
                                        </div>
                                    </div>
                                    <!-- Profil Fotoğrafı Önizleme -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div id="profilePhotoPreview" style="display: none;">
                                                <hr>
                                                <div class="text-center">
                                                    <p class="mb-2"><strong>Profil Fotoğrafı Önizleme:</strong></p>
                                                    <img id="profilePhotoPreviewImage" src="" alt="Profil Önizleme" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 3px solid #007bff;">
                                                    <br>
                                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearProfilPhoto()">
                                                        <i class="fas fa-trash me-1"></i>Fotoğrafı Kaldır
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" id="newUserSubmitButton" class="btn btn-success" onclick="createNewUser()">
                    <i class="fas fa-save me-2"></i>Kullanıcı Oluştur
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Yeni Süreç Modal -->
<div class="modal fade" id="newProcessModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Yeni Süreç Ekle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newProcessForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Süreç Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newProcessAd" required placeholder="Çrn: Yazılım Geliþtirme Süreci">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kurum <span class="text-danger">*</span></label>
                                <select class="form-control" id="newProcessKurum" required onchange="filterUsersByKurum(this.value, 'newProcessLider')" {% if current_user.sistem_rol in ['kurum_yoneticisi', 'ust_yonetim'] %}disabled data-init-filter="1"{% endif %}>
                                    <option value="">Kurum seçiniz...</option>
                                    {% for kurum in kurumlar %}
                                    <option value="{{ kurum.id }}" {% if current_user.sistem_rol in ['kurum_yoneticisi', 'ust_yonetim'] and kurum.id == current_user.kurum_id %}selected{% endif %}>{{ kurum.kisa_ad }}</option>
                                    {% endfor %}
                                </select>
                                {% if current_user.sistem_rol in ['kurum_yoneticisi', 'ust_yonetim'] %}
                                <small class="text-muted">Sadece kendi kurumunuza süreç ekleyebilirsiniz.</small>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Süreç Lideri <span class="text-danger">*</span></label>
                                <select class="form-control" id="newProcessLider" required>
                                    <option value="">Çnce kurum seçin...</option>
                                    {% for user in kullanicilar %}
                                    <option value="{{ user.id }}" data-kurum-id="{{ user.kurum_id }}">{{ user.username }} ({{ user.email }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Durum</label>
                                <select class="form-control" id="newProcessDurum">
                                    <option value="Aktif">Aktif</option>
                                    <option value="Pasif">Pasif</option>
                                    <option value="Beklemede">Beklemede</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Doküman No</label>
                                <input type="text" class="form-control" id="newProcessDokuman" placeholder="YG-001">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Revizyon No</label>
                                <input type="text" class="form-control" id="newProcessRevizyon" placeholder="1.0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Baþlangıç Tarihi</label>
                                <input type="date" class="form-control" id="newProcessBaslangic">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bitiþ Tarihi</label>
                                <input type="date" class="form-control" id="newProcessBitis">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Ýlerleme (%)</label>
                                <input type="range" class="form-range" id="newProcessIlerleme" min="0" max="100" value="0" oninput="document.getElementById('newProcessIlerlemeValue').textContent = this.value + '%'">
                                <div class="text-center">
                                    <span class="badge bg-primary" id="newProcessIlerlemeValue">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Açıklama</label>
                                <textarea class="form-control" id="newProcessAciklama" rows="3" placeholder="Süreç hakkında detaylı bilgi..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-success" id="newProcessSubmitBtn" onclick="createNewProcess(event)">
                    <i class="fas fa-save me-2"></i>Süreç Oluþtur
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Süreç Düzenle Modal -->
<div class="modal fade" id="editProcessModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Süreç Düzenle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProcessForm">
                    <input type="hidden" id="editProcessId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Süreç Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editProcessAd" required>
                            </div>
                            <!-- Süreç Liderleri Seçimi (Çoklu) -->
                            <div class="card bg-warning bg-opacity-10 mb-3">
                                <div class="card-header bg-warning">
                                    <strong><i class="fas fa-star"></i> Süreç Liderleri (Birden Fazla Seçebilirsiniz)</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label class="form-label">Kullanıcılar (Çoklu Seçim - Ctrl/Cmd tuþu ile)</label>
                                            <select class="form-select" id="edit_lider_source" multiple size="6" style="min-height: 150px;" ondblclick="addDüzenleLiderler()">
                                                {% for user in kullanicilar %}
                                                <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted">Birden fazla seçim için Ctrl (Windows) veya Cmd (Mac) tuþunu basılı tutun. Çift tıklama ile de ekleyebilirsiniz.</small>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                                            <div class="text-center">
                                                <button type="button" class="btn btn-primary btn-sm mb-2 w-100" onclick="addDüzenleLiderler()">
                                                    <i class="fas fa-arrow-right"></i> Ekle
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeDüzenleLiderler()">
                                                    <i class="fas fa-arrow-left"></i> Çıkar
                                                </button>
                                                <small class="text-muted d-block mt-2">veya çift tıklayın</small>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label">Süreç Liderleri</label>
                                            <select class="form-select" id="edit_lider_ids" multiple size="6" style="min-height: 150px;" ondblclick="removeDüzenleLiderler()">
                                            </select>
                                            <small class="text-muted">Seçilen liderler burada görünür. Çift tıklama ile çıkarabilirsiniz.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Durum</label>
                                <select class="form-control" id="editProcessDurum">
                                    <option value="Aktif">Aktif</option>
                                    <option value="Pasif">Pasif</option>
                                    <option value="Beklemede">Beklemede</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Doküman No</label>
                                <input type="text" class="form-control" id="editProcessDokuman">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Revizyon No</label>
                                <input type="text" class="form-control" id="editProcessRevizyon">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Baþlangıç Tarihi</label>
                                <input type="date" class="form-control" id="editProcessBaslangic">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Bitiþ Tarihi</label>
                                <input type="date" class="form-control" id="editProcessBitis">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Ýlerleme (%)</label>
                                <input type="range" class="form-range" id="editProcessIlerleme" min="0" max="100" value="0" oninput="document.getElementById('editProcessIlerlemeValue').textContent = this.value + '%'">
                                <div class="text-center">
                                    <span class="badge bg-primary" id="editProcessIlerlemeValue">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Açıklama</label>
                                <textarea class="form-control" id="editProcessAciklama" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-warning" id="editProcessSubmitBtn" onclick="updateProcess(event)">
                    <i class="fas fa-save me-2"></i>Güncelle
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Süreç Üyesi Yönetimi Modal -->
<div class="modal fade" id="processUsersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i><span id="processUsersModalBaþlık">Süreç Üyeleri</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manageProcessId">
                <!-- Üye Ekleme Formu -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-user-plus me-2"></i>Yeni Üye Ekle
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-9">
                                <select class="form-control" id="newMemberSelect">
                                    <option value="">Kullanıcı seçiniz...</option>
                                    {% for user in kullanicilar %}
                                    <option value="{{ user.id }}">{{ user.username }} - {{ user.email }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="addProcessMember()">
                                    <i class="fas fa-plus me-2"></i>Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Mevcut Üyeler Listesi -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>Mevcut Üyeler
                    </div>
                    <div class="card-body">
                        <div id="processUsersList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p class="mt-2">Yükleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Stratejik Planlama Modal'ları -->
<!-- Deðer Modal -->
<div class="modal fade" id="degerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-heart me-2"></i><span id="degerModalBaþlık">Yeni Deðer Ekle</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="degerDüzenleId">
                <div class="mb-3">
                    <label class="form-label">Kurum <span class="text-danger">*</span></label>
                    <select class="form-control" id="degerKurum" required>
                        {% for kurum in kurumlar %}
                        <option value="{{ kurum.id }}">{{ kurum.kisa_ad }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Baþlık <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="degerBaslik" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" id="degerAciklama" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-primary" onclick="saveDeger()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
<!-- Etik Kural Modal -->
<div class="modal fade" id="etikKuralModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-balance-scale me-2"></i><span id="etikKuralModalBaþlık">Yeni Etik Kural Ekle</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="etikKuralDüzenleId">
                <div class="mb-3">
                    <label class="form-label">Kurum <span class="text-danger">*</span></label>
                    <select class="form-control" id="etikKuralKurum" required>
                        {% for kurum in kurumlar %}
                        <option value="{{ kurum.id }}">{{ kurum.kisa_ad }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Baþlık <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="etikKuralBaslik" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" id="etikKuralAciklama" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-success" onclick="saveEtikKural()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
<!-- Kalite Politikası Modal -->
<div class="modal fade" id="kalitePolitikasiModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-award me-2"></i><span id="kalitePolitikasiModalBaþlık">Yeni Kalite Politikası Ekle</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="kalitePolitikasiDüzenleId">
                <div class="mb-3">
                    <label class="form-label">Kurum <span class="text-danger">*</span></label>
                    <select class="form-control" id="kalitePolitikasiKurum" required>
                        {% for kurum in kurumlar %}
                        <option value="{{ kurum.id }}">{{ kurum.kisa_ad }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Baþlık <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="kalitePolitikasiBaslik" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" id="kalitePolitikasiAciklama" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-warning" onclick="saveKalitePolitikasi()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
<!-- Ana Strateji Modal -->
<div class="modal fade" id="anaStratejiModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-bullseye me-2"></i><span id="anaStratejiModalBaþlık">Yeni Ana Strateji Ekle</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="anaStratejiDüzenleId">
                <div class="mb-3">
                    <label class="form-label">Kurum <span class="text-danger">*</span></label>
                    <select class="form-control" id="anaStratejiKurum" required>
                        {% for kurum in kurumlar %}
                        <option value="{{ kurum.id }}">{{ kurum.kisa_ad }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ad <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="anaStratejiAd" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" id="anaStratejiAciklama" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-info" onclick="saveAnaStrateji()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
<!-- Alt Strateji Modal -->
<div class="modal fade" id="altStratejiModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="fas fa-list me-2"></i><span id="altStratejiModalBaþlık">Yeni Alt Strateji Ekle</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="altStratejiDüzenleId">
                <input type="hidden" id="altStratejiAnaId">
                <div class="mb-3">
                    <label class="form-label">Ad <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="altStratejiAd" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Açıklama</label>
                    <textarea class="form-control" id="altStratejiAciklama" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ýptal</button>
                <button type="button" class="btn btn-secondary" onclick="saveAltStrateji()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
<!-- Kurum Görüntüleme Modal -->
<div class="modal fade" id="viewOrganizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-building me-2"></i>Kurum Detayları</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <img id="viewOrgLogo" src="" alt="Logo" class="img-fluid rounded" style="max-height: 150px; border: 2px solid #dee2e6;">
                    </div>
                    <div class="col-md-8">
                        <h4 id="viewOrgTicariUnvan" class="mb-3"></h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Kısa Ad</label>
                                <p id="viewOrgKisaAd" class="fw-bold"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Sektör</label>
                                <p id="viewOrgSektor"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Çalıþan Sayısı</label>
                                <p id="viewOrgCalisanSayisi"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Faaliyet Alanı</label>
                                <p id="viewOrgFaaliyetAlani"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="text-muted small">E-posta</label>
                        <p id="viewOrgEmail"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Telefon</label>
                        <p id="viewOrgTelefon"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Web Adresi</label>
                        <p id="viewOrgWeb"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Vergi Dairesi</label>
                        <p id="viewOrgVergiDairesi"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Vergi Numarası</label>
                        <p id="viewOrgVergiNumarasi"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-warning" onclick="editOrganizationFromGörüntüle()">
                    <i class="fas fa-edit me-2"></i>Düzenle
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Kurum Düzenleme Modal -->
<div class="modal fade" id="editOrganizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Kurum Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrgForm">
                    <input type="hidden" id="editOrgId">
                    <input type="hidden" id="editOrgOldKisaAd">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Kısa Ad <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editOrgKisaAd" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ticari Ünvan <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editOrgTicariUnvan" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Faaliyet Alanı</label>
                            <input type="text" class="form-control" id="editOrgFaaliyetAlani">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sektör</label>
                            <input type="text" class="form-control" id="editOrgSektor">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Çalıþan Sayısı</label>
                            <input type="number" class="form-control" id="editOrgCalisanSayisi">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="editOrgEmail">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefon</label>
                            <input type="tel" class="form-control" id="editOrgTelefon">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Web Adresi</label>
                            <input type="url" class="form-control" id="editOrgWeb">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vergi Dairesi</label>
                            <input type="text" class="form-control" id="editOrgVergiDairesi">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vergi Numarası</label>
                            <input type="text" class="form-control" id="editOrgVergiNumarasi">
                        </div>
                    </div>
                    <!-- Logo Düzenleme -->
                    <div class="row mb-4 mt-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-image me-2"></i>Kurum Logosu
                            </h6>
                            <div class="card">
                                <div class="card-body">
                                    <!-- Logo Seçim Seçenekleri -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-upload me-1"></i>Bilgisayardan Logo Yükle
                                                </label>
                                                <input type="file" class="form-control" id="editLogoFile" accept=".png,.jpg,.jpeg,.gif,.svg,.webp" onchange="handleDuzenleLogoYukle(this)">
                                                <small class="text-muted">PNG, JPG, JPEG, GIF, SVG, WEBP formatları desteklenir. Maksimum 16MB.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-link me-1"></i>Logo URL'si
                                                </label>
                                                <input type="url" class="form-control" id="editOrgLogoUrl" placeholder="https://example.com/logo.png" onchange="handleDuzenleLogoUrl(this)">
                                                <small class="text-muted">Veya internetten logo URL'si girin.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Logo Önizleme -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div id="editLogoPreview" style="display: none;">
                                                <hr>
                                                <div class="text-center">
                                                    <p class="mb-2"><strong>Logo Önizleme:</strong></p>
                                                    <img id="editLogoPreviewImage" src="" alt="Logo Önizleme" style="max-width: 200px; max-height: 120px; border: 1px solid #ddd; border-radius: 8px;">
                                                    <br>
                                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearDüzenleLogo()">
                                                        <i class="fas fa-trash me-1"></i>Logoyu Kaldır
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-warning" onclick="updateOrganization()">
                    <i class="fas fa-save me-2"></i>Güncelle
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Kullanıcı Görüntüleme Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user me-2"></i>Kullanıcı Detayları</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <img id="viewUserPhoto" src="" alt="Profil" class="img-fluid rounded-circle" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #007bff;">
                    </div>
                    <div class="col-md-9">
                        <h4 id="viewUserUsername" class="mb-2"></h4>
                        <p class="text-muted" id="viewUserEmail"></p>
                        <div class="mb-3">
                            <span id="viewUserRoleBadge" class="badge"></span>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="text-muted small">Kurum</label>
                                <p id="viewUserKurum" class="fw-bold"></p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Kullanıcı ID</label>
                                <p id="viewUserId" class="font-monospace"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <h6 class="fw-bold">Süreç Rolleri</h6>
                    <div id="viewUserProcesses"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-warning" onclick="editUserFromGörüntüle()">
                    <i class="fas fa-edit me-2"></i>Düzenle
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Kullanıcı Düzenleme Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Kullanıcı Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <input type="hidden" id="editUserOldUsername">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Kullanıcı Adı <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editUserUsername" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">E-posta <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editUserEmail" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Adı</label>
                            <input type="text" class="form-control" id="editUserFirstAd" placeholder="Ahmet">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Soyadı</label>
                            <input type="text" class="form-control" id="editUserLastAd" placeholder="Yılmaz">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Yeni Şifre</label>
                            <input type="password" class="form-control" id="editUserPassword" placeholder="Boş bırakın değişmez">
                            <small class="text-muted">Şifreyi değiştirmek istemiyorsanız boş bırakın</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sistem Rolü <span class="text-danger">*</span></label>
                            <select class="form-control" id="editUserRole" required onchange="showRoleAçıklamaDüzenle(this.value)">
                                <option value="">Sistem rolü seçiniz...</option>
                            </select>
                            <div id="editRoleAçıklama" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="editRoleDescText"></span>
                                </small>
                            </div>
                            {% if current_user.sistem_rol != 'admin' %}
                            <small class="text-warning d-block mt-1">
                                <i class="fas fa-shield-alt me-1"></i>Sadece yetkiniz dahilindeki roller görünür.
                            </small>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Süreç Rolü (Opsiyonel)</label>
                            <select class="form-control" id="editUserProcessRole">
                                <option value="">Süreç rolü seçiniz...</option>
                            </select>
                            <small class="text-muted d-block mt-1">
                                Kullanıcıyı varsayılan süreç lideri/üyesi yapmak için seçin. Boş bırakırsanız mevcut atamalar korunur.
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kurum <span class="text-danger">*</span></label>
                            <select class="form-control" id="editUserKurum" required>
                                {% for kurum in kurumlar %}
                                <option value="{{ kurum.id }}">{{ kurum.kisa_ad }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <!-- Profil Fotoğrafı Düzenleme -->
                    <div class="row mb-4 mt-4">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-user-circle me-2"></i>Profil Fotoğrafı
                            </h6>
                            <div class="card">
                                <div class="card-body">
                                    <!-- Fotoğraf Seçim Seçenekleri -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-upload me-1"></i>Fotoğraf Yükle
                                                </label>
                                                <input type="file" class="form-control" id="editProfilPhotoFile" accept=".png,.jpg,.jpeg,.gif,.webp" onchange="handleDuzenleProfilPhotoYukle(this)">
                                                <small class="text-muted">PNG, JPG, JPEG, GIF, WEBP formatları desteklenir. Maksimum 16MB.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-link me-1"></i>Fotoğraf URL'si
                                                </label>
                                                <input type="url" class="form-control" id="editUserProfilUrl" placeholder="https://example.com/photo.jpg" onchange="handleDuzenleProfilPhotoUrl(this)">
                                                <small class="text-muted">Veya internetten fotoğraf URL'si girin.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Fotoğraf Önizleme -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div id="editProfilPhotoPreview" style="display: none;">
                                                <hr>
                                                <div class="text-center">
                                                    <p class="mb-2"><strong>Profil Fotoğrafı Önizleme:</strong></p>
                                                    <img id="editProfilPhotoPreviewImage" src="" alt="Profil Önizleme" style="max-width: 120px; max-height: 120px; border: 2px solid #ddd; border-radius: 50%; object-fit: cover;">
                                                    <br>
                                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearDuzenleProfilPhoto()">
                                                        <i class="fas fa-trash me-1"></i>Fotoğrafı Kaldır
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-warning" onclick="updateUser()">
                    <i class="fas fa-save me-2"></i>Güncelle
                </button>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="container py-5 text-center">
    <div class="alert alert-danger shadow-sm border-0">
        <i class="fas fa-exclamation-triangle me-2"></i> Bu sayfaya eriþim yetkiniz yok.
    </div>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_panel.js') }}"></script>

{% endblock %}
