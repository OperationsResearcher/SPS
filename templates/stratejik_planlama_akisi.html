{% extends "base.html" %}

{% block title %}Stratejik Planlama Akışı - {{ kurum.kisa_ad }}{% endblock %}

{% block styles %}
<style>
    .flow-container {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .flow-box {
        border: 3px solid;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        position: relative;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .flow-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }
    
    .flow-box.blue {
        border-color: #3498db;
        background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
    }
    
    .flow-box.green {
        border-color: #27ae60;
        background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
    }
    
    .flow-box.purple {
        border-color: #9b59b6;
        background: linear-gradient(135deg, #ffffff 0%, #f3e5f5 100%);
    }
    
    .flow-box.orange {
        border-color: #e67e22;
        background: linear-gradient(135deg, #ffffff 0%, #fff3e0 100%);
    }
    
    .flow-box h4 {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.7;
    }
    
    .flow-box p {
        color: #95a5a6;
        margin: 0;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.6;
    }
    
    /* İçerik stilleri - DAHA BÜYÜK VE İNTERAKTİF */
    .flow-box .content-preview {
        margin-top: 15px;
        padding: 15px 20px;
        background: rgba(255,255,255,0.9);
        border-radius: 12px;
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        line-height: 1.6;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .flow-box .content-preview:hover {
        background: rgba(255,255,255,1);
        transform: scale(1.02);
        border-color: rgba(52,152,219,0.3);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .flow-box .content-large {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-top: 15px;
        padding: 20px;
        background: rgba(255,255,255,0.9);
        border-radius: 12px;
        line-height: 1.8;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
        text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .flow-box .content-large:hover {
        background: rgba(255,255,255,1);
        transform: scale(1.03);
        border-color: rgba(52,152,219,0.4);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .flow-box .item-list {
        margin-top: 15px;
        padding: 15px 20px;
        text-align: left;
        background: rgba(255,255,255,0.8);
        border-radius: 10px;
    }
    
    .flow-box .item-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .flow-box .item-list li {
        margin: 10px 0;
        padding: 12px 15px;
        background: white;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        transition: all 0.3s ease;
        cursor: pointer;
        border-left: 4px solid transparent;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .flow-box .item-list li:hover {
        transform: translateX(5px);
        border-left-color: #3498db;
        box-shadow: 0 4px 10px rgba(52,152,219,0.2);
        background: #f8f9fa;
    }
    
    .flow-box .item-list li.more-items {
        opacity: 0.6;
        font-size: 0.95rem;
        font-weight: 500;
        font-style: italic;
    }
    
    .flow-arrow {
        text-align: center;
        font-size: 2rem;
        color: #3498db;
        margin: 10px 0;
    }
    
    .flow-arrow-horizontal {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #3498db;
    }
    
    .badge-count {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    
    .swot-pestle-row {
        display: flex;
        gap: 20px;
        justify-content: center;
    }
    
    .side-box {
        width: 200px;
    }
    
    .info-icon {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #3498db;
        font-size: 1.2rem;
    }
    
    .empty-state {
        color: #95a5a6;
        font-style: italic;
        font-size: 0.9rem;
    }
    
    /* Pulse animasyonu interaktif içerikler için */
    @keyframes contentPulse {
        0%, 100% {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        50% {
            box-shadow: 0 5px 15px rgba(52,152,219,0.15);
        }
    }
    
    .flow-box .content-large:hover,
    .flow-box .content-preview:hover {
        animation: contentPulse 1.5s ease-in-out;
    }
    
    /* İçerik tıklanabilir göstergesi */
    .flow-box .content-large::before,
    .flow-box .content-preview::before {
        content: '';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.3s ease;
        font-size: 1.2rem;
    }
    
    .flow-box .content-large:hover::before,
    .flow-box .content-preview:hover::before {
        opacity: 0.7;
    }
    
    .strategy-tree {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .strategy-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px 30px;
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(155,89,182,0.3);
    }
    
    .strategy-row {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .ana-strateji-box {
        min-width: 250px;
        max-width: 300px;
        padding: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #f3e5f5 100%);
        border: 3px solid #9b59b6;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .ana-strateji-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(155,89,182,0.3);
    }
    
    .ana-strateji-box h5 {
        color: #8e44ad;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .ana-strateji-box p {
        color: #666;
        font-size: 0.85rem;
        margin: 0;
    }
    
    .alt-strateji-container {
        margin-top: 10px;
        padding: 10px;
        background: rgba(255,255,255,0.5);
        border-radius: 10px;
    }
    
    .alt-strateji-item {
        background: white;
        border-left: 4px solid #e67e22;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 0.85rem;
    }
    
    .alt-strateji-item strong {
        color: #e67e22;
    }
    
    .process-tree {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .process-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px 30px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(52,152,219,0.3);
    }
    
    .process-row {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .surec-box {
        min-width: 280px;
        max-width: 320px;
        padding: 20px;
        background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
        border: 3px solid #3498db;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .surec-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(52,152,219,0.3);
    }
    
    .surec-box h5 {
        color: #2980b9;
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    .surec-box .surec-info {
        color: #666;
        font-size: 0.8rem;
        margin-bottom: 10px;
    }
    
    .pg-container {
        margin-top: 10px;
        padding: 10px;
        background: rgba(255,255,255,0.5);
        border-radius: 10px;
    }
    
    .pg-item {
        background: white;
        border-left: 4px solid #27ae60;
        padding: 8px 10px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 0.8rem;
    }
    
    .pg-item .pg-name {
        color: #27ae60;
        font-weight: bold;
    }
    
    .pg-item .pg-details {
        color: #666;
        font-size: 0.75rem;
        margin-top: 3px;
    }
    
    .pg-item .pg-badge {
        display: inline-block;
        background: #27ae60;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        margin-right: 5px;
    }
    
    /* Kurum Logosu Stili */
    .kurum-logo-container {
        position: relative;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .kurum-logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        border-radius: 12px;
        border: 3px solid #e0e0e0;
        background: white;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .kurum-logo:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 18px rgba(52,152,219,0.3);
        border-color: #3498db;
    }
    
    .kurum-logo-placeholder {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        font-weight: bold;
        border: 3px solid #2980b9;
        box-shadow: 0 4px 12px rgba(52,152,219,0.3);
        transition: all 0.3s ease;
    }
    
    .kurum-logo-placeholder:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 18px rgba(52,152,219,0.4);
    }
    
    .kurum-bilgi-mini {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .kurum-bilgi-mini .kurum-unvan {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
        line-height: 1.3;
    }
    
    .kurum-bilgi-mini .kurum-kisa-ad {
        font-size: 0.75rem;
        color: #95a5a6;
        margin: 0;
    }
    
    /* SWOT Analizi Stilleri */
    .swot-analysis-container {
        padding: 30px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        margin: 20px 0;
    }
    
    .swot-main-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .swot-box {
        border: 3px solid;
        border-radius: 20px;
        padding: 25px;
        background: white;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .swot-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, transparent, currentColor, transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .swot-box:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    
    .swot-box:hover::before {
        opacity: 1;
    }
    
    .swot-box.strengths {
        border-color: #28a745;
        background: linear-gradient(135deg, #ffffff 0%, #f8fff9 50%, #e8f5e9 100%);
        color: #155724;
    }
    
    .swot-box.weaknesses {
        border-color: #ffc107;
        background: linear-gradient(135deg, #ffffff 0%, #fffdf5 50%, #fff3cd 100%);
        color: #856404;
    }
    
    .swot-box.opportunities {
        border-color: #17a2b8;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 50%, #d1ecf1 100%);
        color: #0c5460;
    }
    
    .swot-box.threats {
        border-color: #dc3545;
        background: linear-gradient(135deg, #ffffff 0%, #fff5f5 50%, #f8d7da 100%);
        color: #721c24;
    }
    
    .swot-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(0,0,0,0.1);
    }
    
    .swot-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .swot-box.strengths .swot-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .swot-box.weaknesses .swot-icon {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .swot-box.opportunities .swot-icon {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
    }
    
    .swot-box.threats .swot-icon {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
    }
    
    .swot-box:hover .swot-icon {
        transform: rotate(360deg) scale(1.1);
    }
    
    .swot-title h5 {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .swot-title small {
        font-size: 0.9rem;
        opacity: 0.8;
        font-style: italic;
    }
    
    .swot-header i {
        font-size: 1.5rem;
        margin-right: 10px;
    }
    
    .swot-header h5 {
        margin: 0;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .swot-content {
        min-height: 200px;
    }
    
    .swot-item {
        margin-bottom: 15px;
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        border: 2px solid rgba(0,0,0,0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
    
    .swot-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, transparent, currentColor, transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .swot-item:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border-color: rgba(0,0,0,0.2);
    }
    
    .swot-item:hover::before {
        opacity: 1;
    }
    
    .swot-item-content {
        display: flex;
        align-items: center;
        padding: 20px;
        gap: 15px;
    }
    
    .swot-item-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .swot-item[data-category="strengths"] .swot-item-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .swot-item[data-category="weaknesses"] .swot-item-icon {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .swot-item[data-category="opportunities"] .swot-item-icon {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
    }
    
    .swot-item[data-category="threats"] .swot-item-icon {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
    }
    
    .swot-item:hover .swot-item-icon {
        transform: rotate(360deg) scale(1.1);
    }
    
    .swot-item-text {
        flex: 1;
    }
    
    .swot-item-text p {
        margin: 0;
        font-size: 1rem;
        font-weight: 500;
        color: #2c3e50;
        line-height: 1.5;
    }
    
    .swot-item-actions {
        display: flex;
        gap: 8px;
    }
    
    .swot-item-actions .btn {
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .swot-item-actions .btn:hover {
        transform: scale(1.1);
    }
    
    .swot-item[data-category="strengths"] {
        border-left-color: #28a745;
    }
    
    .swot-item[data-category="weaknesses"] {
        border-left-color: #ffc107;
    }
    
    .swot-item[data-category="opportunities"] {
        border-left-color: #17a2b8;
    }
    
    .swot-item[data-category="threats"] {
        border-left-color: #dc3545;
    }
    
    .swot-text {
        flex: 1;
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.95rem;
    }
    
    .swot-actions {
        display: flex;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .swot-item:hover .swot-actions {
        opacity: 1;
    }
    
    .swot-actions .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    
    /* Ekosistem Stilleri */
    .ecosystem-container {
        padding: 30px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        margin: 20px 0;
    }
    
    .ecosystem-main-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .ecosystem-map-container {
        position: relative;
        width: 100vw;
        height: 1000px;
        margin: 40px calc(-50vw + 50%);
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .ecosystem-map {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .ecosystem-global-ring {
        position: absolute;
        width: 2000px;
        height: 800px;
        border: 18px solid #2E8B57; /* Koyu yeşil */
        border-radius: 50%;
        background: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%);
        color: #2c3e50;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 25px 60px rgba(46,139,87,0.4);
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1; /* En dış halka */
        padding-top: 60px;
    }
    
    .global-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: #ffffff;
        text-align: center;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        letter-spacing: 0.5px;
    }
    
    .global-items {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    .global-item {
        position: absolute;
        background: rgba(255,255,255,0.95);
        border-radius: 15px;
        padding: 15px 20px;
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease, background-color 0.2s ease;
        white-space: nowrap;
        border: 2px solid #2E8B57;
        cursor: move;
        user-select: none;
        width: 170px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .global-item:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        background: rgba(255,255,255,1);
        border-color: #2c3e50;
        color: #2c3e50;
        font-weight: 700;
    }
    
    .global-item.dragging {
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border-color: #ff6b6b;
        background: rgba(255,255,255,1);
    }
    
    .ecosystem-market-ring {
        position: absolute;
        width: 1600px;
        height: 640px;
        border: 15px solid #20B2AA;
        border-radius: 50%;
        background: linear-gradient(135deg, #20B2AA 0%, #48CAE4 100%);
        color: #2c3e50;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 20px 50px rgba(32,178,170,0.4);
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        padding-top: 50px;
    }
    
    .ecosystem-market-ring:hover {
        transform: translate(-50%, -50%) scale(1.02);
        box-shadow: 0 25px 60px rgba(32,178,170,0.5);
    }
    
    .market-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2c3e50;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        margin-top: 0;
    }
    
    .market-items {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        padding: 80px;
    }
    
    .market-item, .stakeholder-item {
        position: absolute;
        background: rgba(255,255,255,0.9);
        border-radius: 12px;
        padding: 12px 18px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease, background-color 0.2s ease;
        white-space: nowrap;
        border: 2px solid #20B2AA;
        cursor: move;
        user-select: none;
        width: 150px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .stakeholder-item {
        border: 2px solid #87CEEB;
        font-size: 0.9rem;
        padding: 10px 15px;
    }
    
    .market-item:hover, .stakeholder-item:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        background: rgba(255,255,255,1);
        border-color: #2c3e50;
        color: #2c3e50;
        font-weight: 700;
    }
    
    .market-item.dragging, .stakeholder-item.dragging {
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border-color: #ff6b6b;
        background: rgba(255,255,255,1);
    }
    
    .ecosystem-stakeholders-ring {
        position: absolute;
        width: 1000px;
        height: 400px;
        border: 12px solid #87CEEB;
        border-radius: 50%;
        background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
        color: #2c3e50;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 15px 40px rgba(135,206,235,0.4);
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3;
        padding-top: 40px;
    }
    
    .ecosystem-stakeholders-ring:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 15px 40px rgba(135,206,235,0.4);
    }
    
    .stakeholders-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        margin-top: 0;
    }
    
    .stakeholders-items {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        padding: 60px;
    }
    
    .stakeholder-item {
        position: absolute;
        background: rgba(255,255,255,0.9);
        border-radius: 10px;
        padding: 10px 15px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        white-space: nowrap;
        border: 2px solid #87CEEB;
    }
    
    .stakeholder-item:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        background: rgba(255,255,255,1);
        border-color: #2c3e50;
        color: #2c3e50;
        font-weight: 700;
    }
    
    /* Paydaş öİelerinin konumları - Halka içinde eşit daİılım */
    .stakeholders-items .stakeholder-item:nth-child(1) {
        top: 20%;
        left: 20%;
        transform: translate(-50%, -50%);
    }
    
    .stakeholders-items .stakeholder-item:nth-child(2) {
        top: 20%;
        right: 20%;
        transform: translate(50%, -50%);
    }
    
    .stakeholders-items .stakeholder-item:nth-child(3) {
        top: 50%;
        right: 10%;
        transform: translate(50%, -50%);
    }
    
    .stakeholders-items .stakeholder-item:nth-child(4) {
        bottom: 30%;
        right: 20%;
        transform: translate(50%, 50%);
    }
    
    .stakeholders-items .stakeholder-item:nth-child(5) {
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 50%);
    }
    
    .stakeholders-items .stakeholder-item:nth-child(6) {
        bottom: 30%;
        left: 20%;
        transform: translate(-50%, 50%);
    }
    
    /* Pazar halkasındaki öİelerin konumları - Halkanın içinde */
    .market-items .market-item:nth-child(1) { /* Aracılar */
        position: absolute;
        top: 20%;
        right: 15%;
        transform: translate(50%, -50%);
    }
    
    .market-items .market-item:nth-child(2) { /* Potansiyel Müşteriler */
        position: absolute;
        top: 20%;
        left: 15%;
        transform: translate(-50%, -50%);
    }
    
    .market-items .market-item:nth-child(3) { /* Özel İlgi Grupları */
        position: absolute;
        top: 50%;
        right: 10%;
        transform: translate(50%, -50%);
    }
    
    .market-items .market-item:nth-child(4) { /* Yeni Girişimler */
        position: absolute;
        top: 45%;
        left: 10%;
        transform: translate(-50%, -50%);
    }
    
    .market-items .market-item:nth-child(5) { /* Basın ve Sosyal Medya */
        position: absolute;
        top: 60%;
        left: 15%;
        transform: translate(-50%, -50%);
    }
    
    .market-items .market-item:nth-child(6) { /* Rakipler */
        position: absolute;
        bottom: 20%;
        left: 40%;
        transform: translate(-50%, 50%);
    }
    
    .market-items .market-item:nth-child(7) { /* Yenilikler */
        position: absolute;
        bottom: 20%;
        left: 60%;
        transform: translate(-50%, 50%);
    }
    
    .market-items .market-item:nth-child(8) { /* Mevzuat */
        position: absolute;
        bottom: 30%;
        left: 20%;
        transform: translate(-50%, 50%);
    }
    
    .market-items .market-item:nth-child(9) { /* İstihdam */
        position: absolute;
        bottom: 25%;
        right: 20%;
        transform: translate(50%, 50%);
    }
    
    /* Küresel Çevre Halkasındaki öİelerin konumları */
    .global-items .global-item:nth-child(1) { /* Küresel Isınma */
        position: absolute;
        top: 25%;
        left: 20%;
        transform: translate(-50%, -50%);
    }
    
    .global-items .global-item:nth-child(2) { /* Paylaşım Ekonomisi */
        position: absolute;
        top: 45%;
        left: 15%;
        transform: translate(-50%, -50%);
    }
    
    .global-items .global-item:nth-child(3) { /* Demografik Çeşitlilik */
        position: absolute;
        bottom: 35%;
        left: 20%;
        transform: translate(-50%, 50%);
    }
    
    .global-items .global-item:nth-child(4) { /* Yıkıcı Teknolojiler */
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 50%);
    }
    
    .global-items .global-item:nth-child(5) { /* Jeopolitik Belirsizlik */
        position: absolute;
        bottom: 35%;
        right: 20%;
        transform: translate(50%, 50%);
    }
    
    .global-items .global-item:nth-child(6) { /* BM Sürdürülebilir Kalkınma Amaçları */
        position: absolute;
        top: 45%;
        right: 15%;
        transform: translate(50%, -50%);
    }
    
    .global-items .global-item:nth-child(7) { /* Toplumsal Eİilimler */
        position: absolute;
        top: 25%;
        right: 20%;
        transform: translate(50%, -50%);
    }
    
    .global-items .global-item:nth-child(8) { /* Ham Maddeler */
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .ecosystem-center {
        width: 300px;
        height: 120px;
        border: 4px solid #228B22;
        border-radius: 50%;
        background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(34,139,34,0.3);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 4;
    }
    
    .ecosystem-center:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 15px 40px rgba(34,139,34,0.4);
    }
    
    .center-content {
        margin-top: 5px;
    }
    
    .organization-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
        text-align: center;
        background: rgba(255,255,255,0.2);
        padding: 8px 12px;
        border-radius: 15px;
        margin-top: 5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .center-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 5px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        text-align: center;
    }
    
    .center-items {
        font-size: 0.9rem;
        text-align: center;
        max-width: 250px;
    }
    
    /* Baİlantı Kutuları */
    .ecosystem-connections {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    .connection-box {
        position: absolute;
        background: rgba(255,255,255,0.95);
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        pointer-events: all;
        transition: all 0.3s ease;
        width: 180px;
        height: 80px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .connection-box:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .connection-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        text-align: center;
    }
    
    .connection-subtitle {
        font-size: 0.7rem;
        color: #6c757d;
        text-align: center;
        margin-bottom: 8px;
    }
    
    /* Baİlantı kutularının konumları - Eşit aralıklarla */
    .leadership {
        bottom: 20px;
        left: 8.33%;
        transform: translateX(-50%);
        border-color: #17a2b8;
        background: rgba(23,162,184,0.1);
    }
    
    .strategy {
        bottom: 20px;
        left: 25%;
        transform: translateX(-50%);
        border-color: #e83e8c;
        background: rgba(232,62,140,0.1);
    }
    
    .management {
        bottom: 20px;
        left: 41.67%;
        transform: translateX(-50%);
        border-color: #6f42c1;
        background: rgba(111,66,193,0.1);
    }
    
    .culture {
        bottom: 20px;
        left: 58.33%;
        transform: translateX(-50%);
        border-color: #20c997;
        background: rgba(32,201,151,0.1);
    }
    
    .performance {
        bottom: 20px;
        left: 75%;
        transform: translateX(-50%);
        border-color: #ffc107;
        background: rgba(255,193,7,0.1);
    }
    
    .purpose {
        bottom: 20px;
        left: 91.67%;
        transform: translateX(-50%);
        border-color: #fd7e14;
        background: rgba(253,126,20,0.1);
    }
    
    
    /* PESTLE Analizi Stilleri */
    .pestle-analysis-container {
        padding: 30px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        margin: 20px 0;
    }
    
    .pestle-main-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .pestle-box {
        border: 3px solid;
        border-radius: 20px;
        padding: 25px;
        background: white;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .pestle-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, transparent, currentColor, transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .pestle-box:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    
    .pestle-box:hover::before {
        opacity: 1;
    }
    
    .pestle-box.political {
        border-color: #007bff;
        background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 50%, #e3f2fd 100%);
        color: #004085;
    }
    
    .pestle-box.economic {
        border-color: #28a745;
        background: linear-gradient(135deg, #ffffff 0%, #f8fff9 50%, #e8f5e9 100%);
        color: #155724;
    }
    
    .pestle-box.social {
        border-color: #17a2b8;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 50%, #d1ecf1 100%);
        color: #0c5460;
    }
    
    .pestle-box.technological {
        border-color: #ffc107;
        background: linear-gradient(135deg, #ffffff 0%, #fffdf5 50%, #fff3cd 100%);
        color: #856404;
    }
    
    .pestle-box.legal {
        border-color: #dc3545;
        background: linear-gradient(135deg, #ffffff 0%, #fff5f5 50%, #f8d7da 100%);
        color: #721c24;
    }
    
    .pestle-box.environmental {
        border-color: #20c997;
        background: linear-gradient(135deg, #ffffff 0%, #f0fff9 50%, #d4edda 100%);
        color: #0f5132;
    }
    
    .pestle-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(0,0,0,0.1);
    }
    
    .pestle-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .pestle-box.political .pestle-icon {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .pestle-box.economic .pestle-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .pestle-box.social .pestle-icon {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
    }
    
    .pestle-box.technological .pestle-icon {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .pestle-box.legal .pestle-icon {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
    }
    
    .pestle-box.environmental .pestle-icon {
        background: linear-gradient(135deg, #20c997, #28a745);
    }
    
    .pestle-box:hover .pestle-icon {
        transform: rotate(360deg) scale(1.1);
    }
    
    .pestle-title h5 {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .pestle-title small {
        font-size: 0.9rem;
        opacity: 0.8;
        font-style: italic;
    }
    
    .pestle-header h5 {
        margin: 0;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .pestle-content {
        min-height: 200px;
    }
    
    .pestle-item {
        margin-bottom: 15px;
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        border: 2px solid rgba(0,0,0,0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
    
    .pestle-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, transparent, currentColor, transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .pestle-item:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border-color: rgba(0,0,0,0.2);
    }
    
    .pestle-item:hover::before {
        opacity: 1;
    }
    
    .pestle-item-content {
        display: flex;
        align-items: center;
        padding: 20px;
        gap: 15px;
    }
    
    .pestle-item-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .pestle-item[data-category="political"] .pestle-item-icon {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .pestle-item[data-category="economic"] .pestle-item-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .pestle-item[data-category="social"] .pestle-item-icon {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
    }
    
    .pestle-item[data-category="technological"] .pestle-item-icon {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .pestle-item[data-category="legal"] .pestle-item-icon {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
    }
    
    .pestle-item[data-category="environmental"] .pestle-item-icon {
        background: linear-gradient(135deg, #20c997, #28a745);
    }
    
    .pestle-item:hover .pestle-item-icon {
        transform: rotate(360deg) scale(1.1);
    }
    
    .pestle-item-text {
        flex: 1;
    }
    
    .pestle-item-text p {
        margin: 0;
        font-size: 1rem;
        font-weight: 500;
        color: #2c3e50;
        line-height: 1.5;
    }
    
    .pestle-item-actions {
        display: flex;
        gap: 8px;
    }
    
    .pestle-item-actions .btn {
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .pestle-item-actions .btn:hover {
        transform: scale(1.1);
    }
    
    .pestle-item[data-category="political"] {
        border-left-color: #007bff;
    }
    
    .pestle-item[data-category="economic"] {
        border-left-color: #28a745;
    }
    
    .pestle-item[data-category="social"] {
        border-left-color: #17a2b8;
    }
    
    .pestle-item[data-category="technological"] {
        border-left-color: #ffc107;
    }
    
    .pestle-item[data-category="legal"] {
        border-left-color: #dc3545;
    }
    
    .pestle-item[data-category="environmental"] {
        border-left-color: #20c997;
    }
    
    .pestle-text {
        flex: 1;
        font-weight: 500;
        color: #2c3e50;
        font-size: 0.95rem;
    }
    
    .pestle-actions {
        display: flex;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .pestle-item:hover .pestle-actions {
        opacity: 1;
    }
    
    .pestle-actions .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    /* PESTLE Matrisi Stilleri */
    .pestle-matrix {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    
    .pestle-matrix-table {
        margin-bottom: 0;
    }
    
    .pestle-matrix-table th,
    .pestle-matrix-table td {
        vertical-align: middle;
        padding: 15px;
        text-align: center;
    }
    
    .pestle-matrix-table th {
        font-weight: bold;
        font-size: 0.9rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .pestle-matrix-table td {
        font-size: 0.9rem;
    }
    
    .pestle-matrix-table .category-name {
        font-weight: bold;
        text-align: left;
        color: #2c3e50;
    }
    
    .pestle-matrix-table .impact-count {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .pestle-matrix-table .impact-low {
        color: #28a745;
    }
    
    .pestle-matrix-table .impact-medium {
        color: #ffc107;
    }
    
    .pestle-matrix-table .impact-high {
        color: #dc3545;
    }
    
    .pestle-matrix-table .impact-total {
        color: #007bff;
        font-weight: bold;
    }
    
    /* PESTLE öİeleri için yeni stiller */
    .pestle-description {
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    .pestle-metrics {
        margin-top: 8px;
    }
    
    .pestle-metrics .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    
    /* PESTLE matrisi için güncellenmiş stiller */
    .pestle-matrix-table .category-name {
        font-weight: 600;
        min-width: 200px;
    }
    
    .pestle-matrix-table .badge {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    .pestle-matrix-table tr.table-dark {
        background-color: #343a40 !important;
    }
    
    .pestle-matrix-table tr.table-dark td {
        border-color: #495057;
    }
    
    /* Responsive tasarım - PESTLE */
    @media (max-width: 768px) {
        .pestle-analysis-container {
            padding: 10px;
        }
        
        .pestle-box {
            margin-bottom: 20px;
        }
        
        .pestle-matrix-table {
            font-size: 0.8rem;
        }
        
        .pestle-matrix-table th,
        .pestle-matrix-table td {
            padding: 10px 8px;
        }
    }
    
    /* Düzenle Modal Styles */
    .edit-modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9998;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }
    
    .edit-modal-backdrop.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .edit-modal {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 600px;
        overflow: hidden;
        animation: slideUp 0.3s ease;
        transform-origin: center;
        position: relative;
        z-index: 9999;
    }
    
    .edit-modal-header {
        padding: 20px 25px;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .edit-modal-header.success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }
    
    .edit-modal-header.info {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }
    
    .edit-modal-header.warning {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }
    
    .edit-modal-header.danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    .edit-modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.5rem;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
    }
    
    .edit-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }
    
    .edit-modal-body {
        padding: 30px 25px;
    }
    
    .edit-modal-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 0.95rem;
        display: block;
    }
    
    .edit-modal-textarea {
        width: 100%;
        min-height: 120px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        resize: vertical;
        transition: all 0.3s ease;
        font-family: inherit;
    }
    
    .edit-modal-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    .edit-modal-footer {
        padding: 20px 25px;
        background: #f8f9fa;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .edit-modal-btn {
        padding: 10px 25px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .edit-modal-btn-cancel {
        background: #e0e0e0;
        color: #666;
    }
    
    .edit-modal-btn-cancel:hover {
        background: #d0d0d0;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .edit-modal-btn-save {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .edit-modal-btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="flow-container">
    <!-- Başlık -->
    <div class="text-center mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Sol: Kurum Logosu -->
            <div class="kurum-logo-container">
                {% if kurum.logo_url %}
                    {% set logo_url = kurum.logo_url %}
                    {% if not logo_url.startswith('http://') and not logo_url.startswith('https://') %}
                        {% if logo_url.startswith('/static/') %}
                            {% set logo_url = url_for('static', filename=logo_url[8:]) %}
                        {% else %}
                            {% set logo_url = url_for('static', filename=logo_url.lstrip('/static/').lstrip('/')) %}
                        {% endif %}
                    {% endif %}
                    <img src="{{ logo_url }}" 
                         alt="{{ kurum.kisa_ad }} Logo" 
                         class="kurum-logo"
                         title="{{ kurum.ticari_unvan }}"
                         onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="kurum-logo-placeholder" style="display: none;" title="{{ kurum.ticari_unvan }}">
                        {{ kurum.kisa_ad[0] if kurum.kisa_ad else 'K' }}
                    </div>
                {% else %}
                    <div class="kurum-logo-placeholder" title="{{ kurum.ticari_unvan }}">
                        {{ kurum.kisa_ad[0] if kurum.kisa_ad else 'K' }}
                    </div>
                {% endif %}
                <div class="kurum-bilgi-mini d-none d-md-block">
                    <p class="kurum-unvan">{{ kurum.kisa_ad }}</p>
                    <p class="kurum-kisa-ad">{{ kurum.ticari_unvan[:40] }}...</p>
                </div>
            </div>
            
            <!-- Orta: Başlık -->
            <h2 class="mb-0">
                <i class="fas fa-project-diagram me-2"></i>
                Stratejik Planlama Akışı
            </h2>
            
            <!-- Saİ: Yenile Butonu -->
            <div>
                <a class="btn btn-sm btn-primary me-2" href="{{ url_for('main.stratejik_planlama_akisi_dinamik') }}" title="Dinamik (canlı) stratejik planlama akışı">
                    <i class="fas fa-bolt me-1"></i> Dinamik Stratejik Planlama
                </a>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshPageData()" id="refreshBtn" title="Sayfayı yenile">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i> Yenile
                </button>
            </div>
        </div>
        <small class="text-muted" id="lastGüncelleSaat">
            <i class="fas fa-clock me-1"></i>Son güncelleme: Şimdi
        </small>
        <div class="mt-2">
            <div class="form-check form-switch d-inline-block">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                <label class="form-check-label small text-muted" for="autoRefreshToggle">
                    Otomatik yenileme (30 saniyede bir)
                </label>
            </div>
        </div>
    </div>

    <!-- Üst Satır: Değerler, Amaç, Kalite Politikası -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="flow-box blue" onclick="openModal('degerler')">
                <i class="info-icon fas fa-heart"></i>
                {% if degerler|length > 0 %}
                <span class="badge-count">{{ degerler|length }}</span>
                {% endif %}
                <h4>Değerler ve Etik Kurallar</h4>
                <p>Values and Ethics</p>
                {% if degerler|length > 0 or etik_kurallari|length > 0 %}
                <div class="item-list">
                    <ul>
                        {% for deger in degerler[:3] %}
                        <li title="{{ deger.aciklama }}">{{ deger.baslik }}</li>
                        {% endfor %}
                        {% if degerler|length > 3 %}
                        <li class="more-items">+{{ degerler|length - 3 }} daha...</li>
                        {% endif %}
                    </ul>
                </div>
                {% else %}
                <div class="content-large" style="font-size: 1.1rem; opacity: 0.5;" title="Henüz eklenmedi">Henüz eklenmedi</div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="flow-box purple" onclick="openModal('amac')">
                <i class="info-icon fas fa-bullseye"></i>
                <h4>AMAÇ</h4>
                <p>Purpose</p>
                {% if amac %}
                <div class="content-large" title="{{ amac }}">{{ amac[:150] }}{% if amac|length > 150 %}...{% endif %}</div>
                {% else %}
                <div class="content-large" style="font-size: 1.1rem; opacity: 0.5;" title="Henüz tanımlanmadı">Henüz tanımlanmadı</div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="flow-box blue" onclick="openModal('kalite')">
                <i class="info-icon fas fa-certificate"></i>
                {% if kalite_politikalari|length > 0 %}
                <span class="badge-count">{{ kalite_politikalari|length }}</span>
                {% endif %}
                <h4>Kalite Politikası</h4>
                <p>Quality Policy</p>
                {% if kalite_politikalari|length > 0 %}
                <div class="item-list">
                    <ul>
                        {% for politika in kalite_politikalari[:2] %}
                        <li title="{{ politika.aciklama }}">{{ politika.baslik }}</li>
                        {% endfor %}
                        {% if kalite_politikalari|length > 2 %}
                        <li class="more-items">+{{ kalite_politikalari|length - 2 }} daha...</li>
                        {% endif %}
                    </ul>
                </div>
                {% else %}
                <div class="content-large" style="font-size: 1.1rem; opacity: 0.5;" title="Henüz eklenmedi">Henüz eklenmedi</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- Ekosistem -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="flow-box green" onclick="openModal('ekosistem')">
                <i class="info-icon fas fa-leaf"></i>
                <h4>EKOSİSTEM</h4>
                <p>Ecosystem</p>
                <div class="content-large" style="font-size: 1.2rem; opacity: 0.6; font-style: italic;" title="Hazırlık Aşamasında">
                    Hazırlık Aşamasında
                </div>
            </div>
        </div>
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- Vizyon -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="flow-box blue" onclick="openModal('vizyon')">
                <i class="info-icon fas fa-eye"></i>
                <h4>VİZYON</h4>
                <p>Vision</p>
                {% if vizyon %}
                <div class="content-large" title="{{ vizyon }}">{{ vizyon[:200] }}{% if vizyon|length > 200 %}...{% endif %}</div>
                {% else %}
                <div class="content-large" style="font-size: 1.1rem; opacity: 0.5;" title="Henüz tanımlanmadı">Henüz tanımlanmadı</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- SWOT ve PESTLE -->
    <div class="swot-pestle-row mb-4">
        <div class="side-box">
            <div class="flow-box green" onclick="openModal('swot')">
                <i class="info-icon fas fa-chart-bar"></i>
                {% if swot_analizleri|length > 0 %}
                <span class="badge-count">{{ swot_analizleri|length }}</span>
                {% endif %}
                <h4>SWOT</h4>
                {% if swot_analizleri|length > 0 %}
                <div class="content-large" style="color: #27ae60; font-weight: 600;" title="Analiz Tamamlandı">
                    <i class="fas fa-check-circle me-2"></i>
                    Analiz Tamamlandı
                </div>
                {% else %}
                <div class="content-large" style="font-size: 1rem; opacity: 0.6; font-style: italic;" title="Analiz yapılmadı">
                    Analiz yapılmadı
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="side-box">
            <div class="flow-box green" onclick="openModal('pestle')">
                <i class="info-icon fas fa-globe"></i>
                {% if pestle_analizleri|length > 0 %}
                <span class="badge-count">{{ pestle_analizleri|length }}</span>
                {% endif %}
                <h4>PESTLE</h4>
                {% if pestle_analizleri|length > 0 %}
                <div class="content-large" style="color: #27ae60; font-weight: 600;" title="Analiz Tamamlandı">
                    <i class="fas fa-check-circle me-2"></i>
                    Analiz Tamamlandı
                </div>
                {% else %}
                <div class="content-large" style="font-size: 1rem; opacity: 0.6; font-style: italic;" title="Analiz yapılmadı">
                    Analiz yapılmadı
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- Ana Stratejiler ve Alt Stratejiler - Aİaç Yapısı -->
    <div class="strategy-tree mb-4">
        <div class="strategy-header">
            <h3 class="mb-0">
                <i class="fas fa-sitemap me-2"></i>
                Ana Stratejilerimiz
            </h3>
            <p class="mb-0 mt-2">Main Strategies</p>
        </div>

        <div class="flow-arrow">
            <i class="fas fa-arrow-down"></i>
        </div>

        {% if ana_stratejiler|length > 0 %}
        <div class="strategy-row">
            {% for ana_str in ana_stratejiler %}
            <div class="ana-strateji-box" onclick="openModal('anaStratejiler')">
                <h5>
                    <i class="fas fa-chess-queen me-2"></i>
                    {{ ana_str.ad }}
                    {% if main_scores_norm and (ana_str.id in main_scores_norm) %}
                    <span class="badge bg-dark ms-2" title="Normalize skor">{{ main_scores_norm[ana_str.id] }}%</span>
                    {% endif %}
                </h5>
                {% if ana_str.aciklama %}
                <p class="mb-2">{{ ana_str.aciklama[:60] }}{% if ana_str.aciklama|length > 60 %}...{% endif %}</p>
                {% endif %}
                
                {% if ana_str.alt_stratejiler|length > 0 %}
                <div class="alt-strateji-container">
                    <small class="text-muted d-block mb-2">
                        <i class="fas fa-arrow-down me-1"></i>
                        Alt Stratejiler ({{ ana_str.alt_stratejiler|length }})
                    </small>
                    {% for alt_str in ana_str.alt_stratejiler %}
                    <div class="alt-strateji-item">
                        <strong>{{ loop.index }}.</strong> {{ alt_str.ad }}
                        {% if sub_scores_norm and (alt_str.id in sub_scores_norm) %}
                        <span class="badge bg-secondary ms-2" title="Normalize skor">{{ sub_scores_norm[alt_str.id] }}%</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Alt strateji eklenmedi
                </small>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-sitemap fa-3x mb-3" style="opacity: 0.3;"></i>
            <p>Henüz ana strateji eklenmedi</p>
        </div>
        {% endif %}
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- Süreç Hedefleri ve Performans Göstergeleri - Aİaç Yapısı -->
    <div class="process-tree mb-4">
        <div class="process-header">
            <h3 class="mb-0">
                <i class="fas fa-cogs me-2"></i>
                Süreç Hedefleri
            </h3>
            <p class="mb-0 mt-2">Process Targets</p>
        </div>

        <div class="flow-arrow">
            <i class="fas fa-arrow-down"></i>
        </div>

        {% if surecler|length > 0 %}
        <div class="process-row">
            {% for surec in surecler %}
            <div class="surec-box" onclick="window.location.href='{{ url_for('main.surec_paneli') }}'">
                <h5>
                    <i class="fas fa-project-diagram me-2"></i>
                    {{ surec.ad }}
                </h5>
                
                <div class="surec-info">
                    <span class="badge bg-primary">{{ surec.durum or 'Aktif' }}</span>
                    {% if process_scores_norm and (surec.id in process_scores_norm) %}
                    <span class="badge bg-dark" title="Süreç stratejik skor (normalize)">{{ process_scores_norm[surec.id] }}%</span>
                    {% endif %}
                    {% if surec.ilerleme %}
                    <span class="badge bg-success">{{ surec.ilerleme }}% İlerleme</span>
                    {% endif %}
                </div>
                
                {% if surec.performans_gostergeleri|length > 0 %}
                <div class="pg-container">
                    <small class="text-muted d-block mb-2">
                        <i class="fas fa-chart-line me-1"></i>
                        Performans Göstergeleri ({{ surec.performans_gostergeleri|length }})
                    </small>
                    {% for pg in surec.performans_gostergeleri[:3] %}
                    <div class="pg-item">
                        <div class="pg-name">{{ pg.ad }}</div>
                        <div class="pg-details">
                            {% if kpi_scores_norm and (pg.id in kpi_scores_norm) %}
                            <span class="pg-badge" title="PG ağırlıklı başarı puanı (normalize)">Skor: {{ kpi_scores_norm[pg.id] }}%</span>
                            {% endif %}
                            {% if pg.hedef_deger %}
                            <span class="pg-badge">Hedef: {{ pg.hedef_deger }} {{ pg.olcum_birimi or '' }}</span>
                            {% endif %}
                            {% if pg.periyot %}
                            <span class="text-muted">{{ pg.periyot }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% if surec.performans_gostergeleri|length > 3 %}
                    <small class="text-muted d-block mt-2 text-center">
                        +{{ surec.performans_gostergeleri|length - 3 }} performans göstergesi daha...
                    </small>
                    {% endif %}
                </div>
                {% else %}
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Performans göstergesi eklenmedi
                </small>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-cogs fa-3x mb-3" style="opacity: 0.3;"></i>
            <p>Henüz süreç eklenmedi</p>
        </div>
        {% endif %}
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- Süreç İyileştirme Faaliyetleri -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="flow-box green" onclick="window.location.href='{{ url_for('main.surec_paneli') }}'">
                <i class="info-icon fas fa-tasks"></i>
                <h4>Süreç İyileştirme Faaliyetleri</h4>
                <p>Process Improvement Activities</p>
                <div class="content-large" style="color: #27ae60;">
                    <i class="fas fa-arrow-right me-2"></i>
                    Detaylı görüntüle ve yönet
                </div>
            </div>
        </div>
    </div>

    <!-- Ok -->
    <div class="flow-arrow">
        <i class="fas fa-arrow-down"></i>
    </div>

    <!-- Bireysel Hedefler -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="flow-box purple" onclick="window.location.href='{{ url_for('main.performans_kartim') }}'">
                <i class="info-icon fas fa-user-check"></i>
                <h4>Bireysel Hedefler</h4>
                <p>Individual Targets</p>
                <div class="content-large" style="color: #9b59b6;">
                    <i class="fas fa-arrow-right me-2"></i>
                    Bireysel panele git
                </div>
            </div>
        </div>
    </div>

    <!-- Geri Dönüş Okları -->
    <div class="text-center mt-4 mb-5">
        <p class="text-muted">
            <i class="fas fa-sync-alt me-2"></i>
            Sürekli iyileştirme döngüsü - Tüm seviyelerden geri bildirim
        </p>
    </div>
</div>

<!-- Genel Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalBaşlık"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- İçerik dinamik yüklenecek -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
<script>
// Modal HTML'i dinamik olarak ekle
document.addEventListener('DOMContentLoaded', function() {
    const editModalHTML = `
        <div class="edit-modal-backdrop" id="editModalBackdrop">
            <div class="edit-modal">
                <div class="edit-modal-header" id="editModalHeader">
                    <div>
                        <i class="fas fa-edit me-2"></i>
                        <span id="editModalBaşlık">Düzenle</span>
                    </div>
                    <button class="edit-modal-close" id="editModalCloseBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="edit-modal-body">
                    <label class="edit-modal-label" id="editModalLabel">İçerik:</label>
                    <textarea class="edit-modal-textarea" id="editModalTextarea" placeholder="İçeriği buraya girin..."></textarea>
                </div>
                <div class="edit-modal-footer">
                    <button class="edit-modal-btn edit-modal-btn-cancel" id="editModalİptalBtn">
                        <i class="fas fa-times me-2"></i>İptal
                    </button>
                    <button class="edit-modal-btn edit-modal-btn-save" id="editModalKaydetBtn">
                        <i class="fas fa-check me-2"></i>Kaydet
                    </button>
                </div>
            </div>
        </div>
        
        <div class="edit-modal-backdrop" id="deleteModalBackdrop">
            <div class="edit-modal" style="max-width: 450px;">
                <div class="edit-modal-header danger" id="deleteModalHeader">
                    <div>
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="deleteModalBaşlık">Silme Onayı</span>
                    </div>
                    <button class="edit-modal-close" id="deleteModalCloseBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="edit-modal-body">
                    <p id="deleteModalMessage" style="font-size: 1rem; color: #2c3e50; margin: 0;"></p>
                </div>
                <div class="edit-modal-footer">
                    <button class="edit-modal-btn edit-modal-btn-cancel" id="deleteModalİptalBtn">
                        <i class="fas fa-times me-2"></i>İptal
                    </button>
                    <button class="edit-modal-btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;" id="deleteModalConfirmBtn">
                        <i class="fas fa-trash me-2"></i>Sil
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', editModalHTML);
    
    // Event listeners ekle
    document.getElementById('editModalCloseBtn').addEventListener('click', hideDüzenleModal);
    document.getElementById('editModalİptalBtn').addEventListener('click', hideDüzenleModal);
    document.getElementById('editModalKaydetBtn').addEventListener('click', saveDüzenleModal);
    document.getElementById('deleteModalCloseBtn').addEventListener('click', hideSilConfirm);
    document.getElementById('deleteModalİptalBtn').addEventListener('click', hideSilConfirm);
    document.getElementById('deleteModalConfirmBtn').addEventListener('click', confirmSil);
    
    // ESC tuşu ile kapatma
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const editBackdrop = document.getElementById('editModalBackdrop');
            const deleteBackdrop = document.getElementById('deleteModalBackdrop');
            if (editBackdrop && editBackdrop.classList.contains('active')) {
                hideDüzenleModal();
            }
            if (deleteBackdrop && deleteBackdrop.classList.contains('active')) {
                hideSilConfirm();
            }
        }
    });
    
    // Backdrop'a tıklayınca kapatma
    document.getElementById('editModalBackdrop').addEventListener('click', function(e) {
        if (e.target === this) {
            hideDüzenleModal();
        }
    });
    document.getElementById('deleteModalBackdrop').addEventListener('click', function(e) {
        if (e.target === this) {
            hideSilConfirm();
        }
    });
});

<script>
let currentSection = '';
let editModalData = {
    type: '',
    category: '',
    itemId: null,
    currentText: ''
};

/**
 * Düzenle modal'ı göster
 */
function showDüzenleModal(type, category, itemId, currentText) {
    console.log('showDüzenleModal çağrıldı:', type, category, itemId, currentText);
    editModalData = { type, category, itemId, currentText };
    
    const backdrop = document.getElementById('editModalBackdrop');
    const header = document.getElementById('editModalHeader');
    const title = document.getElementById('editModalBaşlık');
    const label = document.getElementById('editModalLabel');
    const textarea = document.getElementById('editModalTextarea');
    
    console.log('Modal elementleri:', {backdrop, header, title, label, textarea});
    
    // Kategori adını al
    let categoryAd = '';
    let headerClass = 'info';
    
    if (type === 'swot') {
        categoryAd = getKategoriAd(category);
        const colorMap = {
            'strengths': 'success',
            'weaknesses': 'warning',
            'opportunities': 'info',
            'threats': 'danger'
        };
        headerClass = colorMap[category] || 'info';
    } else if (type === 'pestle') {
        categoryAd = getPestleKategoriAd(category);
        headerClass = 'info';
    }
    
    console.log('Modal kategori:', categoryAd, 'header class:', headerClass);
    
    // Modal içeriğini ayarla
    title.innerHTML = `<i class="fas fa-edit me-2"></i>${categoryAd} Düzenle`;
    label.textContent = `${categoryAd}:`;
    textarea.value = currentText;
    
    // Header rengini ayarla
    header.className = 'edit-modal-header ' + headerClass;
    
    console.log('Modal açılıyor...');
    
    // Modal'ı göster
    backdrop.classList.add('active');
    
    console.log('Modal backdrop active class eklendi');
    
    // Textarea'ya odaklan
    setTimeout(() => {
        textarea.focus();
        textarea.select();
        console.log('Textarea focus ve select yapıldı');
    }, 100);
}

/**
 * Düzenle modal'ı gizle
 */
function hideDüzenleModal() {
    const backdrop = document.getElementById('editModalBackdrop');
    const textarea = document.getElementById('editModalTextarea');
    
    backdrop.classList.remove('active');
    textarea.value = '';
    editModalData = { type: '', category: '', itemId: null, currentText: '' };
}

/**
 * Ekle modal'ı göster (yeni öğe eklemek için)
 */
function showEkleModal(type, category) {
    editModalData = { type, category, itemId: null, currentText: '', isNew: true };
    
    const backdrop = document.getElementById('editModalBackdrop');
    const header = document.getElementById('editModalHeader');
    const title = document.getElementById('editModalBaşlık');
    const label = document.getElementById('editModalLabel');
    const textarea = document.getElementById('editModalTextarea');
    
    // Kategori adını al
    let categoryAd = '';
    let headerClass = 'success';
    
    if (type === 'swot') {
        categoryAd = getKategoriAd(category);
        const colorMap = {
            'strengths': 'success',
            'weaknesses': 'warning',
            'opportunities': 'info',
            'threats': 'danger'
        };
        headerClass = colorMap[category] || 'success';
    } else if (type === 'pestle') {
        categoryAd = getPestleKategoriAd(category);
        headerClass = 'info';
    }
    
    // Modal içeriğini ayarla
    title.innerHTML = `<i class="fas fa-plus-circle me-2"></i>Yeni ${categoryAd} Ekle`;
    label.textContent = `${categoryAd}:`;
    textarea.value = '';
    textarea.placeholder = `Yeni ${categoryAd.toLowerCase()} girin...`;
    
    // Header rengini ayarla
    header.className = 'edit-modal-header ' + headerClass;
    
    // Modal'ı göster
    backdrop.classList.add('active');
    
    // Textarea'ya odaklan
    setTimeout(() => {
        textarea.focus();
    }, 100);
}

/**
 * Düzenle modal kaydet
 */
function saveDüzenleModal() {
    console.log('===== saveDüzenleModal BAŞLADI =====');
    console.log('editModalData:', editModalData);
    
    const textarea = document.getElementById('editModalTextarea');
    console.log('Textarea element:', textarea);
    console.log('Textarea value:', textarea ? textarea.value : 'TEXTAREA YOK!');
    
    if (!textarea) {
        console.error('TEXTAREA ELEMANI BULUNAMADI!');
        showToast('error', 'Form hatası');
        return;
    }
    
    const newText = textarea.value.trim();
    
    console.log('Yeni text:', newText);
    console.log('Text length:', newText.length);
    
    if (!newText) {
        showToast('warning', 'İçerik boş olamaz');
        return;
    }
    
    if (newText === editModalData.currentText && !editModalData.isNew) {
        console.log('Text değişmemiş, modal kapatılıyor');
        hideDüzenleModal();
        return;
    }
    
    const { type, category, itemId, isNew } = editModalData;
    
    console.log('Kayıt işlemi:', {type, category, itemId, isNew});
    
    if (type === 'swot') {
        if (isNew) {
            console.log('Yeni SWOT öğesi ekleniyor...');
            // Yeni öğe ekle
            const container = document.getElementById(`${category}-content`);
            console.log('Container:', container);
            if (container) {
                const newId = Tarih.now();
                const newItem = createSwotItem(newId, newText, category);
                container.appendChild(newItem);
                
                // Animasyon ekle
                newItem.style.opacity = '0';
                newItem.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    newItem.style.transition = 'all 0.3s ease';
                    newItem.style.opacity = '1';
                    newItem.style.transform = 'translateY(0)';
                }, 100);
                
                showToast('success', `${getKategoriAd(category)} eklendi`);
                
                // Backend'e kaydet
                console.log('Backend kayıt işlemi başlatılıyor...');
                saveSwotAnalysis();
            }
        } else {
            console.log('Mevcut SWOT öğesi güncelleniyor...');
            console.log('Aranacak selector:', `div.swot-item[data-category="${category}"][data-id="${itemId}"]`);
            
            // Tüm SWOT item'ları listele
            const allItems = document.querySelectorAll('.swot-item');
            console.log('Toplam SWOT item sayısı:', allItems.length);
            allItems.forEach(el => {
                console.log('Item:', {
                    category: el.getAttribute('data-category'),
                    id: el.getAttribute('data-id'),
                    text: el.querySelector('.swot-item-text p')?.textContent
                });
            });
            
            // Mevcut öğeyi güncelle
            const item = document.querySelector(`div.swot-item[data-category="${category}"][data-id="${itemId}"]`);
            console.log('Güncellenecek item:', item);
            
            if (item) {
                const textElement = item.querySelector('.swot-item-text p');
                console.log('Text element:', textElement);
                
                if (textElement) {
                    textElement.textContent = newText;
                    console.log('Text güncellendi:', newText);
                    showToast('success', `${getKategoriAd(category)} güncellendi`);
                    
                    // Backend'e kaydet
                    console.log('Backend kayıt işlemi başlatılıyor...');
                    saveSwotAnalysis();
                } else {
                    console.error('Text element bulunamadı!');
                    showToast('error', 'Güncelleme hatası');
                }
            } else {
                console.error('Güncellenecek item bulunamadı!');
                console.error('Aranan:', {category, itemId, type: typeof itemId});
                showToast('error', 'Öğe bulunamadı');
            }
        }
    } else if (type === 'pestle') {
        if (isNew) {
            // Yeni öğe ekle
            const container = document.getElementById(`${category}-content`);
            if (container) {
                const newId = Tarih.now();
                const newItem = createPestleItem(newId, newText, category);
                container.appendChild(newItem);
                
                // Animasyon ekle
                newItem.style.opacity = '0';
                newItem.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    newItem.style.transition = 'all 0.3s ease';
                    newItem.style.opacity = '1';
                    newItem.style.transform = 'translateY(0)';
                }, 100);
                
                showToast('success', `${getPestleKategoriAd(category)} eklendi`);
                
                // Backend'e kaydet
                savePestleAnalysis();
            }
        } else {
            console.log('Mevcut PESTLE öğesi güncelleniyor...');
            console.log('Aranacak selector:', `div.pestle-item[data-category="${category}"][data-id="${itemId}"]`);
            
            // Mevcut öğeyi güncelle
            const item = document.querySelector(`div.pestle-item[data-category="${category}"][data-id="${itemId}"]`);
            console.log('Güncellenecek PESTLE item:', item);
            
            if (item) {
                const textElement = item.querySelector('.pestle-item-text p');
                console.log('PESTLE text element:', textElement);
                
                if (textElement) {
                    textElement.textContent = newText;
                    console.log('PESTLE text güncellendi:', newText);
                    showToast('success', `${getPestleKategoriAd(category)} faktörü güncellendi`);
                    
                    // Matrisi güncelle
                    updatePestleMatrixFromCurrentData();
                    
                    // Backend'e kaydet
                    savePestleAnalysis();
                } else {
                    console.error('PESTLE text element bulunamadı!');
                    showToast('error', 'Güncelleme hatası');
                }
            } else {
                console.error('Güncellenecek PESTLE item bulunamadı!', category, itemId);
                showToast('error', 'PESTLE öğesi bulunamadı');
            }
        }
    }
    
    hideDüzenleModal();
}

// ESC tuşu ile modal'ı kapat
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const backdrop = document.getElementById('editModalBackdrop');
        if (backdrop && backdrop.classList.contains('active')) {
            hideDüzenleModal();
        }
    }
});

// Backdrop tıklaması ile modal'ı kapat
document.addEventListener('click', function(e) {
    const editBackdrop = document.getElementById('editModalBackdrop');
    if (e.target === editBackdrop) {
        hideDüzenleModal();
    }
    
    const deleteBackdrop = document.getElementById('deleteModalBackdrop');
    if (e.target === deleteBackdrop) {
        hideSilConfirm();
    }
});

// Sil confirmation için global değişkenler
let deleteConfirmData = {
    type: '',
    category: '',
    itemId: null
};

/**
 * Silme onay modal'ını göster
 */
function showSilConfirm(type, category, itemId) {
    deleteConfirmData = { type, category, itemId };
    
    const backdrop = document.getElementById('deleteModalBackdrop');
    const message = document.getElementById('deleteModalMessage');
    
    let categoryAd = '';
    if (type === 'swot') {
        categoryAd = getKategoriAd(category);
    } else if (type === 'pestle') {
        categoryAd = getPestleKategoriAd(category);
    }
    
    message.innerHTML = `<strong>${categoryAd}</strong> öğesini silmek istediğinizden emin misiniz?<br><small class="text-muted">Bu işlem geri alınamaz.</small>`;
    backdrop.classList.add('active');
}

/**
 * Silme onay modal'ını gizle
 */
function hideSilConfirm() {
    const backdrop = document.getElementById('deleteModalBackdrop');
    backdrop.classList.remove('active');
    deleteConfirmData = { type: '', category: '', itemId: null };
}

/**
 * Silme işlemini onayla ve gerçekleştir
 */
function confirmSil() {
    const { type, category, itemId } = deleteConfirmData;
    
    if (type === 'swot') {
        const item = document.querySelector(`[data-category="${category}"][data-id="${itemId}"]`);
        if (item) {
            // Animasyon ile sil
            item.style.transition = 'all 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(-100px)';
            
            setTimeout(() => {
                item.remove();
                showToast('warning', `${getKategoriAd(category)} silindi`);
                
                // Backend'e kaydet
                saveSwotAnalysis();
            }, 300);
        }
    } else if (type === 'pestle') {
        const item = document.querySelector(`[data-category="${category}"][data-id="${itemId}"]`);
        if (item) {
            // Animasyon ile sil
            item.style.transition = 'all 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(-100px)';
            
            setTimeout(() => {
                item.remove();
                showToast('warning', `${getPestleKategoriAd(category)} silindi`);
                
                // Backend'e kaydet
                savePestleAnalysis();
            }, 300);
        }
    }
    
    hideSilConfirm();
}

function openModal(section) {
    currentSection = section;
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    
    const modalBaşlık = document.getElementById('modalBaşlık');
    const modalBody = document.getElementById('modalBody');
    const editButton = document.getElementById('editButton');
    
    // Başlıkları ayarla
    const titles = {
        'degerler': '<i class="fas fa-heart me-2"></i>Değerler ve Etik Kurallar',
        'amac': '<i class="fas fa-bullseye me-2"></i>Amaç (Purpose)',
        'kalite': '<i class="fas fa-certificate me-2"></i>Kalite Politikası',
        'ekosistem': '<i class="fas fa-leaf me-2"></i>Ekosistem',
        'vizyon': '<i class="fas fa-eye me-2"></i>Vizyon',
        'swot': '<i class="fas fa-chart-bar me-2"></i>SWOT Analizi',
        'pestle': '<i class="fas fa-globe me-2"></i>PESTLE Analizi',
        'anaStratejiler': '<i class="fas fa-sitemap me-2"></i>Ana Stratejiler',
        'altStratejiler': '<i class="fas fa-stream me-2"></i>Alt Stratejiler'
    };
    
    modalBaşlık.innerHTML = titles[section] || 'Detaylar';
    
    // İçeriği yükle
    loadModalContent(section, modalBody);
    
    modal.show();
}

function loadModalContent(section, container) {
    container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Yükleniyor...</p></div>';
    
    switch(section) {
        case 'degerler':
            container.innerHTML = `
                <h6 class="mb-3">Değerler:</h6>
                <ul class="list-group mb-4">
                    {% for deger in degerler %}
                    <li class="list-group-item">
                        <strong>{{ deger.baslik }}</strong>
                        <p class="mb-0 text-muted">{{ deger.aciklama }}</p>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted">Henüz deİer eklenmedi</li>
                    {% endfor %}
                </ul>
                
                <h6 class="mb-3">Etik Kuralları:</h6>
                <ul class="list-group">
                    {% for etik in etik_kurallari %}
                    <li class="list-group-item">
                        <strong>{{ etik.baslik }}</strong>
                        <p class="mb-0 text-muted">{{ etik.aciklama }}</p>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted">Henüz etik kural eklenmedi</li>
                    {% endfor %}
                </ul>
            `;
            break;
            
        case 'amac':
            container.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        {% if amac %}
                        <p class="lead">{{ amac }}</p>
                        {% else %}
                        <p class="text-muted text-center py-4">Henüz amaç tanımlanmadı</p>
                        {% endif %}
                    </div>
                </div>
            `;
            break;
            
        case 'kalite':
            container.innerHTML = `
                <ul class="list-group">
                    {% for politika in kalite_politikalari %}
                    <li class="list-group-item">
                        <strong>{{ politika.baslik }}</strong>
                        <p class="mb-0 text-muted">{{ politika.aciklama }}</p>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted">Henüz kalite politikası eklenmedi</li>
                    {% endfor %}
                </ul>
            `;
            break;
            
        case 'ekosistem':
            container.innerHTML = `
                <div class="ecosystem-container">
                    <div class="text-center mb-4">
                        <h3 class="ecosystem-main-title">
                            <i class="fas fa-sitemap text-primary me-3"></i>
                            Kuruluşun Ekosistemi
                        </h3>
                        <p class="text-muted">Kuruluşunuzun iç ve dış çevresini, paydaşlarını ve etkileşimlerini analiz edin</p>
                        
                        <!-- Kayıt ve Yükleme Butonları -->
                        <div class="ecosystem-controls mb-4">
                            <button class="btn btn-success me-2" onclick="saveEcosystemLayout()">
                                <i class="fas fa-save me-2"></i>Tasarımı Kaydet
                            </button>
                            <button class="btn btn-warning me-2" onclick="loadDefaultLayout()">
                                <i class="fas fa-undo me-2"></i>Varsayılanları Yükle
                            </button>
                            <button class="btn btn-info" onclick="resetEcosystemLayout()">
                                <i class="fas fa-refresh me-2"></i>Sıfırla
                            </button>
                        </div>
                    </div>
                    
        <!-- Ekosistem Haritası - Merkez ve Baİlantılar -->
        <div class="ecosystem-map-container">
            <div class="ecosystem-map">
                <!-- Küresel Çevre Halkası -->
                <div class="ecosystem-global-ring">
                    <div class="global-title">KÜRESEL ÇEVRE: KÜRESEL EİİLİMLER</div>
                    <div class="global-items">
                        <div class="global-item">Küresel Isınma</div>
                        <div class="global-item">Paylaşım Ekonomisi</div>
                        <div class="global-item">Demografik Çeşitlilik</div>
                        <div class="global-item">Yıkıcı Teknolojiler</div>
                        <div class="global-item">Jeopolitik Belirsizlik</div>
                        <div class="global-item">BM Sürdürülebilir Kalkınma Amaçları</div>
                        <div class="global-item">Toplumsal Eİilimler</div>
                        <div class="global-item">Ham Maddeler</div>
                    </div>
                </div>
                
                <!-- Pazar / Faaliyet Alanı Halkası -->
                <div class="ecosystem-market-ring">
                    <div class="market-title">PAZAR / FAALİYET ALANI</div>
                    <div class="market-items">
                        <div class="market-item">Aracılar</div>
                        <div class="market-item">Potansiyel Müşteriler</div>
                        <div class="market-item">Özel İlgi Grupları</div>
                        <div class="market-item">Yeni Girişimler</div>
                        <div class="market-item">Basın ve Sosyal Medya</div>
                        <div class="market-item">Rakipler</div>
                        <div class="market-item">Yenilikler</div>
                        <div class="market-item">Mevzuat</div>
                        <div class="market-item">İstihdam</div>
                    </div>
                </div>
                
                <!-- Paydaşlar Halkası -->
                <div class="ecosystem-stakeholders-ring">
                    <div class="stakeholders-title">PAYDAŞLAR</div>
                    <div class="stakeholders-items">
                        <div class="stakeholder-item">İşbirlikleri ve Tedarikçiler</div>
                        <div class="stakeholder-item">Kamu Kuruluşları</div>
                        <div class="stakeholder-item">Müşteriler</div>
                        <div class="stakeholder-item">Çalışanlar</div>
                        <div class="stakeholder-item">Hissedarlar</div>
                        <div class="stakeholder-item">Toplum</div>
                    </div>
                </div>
                
                <!-- Kuruluş Merkezi - Aktif Kuruluş -->
                <div class="ecosystem-center">
                    <div class="center-title">KURULUŞ</div>
                    <div class="center-content">
                        <div class="organization-name">{{ current_user.kurum.kisa_ad if current_user and current_user.kurum else 'Kuruluş Seçilmedi' }}</div>
                    </div>
                </div>
                
                <!-- Aşaİıya Doİru Baİlantı Kutuları -->
                <div class="ecosystem-connections">
                    <div class="connection-box management">
                        <div class="connection-title">Yönetim Yapısı</div>
                        <div class="connection-subtitle">(yönetişim, iş modeli, performans yönetimi)</div>
                    </div>
                    
                    <div class="connection-box leadership">
                        <div class="connection-title">Kurumsal Liderlik</div>
                    </div>
                    
                    <div class="connection-box purpose">
                        <div class="connection-title">Amaç</div>
                    </div>
                    
                    <div class="connection-box strategy">
                        <div class="connection-title">Strateji</div>
                    </div>
                    
                    <div class="connection-box culture">
                        <div class="connection-title">Kültür</div>
                    </div>
                    
                    <div class="connection-box performance">
                        <div class="connection-title">Performans ve Dönüşümü Yönlendirme</div>
                        <div class="connection-subtitle">(Varlıklar ve riskler dahil)</div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            `;
            // Sürükle-bırak özelliİini başlat
            setTimeout(() => {
                initializeEcosystemDragDrop();
            }, 100);
            break;
            
        case 'vizyon':
            container.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        {% if vizyon %}
                        <p class="lead">{{ vizyon }}</p>
                        {% else %}
                        <p class="text-muted text-center py-4">Henüz vizyon tanımlanmadı</p>
                        {% endif %}
                    </div>
                </div>
            `;
            break;
            
        case 'anaStratejiler':
            container.innerHTML = `
                <ul class="list-group">
                    {% for strateji in ana_stratejiler %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ strateji.ad }}</h6>
                                <p class="mb-1 text-muted">{{ strateji.aciklama }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-stream me-1"></i>
                                    {{ strateji.alt_stratejiler|length }} Alt Strateji
                                </small>
                            </div>
                        </div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted">Henüz ana strateji eklenmedi</li>
                    {% endfor %}
                </ul>
            `;
            break;
            
        case 'swot':
            container.innerHTML = `
                <div class="swot-analysis-container">
                    <!-- SWOT Analizi Başlıİı -->
                    <div class="text-center mb-5">
                        <h3 class="swot-main-title">
                            <i class="fas fa-chart-line text-primary me-3"></i>
                            SWOT Analizi
                        </h3>
                        <p class="text-muted">Kurumunuzun güçlü ve zayıf yönlerini, fırsat ve tehditlerini analiz edin</p>
                    </div>
                    
                    <div class="row">
                        <!-- Strengths (Güçlü Yönler) -->
                        <div class="col-md-6 mb-4">
                            <div class="swot-box strengths">
                                <div class="swot-header">
                                    <div class="swot-icon">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <div class="swot-title">
                                        <h5>Güçlü Yönler</h5>
                                        <small class="text-muted">Strengths</small>
                                    </div>
                                </div>
                                <div class="swot-content" id="strengths-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-success btn-sm w-100 mt-3" onclick="addSwotItem('strengths')">
                                    <i class="fas fa-plus-circle me-2"></i> Yeni Güçlü Yön Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Weaknesses (Zayıf Yönler) -->
                        <div class="col-md-6 mb-4">
                            <div class="swot-box weaknesses">
                                <div class="swot-header">
                                    <div class="swot-icon">
                                        <i class="fas fa-tools"></i>
                                    </div>
                                    <div class="swot-title">
                                        <h5>Zayıf Yönler</h5>
                                        <small class="text-muted">Weaknesses</small>
                                    </div>
                                </div>
                                <div class="swot-content" id="weaknesses-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-warning btn-sm w-100 mt-3" onclick="addSwotItem('weaknesses')">
                                    <i class="fas fa-plus-circle me-2"></i> Yeni Zayıf Yön Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Opportunities (Fırsatlar) -->
                        <div class="col-md-6 mb-4">
                            <div class="swot-box opportunities">
                                <div class="swot-header">
                                    <div class="swot-icon">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="swot-title">
                                        <h5>Fırsatlar</h5>
                                        <small class="text-muted">Opportunities</small>
                                    </div>
                                </div>
                                <div class="swot-content" id="opportunities-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-info btn-sm w-100 mt-3" onclick="addSwotItem('opportunities')">
                                    <i class="fas fa-plus-circle me-2"></i> Yeni Fırsat Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Threats (Tehditler) -->
                        <div class="col-md-6 mb-4">
                            <div class="swot-box threats">
                                <div class="swot-header">
                                    <div class="swot-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div class="swot-title">
                                        <h5>Tehditler</h5>
                                        <small class="text-muted">Threats</small>
                                    </div>
                                </div>
                                <div class="swot-content" id="threats-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-danger btn-sm w-100 mt-3" onclick="addSwotItem('threats')">
                                    <i class="fas fa-plus-circle me-2"></i> Yeni Tehdit Ekle
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- Kaydet Butonu -->
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" onclick="saveSwotAnalysis()">
                            <i class="fas fa-save"></i> SWOT Analizini Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            // SWOT verilerini yükle
            loadSwotData();
            break;
            
        case 'pestle':
            container.innerHTML = `
                <div class="pestle-analysis-container">
                    <div class="row">
                        <!-- Political (Politik) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pestle-box political">
                                <div class="pestle-header">
                                    <i class="fas fa-landmark"></i>
                                    <h5>Political (Politik)</h5>
                                </div>
                                <div class="pestle-content" id="political-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-primary btn-sm w-100 mt-2" onclick="addPestleItem('political')">
                                    <i class="fas fa-plus"></i> Yeni Politik Faktör Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Economic (Ekonomik) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pestle-box economic">
                                <div class="pestle-header">
                                    <i class="fas fa-chart-line"></i>
                                    <h5>Economic (Ekonomik)</h5>
                                </div>
                                <div class="pestle-content" id="economic-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-success btn-sm w-100 mt-2" onclick="addPestleItem('economic')">
                                    <i class="fas fa-plus"></i> Yeni Ekonomik Faktör Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Social (Sosyal) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pestle-box social">
                                <div class="pestle-header">
                                    <i class="fas fa-users"></i>
                                    <h5>Social (Sosyal)</h5>
                                </div>
                                <div class="pestle-content" id="social-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-info btn-sm w-100 mt-2" onclick="addPestleItem('social')">
                                    <i class="fas fa-plus"></i> Yeni Sosyal Faktör Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Technological (Teknolojik) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pestle-box technological">
                                <div class="pestle-header">
                                    <i class="fas fa-microchip"></i>
                                    <h5>Technological (Teknolojik)</h5>
                                </div>
                                <div class="pestle-content" id="technological-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-warning btn-sm w-100 mt-2" onclick="addPestleItem('technological')">
                                    <i class="fas fa-plus"></i> Yeni Teknolojik Faktör Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Legal (Yasal) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pestle-box legal">
                                <div class="pestle-header">
                                    <i class="fas fa-gavel"></i>
                                    <h5>Legal (Yasal)</h5>
                                </div>
                                <div class="pestle-content" id="legal-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-danger btn-sm w-100 mt-2" onclick="addPestleItem('legal')">
                                    <i class="fas fa-plus"></i> Yeni Yasal Faktör Ekle
                                </button>
                            </div>
                        </div>

                        <!-- Environmental (Çevresel) -->
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pestle-box environmental">
                                <div class="pestle-header">
                                    <i class="fas fa-leaf"></i>
                                    <h5>Environmental (Çevresel)</h5>
                                </div>
                                <div class="pestle-content" id="environmental-content">
                                    <!-- Veriler JavaScript ile yüklenecek -->
                                </div>
                                <button class="btn btn-secondary btn-sm w-100 mt-2" onclick="addPestleItem('environmental')">
                                    <i class="fas fa-plus"></i> Yeni Çevresel Faktör Ekle
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PESTLE Etki Matrisi -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="pestle-matrix">
                                <h5 class="text-center mb-3">
                                    <i class="fas fa-chart-pie"></i> PESTLE Etki Analizi (Şiddet x Olasılık)
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered pestle-matrix-table">
                                        <thead>
                                            <tr>
                                                <th class="text-center">Kategori</th>
                                                <th class="text-center">Faktör Sayısı</th>
                                                <th class="text-center">Toplam Etki Puanı</th>
                                                <th class="text-center">Ortalama Etki</th>
                                                <th class="text-center">Risk Seviyesi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pestle-matrix-body">
                                            <!-- Dinamik olarak doldurulacak -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kaydet Butonu -->
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" onclick="savePestleAnalysis()">
                            <i class="fas fa-save"></i> PESTLE Analizini Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            // PESTLE verilerini yükle
            loadPestleData();
            break;
            
        case 'altStratejiler':
            container.innerHTML = `
                <ul class="list-group">
                    {% for alt in alt_stratejiler %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ alt.ad }}</h6>
                                <p class="mb-1 text-muted">{{ alt.aciklama }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-sitemap me-1"></i>
                                    Ana Strateji: {{ alt.ana_strateji.ad }}
                                </small>
                            </div>
                        </div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted">Henüz alt strateji eklenmedi</li>
                    {% endfor %}
                </ul>
            `;
            break;
            
        default:
            container.innerHTML = '<p class="text-center text-muted py-4">Bu bölüm henüz hazırlanmadı</p>';
    }
}


// ==========================================
// CANLI YENİLEME FONKSİYONLARI
// ==========================================

let autoRefreshInterval = null;
let lastGüncelleSaatstamp = new Tarih();

// Sayfa yüklendiİinde otomatik yenilemeyi başlat
document.addEventListener('DOMContentLoaded', function() {
    console.log('Stratejik Planlama Akışı sayfası yüklendi');
    
    // Modal butonlarına event listener ekle (onclick'in yanında)
    const saveBtn = document.querySelector('.edit-modal-btn-save');
    if (saveBtn) {
        console.log('Kaydet butonuna event listener ekleniyor...');
        saveBtn.addEventListener('click', function(e) {
            console.log('KAYDET BUTONU TIKLANDI! (addEventListener)');
            e.preventDefault();
            e.stopPropagation();
            saveDüzenleModal();
        });
    } else {
        console.warn('Kaydet butonu bulunamadı!');
    }
    
    try {
        updateLastGüncelleSaat();
    } catch (error) {
        console.warn('updateLastGüncelleSaat hatası:', error);
    }
    
    // Otomatik yenileme checkbox'ı dinle
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
        
        // Başlangıçta aktifse başlat
        if (autoRefreshToggle.checked) {
            startAutoRefresh();
        }
    }
    
    // LocalStorage deİişikliklerini dinle (diİer sekmelerden gelen güncellemeler)
    setupStorageListener();
});

// Otomatik yenilemeyi başlat
function startAutoRefresh() {
    console.log('Otomatik yenileme başlatıldı (30 saniye)');
    
    // Önce mevcut interval'i temizle
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Otomatik yenileme kaldırıldı - kullanıcı deİişikliklerini kaybetmemesi için
}

// Otomatik yenilemeyi durdur
function stopAutoRefresh() {
    console.log('Otomatik yenileme durduruldu');
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Sayfayı yenile (AJAX ile)
function refreshPageData() {
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    
    // Butonu devre dışı bırak ve animasyon başlat
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshIcon.classList.add('fa-spin');
    }
    
    console.log('Sayfa verileri yenileniyor...');
    
    // AJAX ile sayfayı yeniden yükle
    fetch(window.location.href, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Sayfa yenilenemedi');
        }
        return response.text();
    })
    .then(html => {
        // Sayfayı tamamen yenile (en basit yöntem)
        console.log('Sayfa başarıyla yenilendi');
        window.location.reload();
    })
    .catch(error => {
        console.error('Yenileme hatası:', error);
        
        // Hata durumunda toast göster
        showToast('error', 'Sayfa yenilenemedi. Lütfen tekrar deneyin.');
        
        // Butonu tekrar aktif et
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('fa-spin');
        }
    });
}

// Son güncelleme zamanını göster
function updateLastGüncelleSaat() {
    const lastGüncelleElement = document.getElementById('lastGüncelleSaat');
    if (lastGüncelleElement) {
        const now = new Tarih();
        const timeString = now.toLocaleSaatString('tr-TR', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        lastGüncelleElement.innerHTML = `<i class="fas fa-clock me-1"></i>Son güncelleme: ${timeString}`;
    }
}

// Sayfa görünürlük deİişikliklerini dinle
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Sayfa arka planda, otomatik yenilemeyi durdur
        console.log('Sayfa arka plana alındı, otomatik yenileme durduruluyor');
        stopAutoRefresh();
    } else {
        // Sayfa tekrar aktif, otomatik yenileme ayarını kontrol et
        console.log('Sayfa tekrar aktif oldu');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        if (autoRefreshToggle && autoRefreshToggle.checked) {
            console.log('Otomatik yenileme yeniden başlatılıyor');
            refreshPageData(); // Hemen bir kez yenile
            startAutoRefresh();
        }
    }
});

// Sayfa kapatılırken interval'i temizle
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// ==========================================
// LOCALSTORAGE DİNLEYİCİSİ (DİİER SEKMELER İÇİN)
// ==========================================

/**
 * LocalStorage deİişikliklerini dinle
 * Kurum panelinden veri kaydedildiİinde otomatik yenile
 */
function setupStorageListener() {
    // storage event sadece diİer sekmelerden gelir (aynı sekme için çalışmaz)
    window.addEventListener('storage', function(e) {
        console.log('Storage event algılandı:', e.key, e.newValue);
        
        if (e.key === 'sp_data_updated' && e.newValue) {
            try {
                const updateData = JSON.parse(e.newValue);
                console.log('Kurum panelinden güncelleme geldi:', updateData);
                
                // Bildirim göster
                showGüncelleNotification(updateData);
                
                // Otomatik yenile (2 saniye sonra)
                setTimeout(() => {
                    console.log('Otomatik yenileme başlatılıyor...');
                    refreshPageData();
                }, 2000);
                
            } catch (error) {
                console.error('Storage data parse hatası:', error);
            }
        }
    });
    
    console.log('LocalStorage dinleyicisi kuruldu');
}

/**
 * Güncelleme bildirimi göster
 */
function showGüncelleNotification(updateData) {
    // Toast benzeri bildirim oluştur
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-sync-alt fa-spin me-2"></i>
        <strong>Yeni güncelleme!</strong><br>
        <small>${updateData.message || 'Veriler güncellendi'}</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 5 saniye sonra otomatik kapat
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// ==========================================
// SWOT ANALİZİ FONKSİYONLARI
// ==========================================

/**
 * SWOT analizi için yeni öİe ekle
 */
function addSwotItem(category) {
    showEkleModal('swot', category);
}


/**
 * SWOT analizi öğesini düzenle
 */
function editSwotItem(category, itemId, currentText) {
    console.log('editSwotItem çağrıldı:', {
        category: category,
        itemId: itemId,
        itemIdTip: typeof itemId,
        currentText: currentText,
        textLength: currentText ? currentText.length : 0
    });
    showDüzenleModal('swot', category, itemId, currentText);
}

/**
 * SWOT analizi öğesini sil
 */
function deleteSwotItem(category, itemId) {
    showSilConfirm('swot', category, itemId);
}

/**
 * SWOT analizi öğesi oluştur
 */
function createSwotItem(id, text, category) {
    const item = document.createElement('div');
    item.className = 'swot-item';
    item.setAttribute('data-id', String(id));
    item.setAttribute('data-category', category);
    console.log('createSwotItem - ID:', id, 'Tip:', typeof id, 'String:', String(id));
    
    // Kategori ikonları
    const categoryIcons = {
        'strengths': 'fas fa-rocket',
        'weaknesses': 'fas fa-tools', 
        'opportunities': 'fas fa-star',
        'threats': 'fas fa-shield-alt'
    };
    
    // Yetki kontrolü - sadece admin, kurum_yoneticisi, ust_yonetim düzenleyebilir
    const canDüzenle = {{ 'true' if current_user.sistem_rol in ['admin', 'kurum_yoneticisi', 'ust_yonetim'] else 'false' }};
    
    // Butonları ekle
    const editButton = canDüzenle ? `
        <button class="btn btn-sm btn-outline-primary swot-edit-btn" data-category="${category}" data-id="${id}" title="Düzenle">
            <i class="fas fa-edit"></i>
        </button>
    ` : '';
    
    const deleteButton = canDüzenle ? `
        <button class="btn btn-sm btn-outline-danger swot-delete-btn" data-category="${category}" data-id="${id}" title="Sil">
            <i class="fas fa-trash"></i>
        </button>
    ` : '';
    
    item.innerHTML = `
        <div class="swot-item-content">
            <div class="swot-item-icon">
                <i class="${categoryIcons[category]}"></i>
            </div>
            <div class="swot-item-text">
                <p>${text}</p>
            </div>
            <div class="swot-item-actions">
                ${editButton}
                ${deleteButton}
            </div>
        </div>
    `;
    
    // Event listener'ları ekle
    const editBtn = item.querySelector('.swot-edit-btn');
    if (editBtn) {
        console.log('SWOT Düzenle butonu event listener ekleniyor:', category, id);
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('SWOT Düzenle butonu tıklandı!', category, id);
            const cat = this.getAttribute('data-category');
            const itemId = this.getAttribute('data-id');
            const textElement = item.querySelector('.swot-item-text p');
            const currentText = textElement ? textElement.textContent : '';
            console.log('Düzenle parametreleri:', cat, itemId, currentText);
            editSwotItem(cat, itemId, currentText);
        });
    } else {
        console.warn('SWOT Düzenle butonu bulunamadı!', category, id);
    }
    
    const deleteBtn = item.querySelector('.swot-delete-btn');
    if (deleteBtn) {
        console.log('SWOT Sil butonu event listener ekleniyor:', category, id);
        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('SWOT Sil butonu tıklandı!', category, id);
            const cat = this.getAttribute('data-category');
            const itemId = this.getAttribute('data-id');
            deleteSwotItem(cat, itemId);
        });
    } else {
        console.warn('SWOT Sil butonu bulunamadı!', category, id);
    }
    
    return item;
}

/**
 * Kategori adını Türkçe olarak döndür
 */
function getKategoriAd(category) {
    const names = {
        'strengths': 'Güçlü Yön',
        'weaknesses': 'Zayıf Yön',
        'opportunities': 'Fırsat',
        'threats': 'Tehdit'
    };
    return names[category] || category;
}

/**
 * SWOT analizini kaydet
 */
function saveSwotAnalysis() {
    console.log('saveSwotAnalysis başladı');
    
    const swotData = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: []
    };
    
    // Her kategoriden verileri topla
    ['strengths', 'weaknesses', 'opportunities', 'threats'].forEach(category => {
        const items = document.querySelectorAll(`[data-category="${category}"]`);
        console.log(`${category} için ${items.length} öğe bulundu`);
        
        items.forEach(item => {
            const textElement = item.querySelector('.swot-item-text p');
            if (textElement) {
                const text = textElement.textContent;
                if (text.trim()) {
                    swotData[category].push({
                        id: item.getAttribute('data-id'),
                        text: text.trim()
                    });
                }
            }
        });
    });
    
    console.log('SWOT verisi toplandı:', swotData);
    
    // CSRF token'ı al
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    console.log('CSRF Token:', csrfToken ? 'Mevcut' : 'YOK!');
    
    // AJAX ile kaydet
    const headers = {
        'Content-Tip': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
    };
    
    if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
    }
    
    fetch('/api/save-swot-analysis', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(swotData)
    })
    .then(response => {
        console.log('SWOT kaydetme response status:', response.status);
        console.log('Response content-type:', response.headers.get('content-type'));
        
        // Eğer HTML dönüyorsa (login redirect gibi)
        const contentTip = response.headers.get('content-type');
        if (contentTip && contentTip.includes('text/html')) {
            throw new Error('Oturum süresi dolmuş olabilir. Lütfen sayfayı yenileyin.');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('SWOT kaydetme response:', data);
        if (data.success) {
            showToast('success', 'SWOT analizi başarıyla kaydedildi');
            
            // SWOT matrisini güncelle
            updateSwotMatrix(swotData);
            
            // LocalStorage'a kaydet (diİer sekmeler için)
            localStorage.setItem('sp_data_updated', JSON.stringify({
                type: 'swot_analysis',
                message: 'SWOT analizi güncellendi',
                timestamp: new Tarih().toISOString()
            }));
            
            // Storage event tetikle (aynı sekme için)
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'sp_data_updated',
                newValue: JSON.stringify({
                    type: 'swot_analysis',
                    message: 'SWOT analizi güncellendi',
                    timestamp: new Tarih().toISOString()
                })
            }));
            
        } else {
            showToast('error', data.message || 'SWOT analizi kaydedilemedi');
        }
    })
    .catch(error => {
        console.error('SWOT kaydetme hatası:', error);
        console.error('Hata detayı:', error.message, error.stack);
        showToast('error', 'SWOT analizi kaydedilirken hata oluştu: ' + error.message);
    });
}

/**
 * Toast bildirimi göster
 */
function showToast(type, message) {
    // Bootstrap toast kullan
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toastId = 'toast-' + Tarih.now();
    const toastHtml = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${type === 'error' ? 'danger' : type} text-white">
                <i class="fas fa-${getToastIcon(type)} me-2"></i>
                <strong class="me-auto">${getToastBaşlık(type)}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000
    });
    
    toast.show();
    
    // Toast kapandıktan sonra DOM'dan kaldır
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

/**
 * Toast container oluştur
 */
function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

/**
 * Toast ikonu döndür
 */
function getToastIcon(type) {
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

/**
 * Toast başlıİı döndür
 */
function getToastBaşlık(type) {
    const titles = {
        'success': 'Başarılı',
        'error': 'Hata',
        'warning': 'Uyarı',
        'info': 'Bilgi'
    };
    return titles[type] || 'Bilgi';
}

/**
 * SWOT verilerini yükle
 */
function loadSwotData() {
    fetch('/api/get-swot-analysis')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Her kategori için verileri yükle
                ['strengths', 'weaknesses', 'opportunities', 'threats'].forEach(category => {
                    const container = document.getElementById(`${category}-content`);
                    if (container) {
                        container.innerHTML = '';
                        
                        const items = data.data[category] || [];
                        if (items.length === 0) {
                            // Örnek veriler ekle
                            const sampleData = getSampleSwotData(category);
                            sampleData.forEach(item => {
                                const swotItem = createSwotItem(item.id, item.text, category);
                                container.appendChild(swotItem);
                            });
                        } else {
                            // Veritabanından gelen verileri yükle
                            items.forEach(item => {
                                const swotItem = createSwotItem(item.id, item.text, category);
                                container.appendChild(swotItem);
                            });
                        }
                    }
                });
                
                // Matrisi güncelle
                updateSwotMatrix(data.data);
            } else {
                console.error('SWOT verileri yüklenemedi:', data.message);
                // Hata durumunda örnek verileri yükle
                loadSampleSwotData();
            }
        })
        .catch(error => {
            console.error('SWOT verileri yükleme hatası:', error);
            // Hata durumunda örnek verileri yükle
            loadSampleSwotData();
        });
}

/**
 * Örnek SWOT verilerini yükle
 */
function loadSampleSwotData() {
    const sampleSwotData = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: []
    };
    
    ['strengths', 'weaknesses', 'opportunities', 'threats'].forEach(category => {
        const container = document.getElementById(`${category}-content`);
        if (container) {
            container.innerHTML = '';
            const sampleData = getSampleSwotData(category);
            sampleData.forEach(item => {
                const swotItem = createSwotItem(item.id, item.text, category);
                container.appendChild(swotItem);
                sampleSwotData[category].push(item);
            });
        }
    });
    
    // Örnek verilerle matrisi güncelle
    updateSwotMatrix(sampleSwotData);
}

/**
 * Kategori için örnek verileri döndür
 */
function getSampleSwotData(category) {
    const sampleData = {
        'strengths': [
            { id: 1, text: 'Deneyimli ve uzman kadro' },
            { id: 2, text: 'Güçlü finansal yapı' },
            { id: 3, text: 'İyi kurumsal imaj' }
        ],
        'weaknesses': [
            { id: 1, text: 'Teknoloji altyapısında eksiklikler' },
            { id: 2, text: 'Pazar payında düşüş' }
        ],
        'opportunities': [
            { id: 1, text: 'Yeni pazar segmentlerine giriş' },
            { id: 2, text: 'Dijital dönüşüm fırsatları' },
            { id: 3, text: 'Stratejik ortaklık imkanları' }
        ],
        'threats': [
            { id: 1, text: 'Artış gösteren rekabet' },
            { id: 2, text: 'Ekonomik belirsizlikler' },
            { id: 3, text: 'Teknolojik deİişim hızı' }
        ]
    };
    
    return sampleData[category] || [];
}

// ==========================================
// PESTLE ANALİZİ FONKSİYONLARI
// ==========================================

/**
 * PESTLE analizi için yeni öİe ekle
 */
function addPestleItem(category) {
    showEkleModal('pestle', category);
}

/**
 * PESTLE faktör ekleme formunu göster
 */
function showPestleForm(category) {
    const modalHtml = `
        <div class="modal fade" id="pestleFormModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus"></i> Yeni ${getPestleKategoriAd(category)} Faktörü
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="pestleForm">
                            <div class="mb-3">
                                <label for="pestleText" class="form-label">Faktör Açıklaması</label>
                                <textarea class="form-control" id="pestleText" rows="3" placeholder="Faktörü detaylı olarak açıklayın..." required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="pestleSeverity" class="form-label">Şiddet (1-5)</label>
                                    <select class="form-select" id="pestleSeverity" required>
                                        <option value="">Seçiniz</option>
                                        <option value="1">1 - Çok Düşük</option>
                                        <option value="2">2 - Düşük</option>
                                        <option value="3">3 - Orta</option>
                                        <option value="4">4 - Yüksek</option>
                                        <option value="5">5 - Çok Yüksek</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="pestleProbability" class="form-label">Olasılık (1-5)</label>
                                    <select class="form-select" id="pestleProbability" required>
                                        <option value="">Seçiniz</option>
                                        <option value="1">1 - Çok Düşük</option>
                                        <option value="2">2 - Düşük</option>
                                        <option value="3">3 - Orta</option>
                                        <option value="4">4 - Yüksek</option>
                                        <option value="5">5 - Çok Yüksek</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Etki Puanı = Şiddet Ç— Olasılık (Maksimum: 25)
                                </small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="button" class="btn btn-primary" onclick="savePestleItem('${category}')">
                            <i class="fas fa-save"></i> Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Eski modal varsa kaldır
    const existingModal = document.getElementById('pestleFormModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Yeni modal ekle
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Modal'ı göster
    const modal = new bootstrap.Modal(document.getElementById('pestleFormModal'));
    modal.show();
    
    // Modal kapandıİında temizle
    document.getElementById('pestleFormModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

/**
 * PESTLE faktörünü kaydet
 */
function savePestleItem(category) {
    const text = document.getElementById('pestleText').value.trim();
    const severity = parseInt(document.getElementById('pestleSeverity').value);
    const probability = parseInt(document.getElementById('pestleProbability').value);
    
    if (!text || !severity || !probability) {
        showToast('error', 'Lütfen tüm alanları doldurun');
        return;
    }
    
        const container = document.getElementById(`${category}-content`);
        if (container) {
        const newId = Tarih.now();
        const impact = severity * probability;
        const newItem = createPestleItem(newId, text, category, severity, probability, impact);
            container.appendChild(newItem);
            
            // Animasyon ekle
            newItem.style.opacity = '0';
            newItem.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                newItem.style.transition = 'all 0.3s ease';
                newItem.style.opacity = '1';
                newItem.style.transform = 'translateY(0)';
            }, 100);
            
        showToast('success', `${getPestleKategoriAd(category)} faktörü eklendi (Etki: ${impact})`);
        
        // Modal'ı kapat
        const modal = bootstrap.Modal.getInstance(document.getElementById('pestleFormModal'));
        modal.hide();
        
        // Matrisi hemen güncelle
            updatePestleMatrixFromCurrentData();
        
        // LocalStorage'a kaydet
        savePestleDataToLocalStorage();
    }
}

/**
 * PESTLE verilerini LocalStorage'a kaydet
 */
function savePestleDataToLocalStorage() {
    const pestleData = {
        political: [],
        economic: [],
        social: [],
        technological: [],
        legal: [],
        environmental: []
    };
    
    // Her kategoriden verileri topla
    ['political', 'economic', 'social', 'technological', 'legal', 'environmental'].forEach(category => {
        const items = document.querySelectorAll(`[data-category="${category}"]`);
        items.forEach(item => {
            const text = item.querySelector('.pestle-description').textContent;
            const severity = parseInt(item.getAttribute('data-severity')) || 0;
            const probability = parseInt(item.getAttribute('data-probability')) || 0;
            const impact = parseInt(item.getAttribute('data-impact')) || 0;
            
            if (text.trim()) {
                pestleData[category].push({
                    id: item.getAttribute('data-id'),
                    text: text.trim(),
                    severity: severity,
                    probability: probability,
                    impact: impact
                });
            }
        });
    });
    
    // LocalStorage'a kaydet
    localStorage.setItem('pestle_analysis_data', JSON.stringify(pestleData));
}

/**
/**
 * PESTLE analizi öğesini düzenle
 */
function editPestleItem(category, itemId, currentText) {
    console.log('editPestleItem çağrıldı:', {
        category: category,
        itemId: itemId,
        itemIdTip: typeof itemId,
        currentText: currentText,
        textLength: currentText ? currentText.length : 0
    });
    showDüzenleModal('pestle', category, itemId, currentText);
}

/**
 * PESTLE analizi öğesini sil
 */
function deletePestleItem(category, itemId) {
    showSilConfirm('pestle', category, itemId);
}

/**
 * PESTLE analizi öİesi oluştur
 */
function createPestleItem(id, text, category, severity = null, probability = null, impact = null) {
    const item = document.createElement('div');
    item.className = 'pestle-item';
    item.setAttribute('data-id', String(id));
    item.setAttribute('data-category', category);
    item.setAttribute('data-severity', severity || '');
    item.setAttribute('data-probability', probability || '');
    item.setAttribute('data-impact', impact || '');
    console.log('createPestleItem - ID:', id, 'Tip:', typeof id);
    
    const severityText = severity ? `Şiddet: ${severity}` : '';
    const probabilityText = probability ? `Olasılık: ${probability}` : '';
    const impactText = impact ? `Etki: ${impact}` : '';
    
    item.innerHTML = `
        <div class="pestle-item-content">
            <div class="pestle-item-text">
                <p>${text}</p>
                ${severity || probability || impact ? `
                    <div class="pestle-metrics">
                        ${severity ? `<span class="badge bg-primary me-1">${severityText}</span>` : ''}
                        ${probability ? `<span class="badge bg-info me-1">${probabilityText}</span>` : ''}
                        ${impact ? `<span class="badge bg-warning">${impactText}</span>` : ''}
                    </div>
                ` : ''}
            </div>
            <div class="pestle-item-actions">
                <button class="btn btn-sm btn-outline-primary pestle-edit-btn" data-category="${category}" data-id="${id}" title="Düzenle">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger pestle-delete-btn" data-category="${category}" data-id="${id}" title="Sil">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    // Event listener'ları ekle
    const editBtn = item.querySelector('.pestle-edit-btn');
    if (editBtn) {
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const cat = this.getAttribute('data-category');
            const itemId = this.getAttribute('data-id');
            const textElement = item.querySelector('.pestle-item-text p');
            const currentText = textElement ? textElement.textContent : '';
            console.log('PESTLE edit:', cat, itemId, currentText);
            editPestleItem(cat, itemId, currentText);
        });
    }
    
    const deleteBtn = item.querySelector('.pestle-delete-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const cat = this.getAttribute('data-category');
            const itemId = this.getAttribute('data-id');
            deletePestleItem(cat, itemId);
        });
    }
    
    return item;
}

/**
 * PESTLE kategori adını Türkçe olarak döndür
 */
function getPestleKategoriAd(category) {
    const names = {
        'political': 'Politik',
        'economic': 'Ekonomik',
        'social': 'Sosyal',
        'technological': 'Teknolojik',
        'legal': 'Yasal',
        'environmental': 'Çevresel'
    };
    return names[category] || category;
}

/**
 * PESTLE verilerini yükle
 */
function loadPestleData() {
    // Önce LocalStorage'dan yükle
    const savedData = localStorage.getItem('pestle_analysis_data');
    if (savedData) {
        try {
            const pestleData = JSON.parse(savedData);
            loadPestleDataFromObject(pestleData);
            return;
        } catch (error) {
            console.error('LocalStorage PESTLE veri parse hatası:', error);
        }
    }
    
    // LocalStorage'da veri yoksa sunucudan yükle
    fetch('/api/get-pestle-analysis')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadPestleDataFromObject(data.data);
            } else {
                console.error('PESTLE verileri yüklenemedi:', data.message);
                // Hata durumunda örnek verileri yükle
                loadSamplePestleData();
            }
        })
        .catch(error => {
            console.error('PESTLE verileri yükleme hatası:', error);
            // Hata durumunda örnek verileri yükle
            loadSamplePestleData();
        });
}

/**
 * PESTLE verilerini objeden yükle
 */
function loadPestleDataFromObject(pestleData) {
                // Her kategori için verileri yükle
                ['political', 'economic', 'social', 'technological', 'legal', 'environmental'].forEach(category => {
                    const container = document.getElementById(`${category}-content`);
                    if (container) {
                        container.innerHTML = '';
                        
            const items = pestleData[category] || [];
                            items.forEach(item => {
                const newItem = createPestleItem(
                    item.id, 
                    item.text, 
                    category, 
                    item.severity, 
                    item.probability, 
                    item.impact
                );
                container.appendChild(newItem);
            });
                    }
                });
                
                // Matrisi güncelle
    updatePestleMatrixFromCurrentData();
}

/**
 * Örnek PESTLE verilerini yükle
 */
function loadSamplePestleData() {
    const samplePestleData = {
        political: [],
        economic: [],
        social: [],
        technological: [],
        legal: [],
        environmental: []
    };
    
    ['political', 'economic', 'social', 'technological', 'legal', 'environmental'].forEach(category => {
        const container = document.getElementById(`${category}-content`);
        if (container) {
            container.innerHTML = '';
            const sampleData = getSamplePestleData(category);
            sampleData.forEach(item => {
                const pestleItem = createPestleItem(item.id, item.text, category);
                container.appendChild(pestleItem);
                samplePestleData[category].push(item);
            });
        }
    });
    
    // Örnek verilerle matrisi güncelle
    updatePestleMatrix(samplePestleData);
}

/**
 * Kategori için örnek PESTLE verileri döndür
 */
function getSamplePestleData(category) {
    const sampleData = {
        'political': [
            { id: 1, text: 'Hükümet politikaları' },
            { id: 2, text: 'Yasal düzenlemeler' }
        ],
        'economic': [
            { id: 1, text: 'Enflasyon oranları' },
            { id: 2, text: 'İşsizlik oranları' },
            { id: 3, text: 'Faiz oranları' }
        ],
        'social': [
            { id: 1, text: 'Demografik deİişimler' },
            { id: 2, text: 'Sosyal trendler' }
        ],
        'technological': [
            { id: 1, text: 'Dijital dönüşüm' },
            { id: 2, text: 'Yapay zeka gelişmeleri' },
            { id: 3, text: 'Otomasyon teknolojileri' }
        ],
        'legal': [
            { id: 1, text: 'İş hukuku deİişiklikleri' },
            { id: 2, text: 'Vergi mevzuatı' }
        ],
        'environmental': [
            { id: 1, text: 'İklim deİişikliİi' },
            { id: 2, text: 'Sürdürülebilirlik' }
        ]
    };
    
    return sampleData[category] || [];
}

/**
 * Mevcut PESTLE verilerinden matrisi güncelle
 */
function updatePestleMatrixFromCurrentData() {
    const pestleData = {
        political: [],
        economic: [],
        social: [],
        technological: [],
        legal: [],
        environmental: []
    };
    
    // Mevcut verileri topla
    ['political', 'economic', 'social', 'technological', 'legal', 'environmental'].forEach(category => {
        const items = document.querySelectorAll(`[data-category="${category}"]`);
        items.forEach(item => {
            const text = item.querySelector('.pestle-description').textContent;
            const severity = parseInt(item.getAttribute('data-severity')) || 0;
            const probability = parseInt(item.getAttribute('data-probability')) || 0;
            const impact = parseInt(item.getAttribute('data-impact')) || 0;
            
            if (text.trim()) {
                pestleData[category].push({
                    id: item.getAttribute('data-id'),
                    text: text.trim(),
                    severity: severity,
                    probability: probability,
                    impact: impact
                });
            }
        });
    });
    
    // Matrisi güncelle
    updatePestleMatrix(pestleData);
}

/**
 * PESTLE matrisini dinamik olarak güncelle
 */
function updatePestleMatrix(pestleData) {
    const matrixBody = document.getElementById('pestle-matrix-body');
    if (!matrixBody) return;
    
    matrixBody.innerHTML = '';
    
    const categories = [
        { key: 'political', name: 'Political (Politik)' },
        { key: 'economic', name: 'Economic (Ekonomik)' },
        { key: 'social', name: 'Social (Sosyal)' },
        { key: 'technological', name: 'Technological (Teknolojik)' },
        { key: 'legal', name: 'Legal (Yasal)' },
        { key: 'environmental', name: 'Environmental (Çevresel)' }
    ];
    
    categories.forEach(category => {
        const items = pestleData[category.key] || [];
        const factorCount = items.length;
        
        // Gerçek etki hesaplamaları
        const totalImpact = items.reduce((sum, item) => sum + (item.impact || 0), 0);
        const averageImpact = factorCount > 0 ? (totalImpact / factorCount).toFixed(1) : 0;
        
        // Risk seviyesi belirleme
        let riskLevel = 'Düşük';
        let riskClass = 'text-success';
        if (averageImpact >= 15) {
            riskLevel = 'Yüksek';
            riskClass = 'text-danger';
        } else if (averageImpact >= 10) {
            riskLevel = 'Orta';
            riskClass = 'text-warning';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="category-name">
                <strong>${category.name}</strong>
            </td>
            <td class="text-center">
                <span class="badge bg-primary">${factorCount}</span>
            </td>
            <td class="text-center">
                <span class="badge bg-warning">${totalImpact}</span>
            </td>
            <td class="text-center">
                <span class="badge bg-info">${averageImpact}</span>
            </td>
            <td class="text-center">
                <span class="badge ${riskClass.replace('text-', 'bg-')}">${riskLevel}</span>
            </td>
        `;
        matrixBody.appendChild(row);
    });
    
    // Toplam satırı ekle
    const totalRow = document.createElement('tr');
    totalRow.className = 'table-dark';
    
    const totalFactors = Object.values(pestleData).reduce((sum, items) => sum + items.length, 0);
    const totalImpact = Object.values(pestleData).reduce((sum, items) => 
        sum + items.reduce((itemSum, item) => itemSum + (item.impact || 0), 0), 0);
    const overallAverage = totalFactors > 0 ? (totalImpact / totalFactors).toFixed(1) : 0;
    
    totalRow.innerHTML = `
        <td class="category-name">
            <strong><i class="fas fa-calculator"></i> TOPLAM</strong>
        </td>
        <td class="text-center">
            <span class="badge bg-dark">${totalFactors}</span>
        </td>
        <td class="text-center">
            <span class="badge bg-dark">${totalImpact}</span>
        </td>
        <td class="text-center">
            <span class="badge bg-dark">${overallAverage}</span>
        </td>
        <td class="text-center">
            <span class="badge bg-dark">Genel Ortalama</span>
        </td>
    `;
    matrixBody.appendChild(totalRow);
}

/**
 * PESTLE analizini kaydet
 */
function savePestleAnalysis() {
    const pestleData = {
        political: [],
        economic: [],
        social: [],
        technological: [],
        legal: [],
        environmental: []
    };
    
    // Her kategoriden verileri topla
    ['political', 'economic', 'social', 'technological', 'legal', 'environmental'].forEach(category => {
        const items = document.querySelectorAll(`[data-category="${category}"]`);
        items.forEach(item => {
            const textElement = item.querySelector('.pestle-item-text p');
            if (textElement) {
                const text = textElement.textContent;
                const severity = parseInt(item.getAttribute('data-severity')) || 3;
                const probability = parseInt(item.getAttribute('data-probability')) || 3;
                const impact = parseInt(item.getAttribute('data-impact')) || 3;
                
                if (text.trim()) {
                    pestleData[category].push({
                        id: item.getAttribute('data-id'),
                        text: text.trim(),
                        severity: severity,
                        probability: probability,
                        impact: impact
                    });
                }
            }
        });
    });
    
    // Önce LocalStorage'a kaydet (kalıcı veri)
    localStorage.setItem('pestle_analysis_data', JSON.stringify(pestleData));
    
    // Matrisi hemen güncelle
    updatePestleMatrix(pestleData);
    
    // CSRF token'ı al
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    // AJAX ile sunucuya kaydet
    const headers = {
        'Content-Tip': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
    };
    
    if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
    }
    
    fetch('/api/save-pestle-analysis', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(pestleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'PESTLE analizi başarıyla kaydedildi');
            
            // LocalStorage'a kaydet (diİer sekmeler için)
            localStorage.setItem('sp_data_updated', JSON.stringify({
                type: 'pestle_analysis',
                message: 'PESTLE analizi güncellendi',
                timestamp: new Tarih().toISOString()
            }));
            
            // Storage event tetikle (aynı sekme için)
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'sp_data_updated',
                newValue: JSON.stringify({
                    type: 'pestle_analysis',
                    message: 'PESTLE analizi güncellendi',
                    timestamp: new Tarih().toISOString()
                })
            }));
            
        } else {
            showToast('error', data.message || 'PESTLE analizi kaydedilemedi');
        }
    })
    .catch(error => {
        console.error('PESTLE kaydetme hatası:', error);
        showToast('error', 'PESTLE analizi kaydedilirken hata oluştu');
    });
}

/**
 * Mevcut verilerden matrisi güncelle
 */
function updateMatrixFromCurrentData() {
    const swotData = {
        strengths: [],
        weaknesses: [],
        opportunities: [],
        threats: []
    };
    
    // Mevcut verileri topla
    ['strengths', 'weaknesses', 'opportunities', 'threats'].forEach(category => {
        const items = document.querySelectorAll(`[data-category="${category}"]`);
        items.forEach(item => {
            const text = item.querySelector('.swot-text').textContent;
            if (text.trim()) {
                swotData[category].push({
                    id: item.getAttribute('data-id'),
                    text: text.trim()
                });
            }
        });
    });
    
    // Matrisi güncelle
    updateSwotMatrix(swotData);
}

/**
 * SWOT matrisini dinamik olarak güncelle
 */
function updateSwotMatrix(swotData) {
    // SO Stratejileri (Strengths + Opportunities)
    const soStrategies = generateSOStrategies(swotData.strengths, swotData.opportunities);
    updateMatrixCell('.so-strategies .strategy-list', soStrategies);
    
    // WO Stratejileri (Weaknesses + Opportunities)
    const woStrategies = generateWOStrategies(swotData.weaknesses, swotData.opportunities);
    updateMatrixCell('.wo-strategies .strategy-list', woStrategies);
    
    // ST Stratejileri (Strengths + Threats)
    const stStrategies = generateSTStrategies(swotData.strengths, swotData.threats);
    updateMatrixCell('.st-strategies .strategy-list', stStrategies);
    
    // WT Stratejileri (Weaknesses + Threats)
    const wtStrategies = generateWTStrategies(swotData.weaknesses, swotData.threats);
    updateMatrixCell('.wt-strategies .strategy-list', wtStrategies);
}

/**
 * Matris hücresini güncelle
 */
function updateMatrixCell(selector, strategies) {
    const cell = document.querySelector(selector);
    if (cell) {
        cell.innerHTML = '';
        strategies.forEach(strategy => {
            const li = document.createElement('li');
            li.textContent = strategy;
            cell.appendChild(li);
        });
    }
}

/**
 * SO Stratejileri oluştur (Güçlü Yönler + Fırsatlar)
 */
function generateSOStrategies(strengths, opportunities) {
    const strategies = [];
    
    if (strengths.length > 0 && opportunities.length > 0) {
        // Her güçlü yön ve fırsat kombinasyonu için strateji oluştur
        strengths.forEach(strength => {
            opportunities.forEach(opportunity => {
                const strategy = `${strength.text} ile ${opportunity.text}`;
                strategies.push(strategy);
            });
        });
        
        // En fazla 4 strateji göster
        return strategies.slice(0, 4);
    }
    
    return ['Güçlü yönler ve fırsatlar tanımlanmalı'];
}

/**
 * WO Stratejileri oluştur (Zayıf Yönler + Fırsatlar)
 */
function generateWOStrategies(weaknesses, opportunities) {
    const strategies = [];
    
    if (weaknesses.length > 0 && opportunities.length > 0) {
        weaknesses.forEach(weakness => {
            opportunities.forEach(opportunity => {
                const strategy = `${weakness.text} gidermek için ${opportunity.text}`;
                strategies.push(strategy);
            });
        });
        
        return strategies.slice(0, 4);
    }
    
    return ['Zayıf yönler ve fırsatlar tanımlanmalı'];
}

/**
 * ST Stratejileri oluştur (Güçlü Yönler + Tehditler)
 */
function generateSTStrategies(strengths, threats) {
    const strategies = [];
    
    if (strengths.length > 0 && threats.length > 0) {
        strengths.forEach(strength => {
            threats.forEach(threat => {
                const strategy = `${strength.text} ile ${threat.text} bertaraf et`;
                strategies.push(strategy);
            });
        });
        
        return strategies.slice(0, 4);
    }
    
    return ['Güçlü yönler ve tehditler tanımlanmalı'];
}

/**
 * WT Stratejileri oluştur (Zayıf Yönler + Tehditler)
 */
function generateWTStrategies(weaknesses, threats) {
    const strategies = [];
    
    if (weaknesses.length > 0 && threats.length > 0) {
        weaknesses.forEach(weakness => {
            threats.forEach(threat => {
                const strategy = `${weakness.text} minimize et, ${threat.text} savuştur`;
                strategies.push(strategy);
            });
        });
        
        return strategies.slice(0, 4);
    }
    
    return ['Zayıf yönler ve tehditler tanımlanmalı'];
}

// ==========================================
// EKOSİSTEM FONKSİYONLARI
// ==========================================

/**
 * Ekosistem verilerini yükle
 */
function loadEcosystemData() {
    console.log('Ekosistem verileri yükleniyor...');
    
    // Örnek verileri yükle
    loadSampleEcosystemData();
}

/**
 * Zoom In fonksiyonu
 */
function zoomIn() {
    const container = document.getElementById('ecosystemMapContainer');
    if (container) {
        const currentScale = parseFloat(container.style.transform.replace('scale(', '').replace(')', '')) || 1;
        const newScale = Math.min(currentScale * 1.2, 3);
        container.style.transform = `scale(${newScale})`;
    }
}

/**
 * Zoom Out fonksiyonu
 */
function zoomOut() {
    const container = document.getElementById('ecosystemMapContainer');
    if (container) {
        const currentScale = parseFloat(container.style.transform.replace('scale(', '').replace(')', '')) || 1;
        const newScale = Math.max(currentScale / 1.2, 0.5);
        container.style.transform = `scale(${newScale})`;
    }
}

/**
 * Zoom Reset fonksiyonu
 */
function resetZoom() {
    const container = document.getElementById('ecosystemMapContainer');
    if (container) {
        container.style.transform = 'scale(1)';
    }
}

/**
 * Örnek ekosistem verilerini yükle
 */
function loadSampleEcosystemData() {
    const sampleData = {
        'globalEnvironment': [
            { id: 1, text: 'Küresel ısınma' },
            { id: 2, text: 'Dijital dönüşüm' },
            { id: 3, text: 'Sürdürülebilirlik' }
        ],
        'marketActivity': [
            { id: 1, text: 'Rekabet ortamı' },
            { id: 2, text: 'Teknoloji trendleri' },
            { id: 3, text: 'Pazar büyümesi' }
        ],
        'stakeholders': [
            { id: 1, text: 'Müşteriler' },
            { id: 2, text: 'Çalışanlar' },
            { id: 3, text: 'Hissedarlar' },
            { id: 4, text: 'Tedarikçiler' }
        ],
        'organization': [
            { id: 1, text: 'Kurumsal deİerler' },
            { id: 2, text: 'İş modeli' },
            { id: 3, text: 'Yetenekler' }
        ],
        'challenges': [
            { id: 1, text: 'Rekabet baskısı' },
            { id: 2, text: 'Teknoloji deİişimi' }
        ],
        'valueCreation': [
            { id: 1, text: 'Sürdürülebilir büyüme' },
            { id: 2, text: 'Değer yaratma' }
        ],
        'leadership': [
            { id: 1, text: 'Liderlik yetkinlikleri' },
            { id: 2, text: 'Yönetim becerileri' }
        ],
        'performance': [
            { id: 1, text: 'KPI\'lar' },
            { id: 2, text: 'Performans göstergeleri' }
        ],
        'management': [
            { id: 1, text: 'Yönetim yapısı' },
            { id: 2, text: 'İş modeli' }
        ],
        'purpose': [
            { id: 1, text: 'Misyon' },
            { id: 2, text: 'Vizyon' }
        ],
        'strategy': [
            { id: 1, text: 'Stratejik hedefler' },
            { id: 2, text: 'Rekabet stratejisi' }
        ],
        'culture': [
            { id: 1, text: 'Kurumsal kültür' },
            { id: 2, text: 'Değerler' }
        ]
    };
    
    // Her kategori için verileri yükle
    Object.keys(sampleData).forEach(category => {
        // Harita içeriİi
        const mapContainer = document.getElementById(`${category}Items`);
        if (mapContainer) {
            mapContainer.innerHTML = '';
            sampleData[category].forEach(item => {
                const ecosystemItem = createEcosystemItem(item.id, item.text, category);
                mapContainer.appendChild(ecosystemItem);
            });
        }
        
        // Veri girişi içeriİi
        const inputContainer = document.getElementById(`${category}Input`);
        if (inputContainer) {
            inputContainer.innerHTML = '';
            sampleData[category].forEach(item => {
                const ecosystemItem = createEcosystemItem(item.id, item.text, category);
                inputContainer.appendChild(ecosystemItem);
            });
        }
    });
    
    // Haritayı güncelle
    updateEcosystemMap();
}

/**
 * Ekosistem öİesi oluştur
 */
function createEcosystemItem(id, text, category) {
    const item = document.createElement('div');
    item.className = `ecosystem-item ${category}`;
    item.setAttribute('data-id', id);
    item.setAttribute('data-category', category);
    
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${text}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteEcosystemItem('${category}', ${id})" title="Sil">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    return item;
}

/**
 * Ekosistem öİesi ekle
 */
function addEcosystemItem(category) {
    const categoryAds = {
        'globalEnvironment': 'Küresel Eİilim',
        'marketActivity': 'Pazar Faktörü',
        'stakeholders': 'Paydaş',
        'organization': 'Kuruluş Bilgisi',
        'challenges': 'Zorluk/Fırsat',
        'valueCreation': 'Değer Yaratma',
        'leadership': 'Liderlik',
        'performance': 'Performans',
        'management': 'Yönetim',
        'purpose': 'Amaç',
        'strategy': 'Strateji',
        'culture': 'Kültür'
    };
    
    const text = prompt(`${categoryAds[category]} için yeni öİe ekleyin:`);
    if (text && text.trim()) {
        const newId = Tarih.now();
        const newItem = createEcosystemItem(newId, text.trim(), category);
        
        // Hem harita hem veri girişi bölümüne ekle
        const mapContainer = document.getElementById(`${category}Items`);
        const inputContainer = document.getElementById(`${category}Input`);
        
        if (mapContainer) {
            const mapItem = newItem.cloneNode(true);
            mapContainer.appendChild(mapItem);
            
            // Animasyon ekle
            mapItem.style.opacity = '0';
            mapItem.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                mapItem.style.transition = 'all 0.3s ease';
                mapItem.style.opacity = '1';
                mapItem.style.transform = 'translateY(0)';
            }, 100);
        }
        
        if (inputContainer) {
            const inputItem = newItem.cloneNode(true);
            inputContainer.appendChild(inputItem);
            
            // Animasyon ekle
            inputItem.style.opacity = '0';
            inputItem.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                inputItem.style.transition = 'all 0.3s ease';
                inputItem.style.opacity = '1';
                inputItem.style.transform = 'translateY(0)';
            }, 100);
        }
        
        // Haritayı görsel olarak güncelle
        updateEcosystemMap();
        
        showToast('success', `${categoryAds[category]} öİesi eklendi`);
    }
}

/**
 * Ekosistem haritasını görsel olarak güncelle
 */
function updateEcosystemMap() {
    // Her katmanın veri sayısına göre görsel deİişiklikler
    const layers = [
        { id: 'globalEnvironmentLayer', category: 'globalEnvironment' },
        { id: 'marketActivityLayer', category: 'marketActivity' },
        { id: 'stakeholdersLayer', category: 'stakeholders' },
        { id: 'organizationCenter', category: 'organization' }
    ];
    
    layers.forEach(layer => {
        const layerElement = document.getElementById(layer.id);
        const itemsContainer = document.getElementById(`${layer.category}Items`);
        
        if (layerElement && itemsContainer) {
            const itemCount = itemsContainer.children.length;
            
            // Veri sayısına göre katman rengini deİiştir
            if (itemCount === 0) {
                layerElement.style.opacity = '0.3';
                layerElement.style.borderStyle = 'dashed';
            } else if (itemCount < 3) {
                layerElement.style.opacity = '0.6';
                layerElement.style.borderStyle = 'solid';
            } else {
                layerElement.style.opacity = '1';
                layerElement.style.borderStyle = 'solid';
                layerElement.style.borderWidth = '4px';
            }
        }
    });
    
    // Baİlantı kutularını güncelle
    const connections = [
        'challenges', 'valueCreation', 'leadership', 'performance', 
        'management', 'purpose', 'strategy', 'culture'
    ];
    
    connections.forEach(connection => {
        const boxElement = document.getElementById(`${connection}Box`);
        const itemsContainer = document.getElementById(`${connection}Items`);
        
        if (boxElement && itemsContainer) {
            const itemCount = itemsContainer.children.length;
            
            if (itemCount === 0) {
                boxElement.style.opacity = '0.3';
                boxElement.style.borderStyle = 'dashed';
            } else {
                boxElement.style.opacity = '1';
                boxElement.style.borderStyle = 'solid';
            }
        }
    });
}

/**
 * Ekosistem öİesini sil
 */
function deleteEcosystemItem(category, itemId) {
    const item = document.querySelector(`[data-category="${category}"][data-id="${itemId}"]`);
    if (item) {
        const categoryAds = {
            'global-environment': 'Küresel Eİilim',
            'market-activity': 'Pazar Faktörü',
            'stakeholders': 'Paydaş',
            'organization': 'Kuruluş Bilgisi',
            'purpose': 'Amaç',
            'strategy': 'Strateji',
            'culture': 'Kültür',
            'performance': 'Performans'
        };
        
        if (confirm(`${categoryAds[category]} öİesini silmek istediİinizden emin misiniz?`)) {
            // Animasyon ile sil
            item.style.transition = 'all 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(-100px)';
            
            setTimeout(() => {
                item.remove();
                showToast('warning', `${categoryAds[category]} öİesi silindi`);
            }, 300);
        }
    }
}

/**
 * Ekosistem verilerini kaydet
 */
function saveEcosystemData() {
    console.log('Ekosistem verileri kaydediliyor...');
    
    const ecosystemData = {
        'global-environment': [],
        'market-activity': [],
        'stakeholders': [],
        'organization': [],
        'purpose': [],
        'strategy': [],
        'culture': [],
        'performance': []
    };
    
    // Her kategoriden verileri topla
    Object.keys(ecosystemData).forEach(category => {
        const items = document.querySelectorAll(`[data-category="${category}"]`);
        items.forEach(item => {
            const text = item.querySelector('span').textContent;
            const id = item.getAttribute('data-id');
            ecosystemData[category].push({ id: parseInt(id), text: text });
        });
    });
    
    // Verileri kaydet (burada API çaİrısı yapılabilir)
    console.log('Ekosistem verileri:', ecosystemData);
    
    showToast('success', 'Ekosistem verileri başarıyla kaydedildi!');
}

// Sürükle-bırak fonksiyonları
function makeEcosystemItemsDraggable() {
    const marketItems = document.querySelectorAll('.market-item');
    const stakeholderItems = document.querySelectorAll('.stakeholder-item');
    const globalItems = document.querySelectorAll('.global-item');
    const allItems = [...marketItems, ...stakeholderItems, ...globalItems];
    
    console.log('Bulunan market items:', marketItems.length);
    console.log('Bulunan stakeholder items:', stakeholderItems.length);
    console.log('Toplam items:', allItems.length);
    
    allItems.forEach((item, index) => {
        console.log(`Item ${index + 1}:`, item.textContent);
        
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        item.addEventListener('mousedown', (e) => {
            console.log('Mouse down on:', item.textContent);
            isDragging = true;
            item.classList.add('dragging');
            
            startX = e.clientX;
            startY = e.clientY;
            
            const rect = item.getBoundingClientRect();
            const containerRect = item.parentElement.getBoundingClientRect();
            
            initialX = rect.left - containerRect.left;
            initialY = rect.top - containerRect.top;
            
            e.preventDefault();
            e.stopPropagation();
        });
        
        const handleMouseMove = (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            const newX = initialX + deltaX;
            const newY = initialY + deltaY;
            
            // Halkanın içinde kalmasını saİla
            const containerWidth = item.parentElement.offsetWidth;
            const containerHeight = item.parentElement.offsetHeight;
            const itemWidth = item.offsetWidth;
            const itemHeight = item.offsetHeight;
            
            // Halka sınırları (oval şekil için)
            const centerX = containerWidth / 2;
            const centerY = containerHeight / 2;
            const radiusX = containerWidth / 2 - 20; // 20px margin
            const radiusY = containerHeight / 2 - 20;
            
            // Oval sınırları kontrol et
            const relativeX = newX + itemWidth/2 - centerX;
            const relativeY = newY + itemHeight/2 - centerY;
            
            const ellipseCheck = (relativeX * relativeX) / (radiusX * radiusX) + 
                               (relativeY * relativeY) / (radiusY * radiusY);
            
            if (ellipseCheck <= 1) {
                // Oval içinde, konumu güncelle
                item.style.left = newX + 'px';
                item.style.top = newY + 'px';
                item.style.transform = 'none';
            }
        };
        
        const handleMouseUp = () => {
            if (isDragging) {
                console.log('Mouse up on:', item.textContent);
                isDragging = false;
                item.classList.remove('dragging');
                
                // Yüzde deİerlerine çevir
                const containerWidth = item.parentElement.offsetWidth;
                const containerHeight = item.parentElement.offsetHeight;
                const itemWidth = item.offsetWidth;
                const itemHeight = item.offsetHeight;
                
                const x = parseFloat(item.style.left);
                const y = parseFloat(item.style.top);
                
                const percentX = ((x + itemWidth/2) / containerWidth) * 100;
                const percentY = ((y + itemHeight/2) / containerHeight) * 100;
                
                item.style.left = percentX + '%';
                item.style.top = percentY + '%';
                item.style.transform = 'translate(-50%, -50%)';
                
                // Event listener'ları kaldır
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
        };
        
        item.addEventListener('mousedown', (e) => {
            console.log('Mouse down on:', item.textContent);
            isDragging = true;
            item.classList.add('dragging');
            
            startX = e.clientX;
            startY = e.clientY;
            
            const rect = item.getBoundingClientRect();
            const containerRect = item.parentElement.getBoundingClientRect();
            
            initialX = rect.left - containerRect.left;
            initialY = rect.top - containerRect.top;
            
            e.preventDefault();
            e.stopPropagation();
            
            // Event listener'ları ekle
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });
    });
}

// Sayfa yüklendiİinde sürükle-bırak özelliİini etkinleştir
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing drag and drop...');
    makeEcosystemItemsDraggable();
});

// Ekosistem sekmesi açıldıİında da çalıştır
function initializeEcosystemDragDrop() {
    console.log('Initializing ecosystem drag and drop...');
    setTimeout(() => {
        makeEcosystemItemsDraggable();
        loadKaydetdLayout(); // Kaydedilmiş düzeni yükle
    }, 100);
}

// Varsayılan düzen
const defaultLayout = {
    global: {
        'Küresel Isınma': { top: '25%', left: '20%' },
        'Paylaşım Ekonomisi': { top: '45%', left: '15%' },
        'Demografik Çeşitlilik': { bottom: '35%', left: '20%' },
        'Yıkıcı Teknolojiler': { bottom: '25%', left: '50%' },
        'Jeopolitik Belirsizlik': { bottom: '35%', right: '20%' },
        'BM Sürdürülebilir Kalkınma Amaçları': { top: '45%', right: '15%' },
        'Toplumsal Eİilimler': { top: '25%', right: '20%' },
        'Ham Maddeler': { top: '20%', left: '50%' }
    },
    market: {
        'Aracılar': { top: '20%', right: '15%' },
        'Potansiyel Müşteriler': { top: '20%', left: '15%' },
        'Özel İlgi Grupları': { top: '50%', right: '10%' },
        'Yeni Girişimler': { top: '45%', left: '10%' },
        'Basın ve Sosyal Medya': { top: '60%', left: '15%' },
        'Rakipler': { bottom: '20%', left: '40%' },
        'Yenilikler': { bottom: '20%', left: '60%' },
        'Mevzuat': { bottom: '30%', left: '20%' },
        'İstihdam': { bottom: '25%', right: '20%' }
    },
    stakeholder: {
        'İşbirlikleri ve Tedarikçiler': { top: '20%', left: '20%' },
        'Kamu Kuruluşları': { top: '20%', right: '20%' },
        'Müşteriler': { top: '50%', right: '10%' },
        'Çalışanlar': { bottom: '30%', right: '20%' },
        'Hissedarlar': { bottom: '25%', left: '50%' },
        'Toplum': { bottom: '30%', left: '20%' }
    }
};

// Düzeni kaydet
function saveEcosystemLayout() {
    const layout = {
        market: {},
        stakeholder: {}
    };
    
    // Market items
    document.querySelectorAll('.market-item').forEach(item => {
        const text = item.textContent.trim();
        const rect = item.getBoundingClientRect();
        const container = item.parentElement.getBoundingClientRect();
        
        const left = ((rect.left - container.left + rect.width/2) / container.width) * 100;
        const top = ((rect.top - container.top + rect.height/2) / container.height) * 100;
        
        layout.market[text] = { left: left + '%', top: top + '%' };
    });
    
    // Stakeholder items
    document.querySelectorAll('.stakeholder-item').forEach(item => {
        const text = item.textContent.trim();
        const rect = item.getBoundingClientRect();
        const container = item.parentElement.getBoundingClientRect();
        
        const left = ((rect.left - container.left + rect.width/2) / container.width) * 100;
        const top = ((rect.top - container.top + rect.height/2) / container.height) * 100;
        
        layout.stakeholder[text] = { left: left + '%', top: top + '%' };
    });
    
    localStorage.setItem('ecosystemLayout', JSON.stringify(layout));
    showToast('success', 'Ekosistem düzeni kaydedildi!');
}

// Kaydedilmiş düzeni yükle
function loadKaydetdLayout() {
    const saved = localStorage.getItem('ecosystemLayout');
    if (saved) {
        const layout = JSON.parse(saved);
        applyLayout(layout);
    }
}

// Varsayılan düzeni yükle
function loadDefaultLayout() {
    applyLayout(defaultLayout);
    showToast('info', 'Varsayılan düzen yüklendi!');
}

// Düzeni sıfırla
function resetEcosystemLayout() {
    localStorage.removeItem('ecosystemLayout');
    loadDefaultLayout();
    showToast('warning', 'Düzen sıfırlandı!');
}

// Düzeni uygula
function applyLayout(layout) {
    // Market items
    document.querySelectorAll('.market-item').forEach(item => {
        const text = item.textContent.trim();
        if (layout.market[text]) {
            const pos = layout.market[text];
            item.style.left = pos.left;
            item.style.top = pos.top;
            item.style.right = pos.right || 'auto';
            item.style.bottom = pos.bottom || 'auto';
            item.style.transform = 'translate(-50%, -50%)';
        }
    });
    
    // Stakeholder items
    document.querySelectorAll('.stakeholder-item').forEach(item => {
        const text = item.textContent.trim();
        if (layout.stakeholder[text]) {
            const pos = layout.stakeholder[text];
            item.style.left = pos.left;
            item.style.top = pos.top;
            item.style.right = pos.right || 'auto';
            item.style.bottom = pos.bottom || 'auto';
            item.style.transform = 'translate(-50%, -50%)';
        }
    });
}
</script>
{% endblock %}



