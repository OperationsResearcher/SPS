{% extends "base.html" %}

{% block title %}Yönetim Kokpiti{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('main.dashboard') }}">Ana Sayfa</a> / Yönetim Kokpiti
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3><i class="fas fa-tachometer-alt me-2"></i>Yönetim Kokpiti</h3>
                    <p class="text-muted mb-0">Kurumsal genel bakış ve stratejik analitik veriler</p>
                </div>
                <div>
                    <button class="btn btn-danger" onclick="exportDashboardPDF()">
                        <i class="fas fa-file-pdf me-2"></i>PDF Rapor İndir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreleme Paneli -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtreleme</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterDepartment" class="form-label small">Departman</label>
                            <select class="form-select form-select-sm" id="filterDepartment">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterManager" class="form-label small">Proje Yöneticisi</label>
                            <select class="form-select form-select-sm" id="filterManager">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStartDate" class="form-label small">Başlangıç Tarihi</label>
                            <input type="date" class="form-control form-control-sm" id="filterStartDate">
                        </div>
                        <div class="col-md-3">
                            <label for="filterEndDate" class="form-label small">Bitiş Tarihi</label>
                            <input type="date" class="form-control form-control-sm" id="filterEndDate">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                                <i class="fas fa-search me-1"></i>Filtrele
                            </button>
                            <button class="btn btn-secondary btn-sm ms-2" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Yönetici Özeti -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Yönetici Özeti</h5>
                </div>
                <div class="card-body">
                    <div id="executiveSummaryContent">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="text-muted small mt-2">AI özeti oluşturuluyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget 1: Kurumsal Nabız (Gauge Chart) - Mobilde tek sütun -->
    <div class="row mb-4">
        <div class="col-12 col-lg-6 mb-3 mb-lg-0">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Kurumsal Nabız</h5>
                </div>
                <div class="card-body text-center">
                    <canvas id="corporateHealthGauge" style="max-height: 300px;"></canvas>
                    <div class="mt-3">
                        <h4 id="healthScoreDisplay" class="mb-0">-</h4>
                        <p class="text-muted small mb-0" id="healthStatusDisplay">Hesaplanıyor...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Neden Bu Skor? Kutucuğu -->
        <div class="col-12 col-lg-6 mb-3 mb-lg-0">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Neden Bu Skor?</h5>
                </div>
                <div class="card-body">
                    <div id="scoreFactorsList">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="text-muted small mt-2">Etkenler analiz ediliyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Widget 2: Kritik Risk Radarı - Mobilde tek sütun -->
    <div class="row mb-4">
        <div class="col-12 col-lg-6 mb-3 mb-lg-0">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Kritik Risk Radarı</h5>
                </div>
                <div class="card-body">
                    <div id="criticalRisksList">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="text-muted small mt-2">Riskler yükleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget 3: Planlama Becerisi (Bar Chart) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Planlama Becerisi</h5>
                    <small>Tahmini Süre vs Gerçekleşen Süre Karşılaştırması</small>
                </div>
                <div class="card-body">
                    <canvas id="planningEfficiencyChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget 4: Bekleyen İş Yükü (Pie Chart) - Mobilde tek sütun -->
    <div class="row mb-4">
        <div class="col-12 col-lg-6 mb-3 mb-lg-0">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Bekleyen İş Yükü Dağılımı</h5>
                </div>
                <div class="card-body">
                    <canvas id="workloadDistributionChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Özet İstatistikler -->
        <div class="col-12 col-lg-6 mb-3 mb-lg-0">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Özet İstatistikler</h5>
                </div>
                <div class="card-body">
                    <div id="summaryStats">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <p class="text-muted small mt-2">İstatistikler yükleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget 5: Personel Yükü Analizi (Workload Heatmap) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Personel Yükü Analizi</h5>
                    <small>Hangi birim/kişi darboğazda? - Aktif görev sayıları</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-lg-8">
                            <canvas id="personnelWorkloadChart" style="max-height: 400px;"></canvas>
                        </div>
                        <div class="col-12 col-lg-4">
                            <h6 class="mb-3"><i class="fas fa-building me-2"></i>Departman Bazlı Yük</h6>
                            <div id="departmentWorkloadList">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget 6: AI Stratejik Danışman Paneli -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-header text-white" style="background: rgba(255,255,255,0.1); border: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0"><i class="fas fa-robot me-2"></i>AI Stratejik Danışman</h4>
                            <small class="text-white-50">Tüm sistem verilerinizi analiz ederek stratejik tavsiyeler sunar</small>
                        </div>
                        <button class="btn btn-light btn-sm" onclick="loadAIAdvisor()" title="Yenile">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body bg-white">
                    <div id="aiAdvisorContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-3">AI analizi yapılıyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let corporateHealthGauge = null;
let planningEfficiencyChart = null;
let workloadDistributionChart = null;
let personnelWorkloadChart = null;

// Filtreleme parametreleri
let currentFilters = {};

// Sayfa yüklendiğinde verileri çek
document.addEventListener('DOMContentLoaded', function() {
    loadFilterOptions();
    loadExecutiveDashboard();
    loadAIAdvisor(); // AI Danışman panelini yükle
});

function loadFilterOptions() {
    // Departman listesini yükle
    fetch('/api/dashboard/filter-options')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const deptSelect = document.getElementById('filterDepartment');
                const managerSelect = document.getElementById('filterManager');
                
                if (deptSelect && data.departments) {
                    data.departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        deptSelect.appendChild(option);
                    });
                }
                
                if (managerSelect && data.managers) {
                    data.managers.forEach(manager => {
                        const option = document.createElement('option');
                        option.value = manager.id;
                        option.textContent = `${manager.first_name} ${manager.last_name}`;
                        managerSelect.appendChild(option);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Filtre seçenekleri yüklenirken hata:', error);
        });
}

function applyFilters() {
    const department = document.getElementById('filterDepartment')?.value || '';
    const manager = document.getElementById('filterManager')?.value || '';
    const startDate = document.getElementById('filterStartDate')?.value || '';
    const endDate = document.getElementById('filterEndDate')?.value || '';
    
    currentFilters = {};
    if (department) currentFilters.department = department;
    if (manager) currentFilters.manager_id = manager;
    if (startDate) currentFilters.start_date = startDate;
    if (endDate) currentFilters.end_date = endDate;
    
    loadExecutiveDashboard();
}

function clearFilters() {
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterManager').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    currentFilters = {};
    loadExecutiveDashboard();
}

function exportDashboardPDF() {
    const params = new URLSearchParams();
    if (currentFilters.department) params.append('department', currentFilters.department);
    if (currentFilters.manager_id) params.append('manager_id', currentFilters.manager_id);
    if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
    if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);
    
    window.open(`/api/dashboard/export-pdf?${params.toString()}`, '_blank');
}

function loadExecutiveDashboard() {
    const params = new URLSearchParams();
    if (currentFilters.department) params.append('department', currentFilters.department);
    if (currentFilters.manager_id) params.append('manager_id', currentFilters.manager_id);
    if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
    if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);
    
    fetch(`/api/dashboard/executive?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderCorporateHealth(data.data.corporate_health);
                renderScoreFactors(data.data.corporate_health);
                renderCriticalRisks(data.data.critical_risks);
                renderPlanningEfficiency(data.data.planning_efficiency);
                renderWorkloadDistribution(data.data.workload_distribution);
                renderSummaryStats(data.data);
                renderPersonnelWorkload(data.data.personnel_workload);
            } else {
                if (typeof showToast !== 'undefined') {
                    showToast('error', data.message || 'Veriler yüklenemedi.', 'Hata');
                }
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            if (typeof showToast !== 'undefined') {
                showToast('error', 'Dashboard verileri yüklenirken bir hata oluştu!', 'Hata');
            }
        });
}

// XSS koruması: HTML escape fonksiyonu
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return unsafe
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// AI Yönetici Özeti
function renderExecutiveSummary(summary) {
    const container = document.getElementById('executiveSummaryContent');
    if (!container) return;
    
    if (!summary || summary.trim() === '') {
        container.innerHTML = '<p class="text-muted mb-0">Özet oluşturulamadı.</p>';
        return;
    }
    
    // XSS koruması: Summary'yi escape et
    const safeSummary = escapeHtml(summary);
    
    container.innerHTML = `
        <div class="alert alert-info mb-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none;">
            <p class="mb-0" style="font-size: 1.05rem; line-height: 1.8; color: #1565c0;">
                <i class="fas fa-lightbulb me-2"></i>
                ${safeSummary}
            </p>
        </div>
    `;
}

// Widget 1: Kurumsal Nabız (Gauge Chart)
function renderCorporateHealth(healthData) {
    const score = healthData.score || 0;
    const ctx = document.getElementById('corporateHealthGauge');
    
    // Sağlık durumu belirleme
    let status = 'İyi';
    let statusColor = '#28a745';
    if (score < 50) {
        status = 'Kritik';
        statusColor = '#dc3545';
    } else if (score < 75) {
        status = 'Dikkat';
        statusColor = '#ffc107';
    }
    
    // Gauge Chart oluştur
    corporateHealthGauge = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, 100 - score],
                backgroundColor: [statusColor, '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '75%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                
                ctx.save();
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = statusColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(score.toFixed(1), centerX, centerY - 10);
                
                ctx.font = '16px Arial';
                ctx.fillStyle = '#6c757d';
                ctx.fillText('Puan', centerX, centerY + 20);
                ctx.restore();
            }
        }]
    });
    
    // Durum gösterimi
    document.getElementById('healthScoreDisplay').textContent = score.toFixed(1);
    document.getElementById('healthScoreDisplay').style.color = statusColor;
    document.getElementById('healthStatusDisplay').textContent = `${status} (${healthData.project_count || 0} Proje, ${healthData.surec_count || 0} Süreç)`;
}

// Neden Bu Skor? Widget'ı
function renderScoreFactors(healthData) {
    const container = document.getElementById('scoreFactorsList');
    const topEtkenler = healthData.top_etkenler || [];
    
    if (!topEtkenler || topEtkenler.length === 0) {
        container.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Mükemmel!</strong> Skoru düşüren önemli bir etken bulunmamaktadır.
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group">';
    topEtkenler.forEach((etken, index) => {
        const etkenAdi = etken.etken || 'Bilinmeyen Etken';
        const deger = etken.deger || '';
        const etki = etken.etki || '';
        const sayi = etken.sayi || 1;
        
        // Etken tipine göre ikon ve renk belirle
        let icon = 'fas fa-exclamation-triangle';
        let badgeColor = 'warning';
        if (etkenAdi.includes('Geciken')) {
            icon = 'fas fa-clock';
            badgeColor = 'danger';
        } else if (etkenAdi.includes('Kritik Risk')) {
            icon = 'fas fa-exclamation-circle';
            badgeColor = 'danger';
        } else if (etkenAdi.includes('Tamamlanma')) {
            icon = 'fas fa-tasks';
            badgeColor = 'info';
        } else if (etkenAdi.includes('PG')) {
            icon = 'fas fa-chart-line';
            badgeColor = 'warning';
        }
        
        // XSS koruması
        const safeEtkenAdi = escapeHtml(etkenAdi);
        const safeDeger = escapeHtml(deger);
        const safeEtki = escapeHtml(etki);
        
        html += `
            <div class="list-group-item">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <i class="${icon} fa-2x text-${badgeColor}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <span class="badge bg-${badgeColor} me-2">${index + 1}</span>
                            ${safeEtkenAdi}
                        </h6>
                        <p class="mb-1 small">
                            <strong>Değer:</strong> ${safeDeger}
                            ${sayi > 1 ? ` <span class="text-muted">(${sayi} süreçte görüldü)</span>` : ''}
                        </p>
                        <small class="text-danger">
                            <i class="fas fa-arrow-down me-1"></i>
                            <strong>Etki:</strong> ${safeEtki}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    // Eğer etken sayısı 2'den azsa bilgilendirme ekle
    if (topEtkenler.length < 2) {
        html += `
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <small>Diğer etkenler skoru daha az etkilemektedir.</small>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Widget 2: Kritik Risk Radarı
function renderCriticalRisks(risks) {
    const container = document.getElementById('criticalRisksList');
    
    if (!risks || risks.length === 0) {
        container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Kritik risk bulunmamaktadır.</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    risks.forEach((risk, index) => {
        const riskLevel = risk.risk_level || 'Yüksek';
        const badgeColor = risk.risk_score >= 20 ? 'danger' : (risk.risk_score >= 12 ? 'warning' : 'info');
        
        // XSS koruması: Kullanıcı girişlerini escape et
        const safeTitle = escapeHtml(risk.title || '');
        const safeDescription = risk.description ? escapeHtml(risk.description.substring(0, 100) + (risk.description.length > 100 ? '...' : '')) : 'Açıklama yok';
        const safeProjectName = escapeHtml(risk.project_name || '');
        const safeCreatedBy = escapeHtml(risk.created_by || '');
        
        html += `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <span class="badge bg-${badgeColor} me-2">${risk.risk_score}</span>
                            ${safeTitle}
                        </h6>
                        <p class="mb-1 small text-muted">${safeDescription}</p>
                        <small class="text-muted">
                            <i class="fas fa-project-diagram me-1"></i>${safeProjectName} | 
                            <i class="fas fa-user me-1"></i>${safeCreatedBy}
                        </small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">Etki: ${risk.impact}</small>
                        <small class="text-muted d-block">Olasılık: ${risk.probability}</small>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Widget 3: Planlama Becerisi (Bar Chart)
function renderPlanningEfficiency(planningData) {
    const ctx = document.getElementById('planningEfficiencyChart');
    
    if (!planningData || planningData.length === 0) {
        ctx.parentElement.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>Tamamlanan görev verisi bulunmamaktadır.</div>';
        return;
    }
    
    const labels = planningData.map(p => p.project_name);
    const estimated = planningData.map(p => p.estimated_time);
    const actual = planningData.map(p => p.actual_time);
    
    planningEfficiencyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Tahmini Süre (saat)',
                    data: estimated,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Gerçekleşen Süre (saat)',
                    data: actual,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Süre (Saat)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Projeler'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const deviation = planningData[index].deviation_percent;
                            return `Sapma: ${deviation > 0 ? '+' : ''}${deviation.toFixed(1)}%`;
                        }
                    }
                }
            }
        }
    });
}

// Widget 4: Bekleyen İş Yükü (Pie Chart)
function renderWorkloadDistribution(workloadData) {
    const ctx = document.getElementById('workloadDistributionChart');
    
    if (!workloadData || !workloadData.distribution || workloadData.distribution.length === 0) {
        ctx.parentElement.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>Açık görev bulunmamaktadır.</div>';
        return;
    }
    
    const labels = workloadData.distribution.map(d => d.status);
    const data = workloadData.distribution.map(d => d.count);
    
    // Renk paleti
    const colors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)'
    ];
    
    workloadDistributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = workloadData.total_tasks;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Widget 5: Personel Yükü Analizi
function renderPersonnelWorkload(workloadData) {
    if (!workloadData || !workloadData.by_user || workloadData.by_user.length === 0) {
        const container = document.getElementById('personnelWorkloadChart');
        if (container) {
            container.parentElement.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>Aktif görev ataması bulunmamaktadır.</div>';
        }
        return;
    }
    
    const ctx = document.getElementById('personnelWorkloadChart');
    if (!ctx) return;
    
    // En fazla 15 kullanıcı göster
    const topUsers = workloadData.by_user.slice(0, 15);
    const labels = topUsers.map(u => u.user_name);
    const taskCounts = topUsers.map(u => u.task_count);
    
    // Renk gradyanı (daha fazla görev = daha kırmızı)
    const maxTasks = Math.max(...taskCounts);
    const colors = taskCounts.map(count => {
        const intensity = count / maxTasks;
        if (intensity > 0.7) return 'rgba(220, 53, 69, 0.8)'; // Kırmızı (darboğaz)
        if (intensity > 0.4) return 'rgba(255, 193, 7, 0.8)'; // Sarı (orta)
        return 'rgba(40, 167, 69, 0.8)'; // Yeşil (iyi)
    });
    
    personnelWorkloadChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Aktif Görev Sayısı',
                data: taskCounts,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // Yatay bar chart
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Aktif Görev Sayısı'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Personel'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const user = topUsers[index];
                            return `Departman: ${user.department}`;
                        }
                    }
                }
            }
        }
    });
    
    // Departman bazlı yük listesi
    const deptContainer = document.getElementById('departmentWorkloadList');
    if (deptContainer && workloadData.by_department) {
        let html = '<div class="list-group list-group-flush">';
        const sortedDepts = Object.entries(workloadData.by_department)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        sortedDepts.forEach(([dept, count]) => {
            const percentage = (count / taskCounts.reduce((a, b) => a + b, 0) * 100).toFixed(1);
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                    <span class="small">${escapeHtml(dept)}</span>
                    <div>
                        <span class="badge bg-primary rounded-pill">${count}</span>
                        <small class="text-muted ms-1">${percentage}%</small>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        deptContainer.innerHTML = html;
    }
}

// AI Stratejik Danışman
function loadAIAdvisor() {
    const container = document.getElementById('aiAdvisorContent');
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">AI analizi yapılıyor...</p>
        </div>
    `;
    
    fetch('/api/dashboard/ai-advisor')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderAIAdvisor(data.data);
            } else {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message || 'AI danışman verileri yüklenemedi.'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('AI danışman hatası:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    AI danışman verileri yüklenirken bir hata oluştu.
                </div>
            `;
        });
}

function renderAIAdvisor(advisorData) {
    const container = document.getElementById('aiAdvisorContent');
    if (!container) return;
    
    const systemSummary = advisorData.system_summary || {};
    const highlightedRisks = advisorData.highlighted_risks || [];
    const recommendations = advisorData.ai_recommendations || [];
    
    let html = '<div class="row">';
    
    // Sistem Özeti
    html += `
        <div class="col-12 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Sistem Özeti</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h2 class="mb-0 text-${systemSummary.status_color || 'primary'}">
                            ${systemSummary.corporate_health_score || 0}
                        </h2>
                        <small class="text-muted">Kurumsal Sağlık Skoru</small>
                        <div class="mt-2">
                            <span class="badge bg-${systemSummary.status_color || 'primary'}">
                                ${systemSummary.overall_status || 'Bilinmiyor'}
                            </span>
                        </div>
                    </div>
                    <hr>
                    <div class="small">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Toplam Proje:</span>
                            <strong>${systemSummary.total_projects || 0}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Toplam Görev:</span>
                            <strong>${systemSummary.total_tasks || 0}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tamamlanma Oranı:</span>
                            <strong>${systemSummary.completion_rate || 0}%</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Gecikmiş Görev:</span>
                            <strong class="text-danger">${systemSummary.overdue_tasks || 0}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Kritik Risk:</span>
                            <strong class="text-danger">${systemSummary.critical_risks || 0}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>PG Sapması:</span>
                            <strong class="text-warning">${systemSummary.pg_deviations || 0}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Öne Çıkan Riskler
    html += `
        <div class="col-12 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Öne Çıkan Riskler</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
    `;
    
    if (highlightedRisks.length === 0) {
        html += `
            <div class="text-center py-3">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <p class="text-muted small mb-0">Kritik risk bulunmamaktadır.</p>
            </div>
        `;
    } else {
        html += '<div class="list-group list-group-flush">';
        highlightedRisks.forEach((risk, index) => {
            const riskColor = risk.risk_score >= 20 ? 'danger' : (risk.risk_score >= 12 ? 'warning' : 'info');
            html += `
                <div class="list-group-item px-0 py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 small">
                                <span class="badge bg-${riskColor} me-2">${risk.risk_score}</span>
                                ${escapeHtml(risk.title || '')}
                            </h6>
                            <small class="text-muted d-block">${escapeHtml(risk.project_name || '')}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    // AI Tavsiyeleri
    html += `
        <div class="col-12 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>AI Tavsiyeleri</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
    `;
    
    if (recommendations.length === 0) {
        html += `
            <div class="text-center py-3">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <p class="text-muted small mb-0">Şu anda özel tavsiye bulunmamaktadır.</p>
            </div>
        `;
    } else {
        recommendations.forEach((rec, index) => {
            const typeColor = rec.type === 'critical' ? 'danger' : (rec.type === 'warning' ? 'warning' : 'info');
            const priorityBadge = rec.priority === 'high' ? 'danger' : (rec.priority === 'medium' ? 'warning' : 'secondary');
            
            html += `
                <div class="card mb-3 border-${typeColor}" style="border-left: 4px solid var(--bs-${typeColor});">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0 small">${escapeHtml(rec.title || '')}</h6>
                            <span class="badge bg-${priorityBadge}">${rec.priority || 'low'}</span>
                        </div>
                        <p class="small text-muted mb-2">${escapeHtml(rec.description || '')}</p>
                        <div class="d-flex gap-2">
                            <a href="${rec.action_url || '#'}" class="btn btn-sm btn-${typeColor}" target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>${rec.action_label || 'İncele'}
                            </a>
                            <button class="btn btn-sm btn-outline-secondary" onclick="notifyRecommendation('${rec.id || ''}')" title="İlgili Sorumluya Bildir">
                                <i class="fas fa-bell me-1"></i>Bildir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    html += '</div>';
    container.innerHTML = html;
}

function notifyRecommendation(recommendationId) {
    if (!recommendationId) return;
    
    fetch('/api/dashboard/ai-advisor/notify', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            recommendation_id: recommendationId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Tavsiye ilgili sorumluya bildirildi.', 'Başarılı');
        } else {
            showToast('error', data.message || 'Bildirim gönderilemedi.', 'Hata');
        }
    })
    .catch(error => {
        console.error('Bildirim hatası:', error);
        showToast('error', 'Bildirim gönderilirken bir hata oluştu.', 'Hata');
    });
}

// Özet İstatistikler
function renderSummaryStats(data) {
    const container = document.getElementById('summaryStats');
    
    const health = data.corporate_health || {};
    const risks = data.critical_risks || [];
    const planning = data.planning_efficiency || [];
    const workload = data.workload_distribution || {};
    
    let html = '<div class="row">';
    
    // Toplam Proje Sayısı
    html += `
        <div class="col-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>${health.project_count || 0}</h3>
                    <small>Toplam Proje</small>
                </div>
            </div>
        </div>
    `;
    
    // Toplam Süreç Sayısı
    html += `
        <div class="col-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>${health.surec_count || 0}</h3>
                    <small>Toplam Süreç</small>
                </div>
            </div>
        </div>
    `;
    
    // Kritik Risk Sayısı
    html += `
        <div class="col-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h3>${risks.length}</h3>
                    <small>Kritik Risk</small>
                </div>
            </div>
        </div>
    `;
    
    // Açık Görev Sayısı
    html += `
        <div class="col-6 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3>${workload.total_tasks || 0}</h3>
                    <small>Açık Görev</small>
                </div>
            </div>
        </div>
    `;
    
    // Ortalama Sapma
    if (planning.length > 0) {
        const avgDeviation = planning.reduce((sum, p) => sum + Math.abs(p.deviation_percent), 0) / planning.length;
        html += `
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5>Ortalama Planlama Sapması</h5>
                        <h3 class="text-${avgDeviation > 25 ? 'danger' : (avgDeviation > 10 ? 'warning' : 'success')}">
                            ${avgDeviation > 0 ? '+' : ''}${avgDeviation.toFixed(1)}%
                        </h3>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// Sayfa yenileme butonu (opsiyonel)
function refreshDashboard() {
    if (corporateHealthGauge) corporateHealthGauge.destroy();
    if (planningEfficiencyChart) planningEfficiencyChart.destroy();
    if (workloadDistributionChart) workloadDistributionChart.destroy();
    
    loadExecutiveDashboard();
}
</script>
{% endblock %}





















