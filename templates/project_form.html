{% extends "base.html" %}

{% block title %}{% if project %}Proje Düzenle{% else %}Yeni Proje{% endif %}{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('main.dashboard') }}">Ana Sayfa</a> / 
<a href="{{ url_for('main.projeler') }}">Proje Yönetimi</a> / 
{% if project %}Proje Düzenle{% else %}Yeni Proje{% endif %}
{% endblock %}

{% block content %}
{% set notif = project.get_notification_settings() if project else {'reminder_days':[7,3,1],'overdue_frequency':'daily','channels':{'in_app': True, 'email': False},'notify_manager': True,'notify_observers': False} %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram me-2"></i>
                        {% if project %}Proje Düzenle{% else %}Yeni Proje Oluştur{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if not project %}
                    <!-- Şablondan Türet Seçeneği -->
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useTemplate" onchange="toggleTemplateSelection()">
                            <label class="form-check-label" for="useTemplate">
                                <strong>Şablondan Türet</strong>
                            </label>
                        </div>

                        <!-- Bildirim Ayarları -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Bildirim ve Uyarı Ayarları</h6>
                            <p class="text-muted small mb-3">Bu ayarlar, görev deadline yaklaşınca ve gecikince kullanıcıları bilgilendirmek için kullanılır.</p>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="reminder_days" class="form-label">Yaklaşan Deadline Uyarıları (gün)</label>
                                    <input type="text" class="form-control" id="reminder_days" name="reminder_days"
                                           value="{{ notif.reminder_days|join(',') if notif and notif.reminder_days else '7,3,1' }}">
                                    <small class="text-muted">Örnek: 7,3,1 (virgülle ayırın)</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="overdue_frequency" class="form-label">Gecikme Uyarısı Sıklığı</label>
                                    <select class="form-select" id="overdue_frequency" name="overdue_frequency">
                                        <option value="daily" {% if notif and notif.overdue_frequency != 'off' %}selected{% endif %}>Günlük</option>
                                        <option value="off" {% if notif and notif.overdue_frequency == 'off' %}selected{% endif %}>Kapalı</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notify_manager" name="notify_manager" {% if notif and notif.notify_manager %}checked{% endif %}>
                                        <label class="form-check-label" for="notify_manager">Proje yöneticisini de bilgilendir</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notify_observers" name="notify_observers" {% if notif and notif.notify_observers %}checked{% endif %}>
                                        <label class="form-check-label" for="notify_observers">Gözlemcileri de bilgilendir</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="channel_email" name="channel_email" {% if notif and notif.channels and notif.channels.email %}checked{% endif %}>
                                        <label class="form-check-label" for="channel_email">E-posta gönder (opsiyonel)</label>
                                    </div>
                                    <small class="text-muted">Şu an e-posta sadece log seviyesinde, istersen aktive ederiz.</small>
                                </div>
                            </div>
                        </div>
                        <div id="templateSelection" style="display: none;" class="mt-3">
                            <label for="templateProject" class="form-label">Proje Şablonu Seçiniz</label>
                            <select class="form-select" id="templateProject" name="template_project_id">
                                <option value="">Şablon seçiniz...</option>
                                {% if sablon_projeler %}
                                    {% for sablon in sablon_projeler %}
                                    <option value="{{ sablon.id }}">{{ sablon.name }} ({{ sablon.created_at.strftime('%d.%m.%Y') if sablon.created_at else '' }})</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <small class="text-muted">Bir proje seçerseniz, o projenin yapısı kopyalanacak ve aşağıdaki form otomatik doldurulacaktır.</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    <form id="projectForm">
                        <!-- Proje Bilgileri -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Proje Bilgileri</h6>
                            
                            <div class="mb-3">
                                <label for="name" class="form-label">Proje Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ project.name if project else '' }}" required>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="start_date" class="form-label">Başlangıç Tarihi <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" 
                                           value="{{ project.start_date.strftime('%Y-%m-%d') if project and project.start_date else '' }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="end_date" class="form-label">Bitiş Tarihi <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" 
                                           value="{{ project.end_date.strftime('%Y-%m-%d') if project and project.end_date else '' }}" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Açıklama</label>
                                <textarea class="form-control" id="description" name="description" rows="3">{{ project.description if project else '' }}</textarea>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="manager_id" class="form-label">Proje Yöneticisi <span class="text-danger">*</span></label>
                                    <select class="form-select" id="manager_id" name="manager_id" required>
                                        <option value="">Seçiniz...</option>
                                        {% for kullanici in kullanicilar %}
                                        <option value="{{ kullanici.id }}" {% if project and project.manager_id == kullanici.id %}selected{% endif %}>
                                            {{ kullanici.first_name }} {{ kullanici.last_name }} ({{ kullanici.username }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="priority" class="form-label">Öncelik</label>
                                    <select class="form-select" id="priority" name="priority">
                                        <option value="Düşük" {% if project and project.priority == 'Düşük' %}selected{% endif %}>Düşük</option>
                                        <option value="Orta" {% if not project or project.priority == 'Orta' %}selected{% endif %}>Orta</option>
                                        <option value="Yüksek" {% if project and project.priority == 'Yüksek' %}selected{% endif %}>Yüksek</option>
                                        <option value="Kritik" {% if project and project.priority == 'Kritik' %}selected{% endif %}>Kritik</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- İlişkili Süreçler -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">İlişkili Süreçler</h6>
                            <p class="text-muted small mb-3">Bu projeyle ilişkilendirmek istediğiniz süreçleri seçiniz.</p>
                            
                            <input type="text" class="form-control mb-2" id="related_processes_filter"
                                   placeholder="Süreçlerde ara...">
                            <select class="form-select" id="related_processes" name="related_processes" multiple style="max-height: 150px; overflow-y: auto;">
                                {% for surec in surecler %}
                                <option value="{{ surec.id }}" 
                                        {% if project and surec in project.related_processes %}selected{% endif %}>
                                    {{ surec.ad }} {% if surec.dokuman_no %}({{ surec.dokuman_no }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Çoklu seçim için Ctrl (Windows) veya Cmd (Mac) tuşuna basılı tutarak tıklayın.</small>
                        </div>

                        <!-- Üyeler -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Proje Üyeleri</h6>
                            <p class="text-muted small mb-3">Bu projeye dahil olacak kullanıcıları seçiniz.</p>
                            
                            <input type="text" class="form-control mb-2" id="members_filter"
                                   placeholder="Üyelerde ara...">
                            <select class="form-select" id="members" name="members" multiple style="max-height: 150px; overflow-y: auto;">
                                {% for kullanici in kullanicilar %}
                                <option value="{{ kullanici.id }}"
                                        {% if project and kullanici in project.members %}selected{% endif %}>
                                    {{ kullanici.first_name }} {{ kullanici.last_name }} ({{ kullanici.username }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Çoklu seçim için Ctrl (Windows) veya Cmd (Mac) tuşuna basılı tutarak tıklayın.</small>
                        </div>

                        <!-- Gözlemciler -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">Gözlemciler</h6>
                            <p class="text-muted small mb-3">Bu projeyi gözlemleyecek (salt okunur erişim) kullanıcıları seçiniz.</p>
                            
                            <input type="text" class="form-control mb-2" id="observers_filter"
                                   placeholder="Gözlemcilerde ara...">
                            <select class="form-select" id="observers" name="observers" multiple style="max-height: 150px; overflow-y: auto;">
                                {% for kullanici in kullanicilar %}
                                <option value="{{ kullanici.id }}"
                                        {% if project and kullanici in project.observers %}selected{% endif %}>
                                    {{ kullanici.first_name }} {{ kullanici.last_name }} ({{ kullanici.username }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Çoklu seçim için Ctrl (Windows) veya Cmd (Mac) tuşuna basılı tutarak tıklayın.</small>
                        </div>

                        <!-- Butonlar -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('main.projeler') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>İptal
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const projectId = {{ project.id if project else 'null' }};

// Sayfa yüklendiğinde varsayılan tarihleri ayarla (sadece yeni proje için)
{% if not project %}
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Varsayılan başlangıç tarihi: bugün
    if (startDateInput && !startDateInput.value) {
        const today = new Date();
        startDateInput.value = today.toISOString().split('T')[0];
    }
    
    // Varsayılan bitiş tarihi: 3 ay sonra
    if (endDateInput && !endDateInput.value) {
        const threeMonthsLater = new Date();
        threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
        endDateInput.value = threeMonthsLater.toISOString().split('T')[0];
    }
});
{% endif %}

// Şablon seçimi toggle
function toggleTemplateSelection() {
    const checkbox = document.getElementById('useTemplate');
    const templateDiv = document.getElementById('templateSelection');
    if (checkbox && templateDiv) {
        // Checkbox durumuna göre göster/gizle
        if (checkbox.checked) {
            templateDiv.style.display = 'block';
            // Şablon seçildiğinde formu doldur
            const templateId = document.getElementById('templateProject').value;
            if (templateId) {
                loadTemplateProject(templateId);
            }
        } else {
            templateDiv.style.display = 'none';
            // Şablon seçimini temizle
            document.getElementById('templateProject').value = '';
        }
    }
}

// Şablon proje yükleme
function loadTemplateProject(templateId) {
    if (!templateId) return;
    
    fetch(`/api/projeler/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.project) {
                // Formu doldur (sadece bilgiler, görevler kopyalanmaz - bu klonlama ile yapılır)
                document.getElementById('name').value = data.project.name + ' (Kopya)';
                if (data.project.description) {
                    document.getElementById('description').value = data.project.description;
                }
                if (data.project.manager_id) {
                    document.getElementById('manager_id').value = data.project.manager_id;
                }
                
                if (typeof showToast !== 'undefined') {
                    showToast('info', 'Şablon proje bilgileri yüklendi. Projeyi oluşturduktan sonra klonlama yapabilirsiniz.', 'Bilgi');
                }
            }
        })
        .catch(error => {
            console.error('Şablon yükleme hatası:', error);
        });
}

// Şablon dropdown değiştiğinde
{% if not project %}
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('templateProject');
    if (templateSelect) {
        templateSelect.addEventListener('change', function() {
            if (this.value) {
                loadTemplateProject(this.value);
            }
        });
    }
});
{% endif %}

function bindSelectFilter(inputId, selectId) {
    const input = document.getElementById(inputId);
    const select = document.getElementById(selectId);
    if (!input || !select) return;

    input.addEventListener('input', function() {
        const query = input.value.trim().toLowerCase();
        Array.from(select.options).forEach(option => {
            const text = option.textContent.toLowerCase();
            option.hidden = query && !text.includes(query);
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    bindSelectFilter('related_processes_filter', 'related_processes');
    bindSelectFilter('members_filter', 'members');
    bindSelectFilter('observers_filter', 'observers');
});

document.getElementById('projectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Form validasyonu
    const name = document.getElementById('name').value.trim();
    const managerId = document.getElementById('manager_id').value;
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (!name) {
        if (typeof showToast !== 'undefined') {
            showToast('warning', 'Lütfen proje adını girin.', 'Eksik Bilgi');
        }
        document.getElementById('name').focus();
        return;
    }
    
    if (!startDate) {
        if (typeof showToast !== 'undefined') {
            showToast('warning', 'Lütfen başlangıç tarihini seçin.', 'Eksik Bilgi');
        }
        document.getElementById('start_date').focus();
        return;
    }
    
    if (!endDate) {
        if (typeof showToast !== 'undefined') {
            showToast('warning', 'Lütfen bitiş tarihini seçin.', 'Eksik Bilgi');
        }
        document.getElementById('end_date').focus();
        return;
    }
    
    // Tarih kontrolü: Bitiş tarihi başlangıç tarihinden sonra olmalı
    if (new Date(endDate) < new Date(startDate)) {
        if (typeof showToast !== 'undefined') {
            showToast('warning', 'Bitiş tarihi başlangıç tarihinden önce olamaz.', 'Geçersiz Tarih');
        }
        document.getElementById('end_date').focus();
        return;
    }
    
    if (!managerId) {
        if (typeof showToast !== 'undefined') {
            showToast('warning', 'Lütfen proje yöneticisi seçin.', 'Eksik Bilgi');
        }
        document.getElementById('manager_id').focus();
        return;
    }
    
    const formData = new FormData(this);
    
    // Multi-select değerlerini topla
    const relatedProcesses = Array.from(document.getElementById('related_processes').selectedOptions).map(opt => parseInt(opt.value));
    const members = Array.from(document.getElementById('members').selectedOptions).map(opt => parseInt(opt.value));
    const observers = Array.from(document.getElementById('observers').selectedOptions).map(opt => parseInt(opt.value));
    
    const projectData = {
        name: formData.get('name'),
        description: formData.get('description'),
        manager_id: parseInt(formData.get('manager_id')),
        start_date: startDate,
        end_date: endDate,
        priority: formData.get('priority') || 'Orta',
        related_process_ids: relatedProcesses,
        member_ids: members,
        observer_ids: observers,
        notification_settings: {
            reminder_days: (formData.get('reminder_days') || '7,3,1')
                .split(',')
                .map(s => parseInt(String(s).trim()))
                .filter(n => Number.isFinite(n) && n >= 0)
                .sort((a,b) => b-a),
            overdue_frequency: formData.get('overdue_frequency') || 'daily',
            channels: {
                in_app: true,
                email: !!formData.get('channel_email')
            },
            notify_manager: !!formData.get('notify_manager'),
            notify_observers: !!formData.get('notify_observers')
        }
    };
    
    // Submit butonunu devre dışı bırak
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Kaydediliyor...';
    
    try {
        const url = projectId ? `/api/projeler/${projectId}` : '/api/projeler';
        const method = projectId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.content || ''
            },
            body: JSON.stringify(projectData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (typeof showToast !== 'undefined') {
                showToast('success', projectId ? 'Proje başarıyla güncellendi!' : 'Proje başarıyla oluşturuldu!', 'Başarılı');
            }
            // Kısa bir gecikme sonrası yönlendir
            setTimeout(() => {
                window.location.href = projectId ? `/projeler/${projectId}` : '/projeler';
            }, 1000);
        } else {
            if (typeof showToast !== 'undefined') {
                showToast('error', result.message || 'Bilinmeyen bir hata oluştu.', 'Hata');
            }
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Hata:', error);
        if (typeof showToast !== 'undefined') {
            showToast('error', 'Proje kaydedilirken bir hata oluştu. Lütfen tekrar deneyin.', 'Hata');
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});
</script>
{% endblock %}



























