{% extends "base.html" %}

{% block title %}V3 Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header & Tools -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Draggable Dashboard (V3)</h2>
            <p class="text-muted">Panelinizi sÃ¼rÃ¼kleyip bÄ±rakarak Ã¶zelleÅŸtirin.</p>
        </div>
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" id="addWidgetBtn" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fas fa-plus me-1"></i> Widget Ekle / AÃ§
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="addWidgetBtn" id="hiddenWidgetsMenu">
                <li>
                    <h6 class="dropdown-header">Gizli Widgetlar</h6>
                </li>
                <li id="noHiddenWidgetsMsg"><span class="dropdown-item text-muted">TÃ¼m widgetlar aÃ§Ä±k</span></li>
            </ul>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div id="dashboard-grid" class="row g-4">
        {% for widget in layout_config %}
        {% if widget.visible %}
        <div class="col-md-4 widget-wrapper" data-id="{{ widget.id }}">
            <div class="card card-v3 h-100">
                <div class="card-header card-header-v3 d-flex justify-content-between align-items-center handle">
                    <h5 class="mb-0">
                        {% if widget.id == 'widget-1' %}<i class="fas fa-bolt me-2"></i>HÄ±zlÄ± Ä°ÅŸlemler
                        {% elif widget.id == 'widget-2' %}<i class="fas fa-tasks me-2"></i>Benim Masam
                        {% elif widget.id == 'widget-3' %}<i class="fas fa-sticky-note me-2"></i>Karalama Defteri
                        {% elif widget.id == 'widget-4' %}<i class="fas fa-chart-line me-2"></i>Stratejik Ã–zet
                        {% elif widget.id == 'widget-5' %}<i class="fas fa-hourglass-half me-2"></i>YaklaÅŸan Teslimatlar
                        {% endif %}
                    </h5>
                    <button class="btn btn-sm btn-light rounded-circle close-widget-btn"
                        onclick="hideWidget('{{ widget.id }}')" title="Widget'Ä± Gizle">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body">
                    {% if widget.id == 'widget-1' %}
                    <!-- Widget 1: HÄ±zlÄ± Ä°ÅŸlemler -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start p-3 shadow-sm border-0 bg-light-hover">
                            <i class="fas fa-plus-circle fa-lg me-3 text-primary"></i>
                            <span class="fw-bold text-dark">Yeni GÃ¶rev OluÅŸtur</span>
                        </button>
                        <button class="btn btn-outline-success text-start p-3 shadow-sm border-0 bg-light-hover">
                            <i class="fas fa-users fa-lg me-3 text-success"></i>
                            <span class="fw-bold text-dark">ToplantÄ± Planla</span>
                        </button>
                        <button class="btn btn-outline-info text-start p-3 shadow-sm border-0 bg-light-hover">
                            <i class="fas fa-file-invoice fa-lg me-3 text-info"></i>
                            <span class="fw-bold text-dark">Rapor Al</span>
                        </button>
                    </div>

                    {% elif widget.id == 'widget-2' %}
                    <!-- Widget 2: Benim Masam -->
                    <div class="list-group list-group-flush">
                        {% for task in my_tasks %}
                        <a href="#"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-0 border-0 mb-2 rounded bg-white shadow-sm p-3">
                            <div class="d-flex align-items-center">
                                <i class="far fa-check-circle text-success me-3 fa-lg"></i>
                                <span class="fw-medium">{{ task.name }}</span>
                            </div>
                            <span class="badge bg-soft-primary text-primary rounded-pill px-3">{{ task.priority
                                }}</span>
                        </a>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3 text-light-gray"></i>
                            <p class="mb-0">Bekleyen Ã¶nemli bir gÃ¶rev yok.</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 text-center">
                        <a href="#" class="btn btn-sm btn-outline-secondary rounded-pill px-4">TÃ¼mÃ¼nÃ¼ GÃ¶r</a>
                    </div>

                    {% elif widget.id == 'widget-3' %}
                    <!-- Widget 3: Karalama Defteri -->
                    <div class="form-group h-100 d-flex flex-column">
                        <textarea class="form-control bg-light border-0 flex-grow-1 p-3 shadow-inner"
                            id="postit-content" style="resize: none; border-radius: 10px;"
                            placeholder="NotlarÄ±nÄ±zÄ± buraya alÄ±n...">{{ postit_content }}</textarea>
                        <div class="d-flex justify-content-end mt-3">
                            <button class="btn btn-success rounded-pill px-4" onclick="savePostit()">
                                <i class="fas fa-save me-1"></i> Kaydet
                            </button>
                        </div>
                    </div>

                    {% elif widget.id == 'widget-4' %}
                    <!-- Widget 4: Stratejik Ã–zet (Chart.js) -->
                    <div class="position-relative text-center"
                        style="height: 200px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="strategyGaugeChart"></canvas>
                        <!-- Score Overlay -->
                        <div class="position-absolute" style="bottom: 20px; left: 0; right: 0; text-align: center;">
                            <div class="h2 fw-bold mb-0 text-dark">{{ stats.performance }}%</div>
                            <div class="small text-muted">Genel BaÅŸarÄ±m</div>
                        </div>
                    </div>
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-6 border-end text-center">
                            <div class="text-success h4 fw-bold mb-0">{{ stats.completed_tasks }}</div>
                            <small class="text-muted fw-bold text-uppercase"
                                style="font-size: 0.7rem;">TamamlandÄ±</small>
                        </div>
                        <div class="col-6 text-center">
                            <div class="text-warning h4 fw-bold mb-0">{{ stats.pending_tasks }}</div>
                            <small class="text-muted fw-bold text-uppercase"
                                style="font-size: 0.7rem;">Beklemede</small>
                        </div>
                    </div>

                    {% elif widget.id == 'widget-5' %}
                    <!-- Widget 5: YaklaÅŸan Teslimatlar -->
                    <div class="d-flex align-items-center justify-content-center flex-column h-100 py-3">
                        <div class="countdown-timer mb-3 p-4 rounded-circle bg-soft-danger d-flex flex-column align-items-center justify-content-center"
                            style="width: 120px; height: 120px;">
                            <span class="display-4 fw-bold text-danger lh-1">02</span>
                            <span class="small fw-bold text-danger text-uppercase">GÃ¼n</span>
                        </div>
                        <h5 class="mb-1 text-dark fw-bold">Q1 Strateji Raporu</h5>
                        <p class="text-muted small mb-3"><i class="far fa-clock me-1"></i>Son Teslim: 26 Ocak</p>
                        <div class="w-100 px-4">
                            <div class="progress" style="height: 8px; border-radius: 4px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 80%"></div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Initial Layout Config from Server-Side
    let currentLayout = {{ layout_config | tojson | safe }};
    const widgetNames = {
        'widget-1': 'âš¡ HÄ±zlÄ± Ä°ÅŸlemler',
        'widget-2': 'ðŸ“‹ Benim Masam',
        'widget-3': 'ðŸ“ Karalama Defteri',
        'widget-4': 'ðŸ“Š Stratejik Ã–zet',
        'widget-5': 'â³ YaklaÅŸan Teslimatlar'
    };

    document.addEventListener('DOMContentLoaded', function () {
        initSortable();
        updateHiddenMenu();
        initChart();
    });

    function initSortable() {
        var grid = document.getElementById('dashboard-grid');
        new Sortable(grid, {
            animation: 200,
            handle: '.handle',
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                saveLayoutOrder();
            }
        });
    }

    function initChart() {
        const ctx = document.getElementById('strategyGaugeChart');
        if (ctx) {
            const score = {{ stats.performance }
        };

        // Determine color based on score
        let color = '#e74c3c'; // Red
        if (score >= 70) color = '#2ecc71'; // Green
        else if (score >= 40) color = '#f39c12'; // Orange

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Performans', 'Kalan'],
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [color, '#f0f2f5'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                rotation: -90,
                circumference: 180,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }
    }

    function saveLayoutOrder() {
        const visibleElements = document.querySelectorAll('#dashboard-grid .widget-wrapper');
        const visibleIds = Array.from(visibleElements).map(el => el.getAttribute('data-id'));
        const hiddenWidgets = currentLayout.filter(w => !w.visible);

        const newLayout = [];
        visibleIds.forEach(id => {
            newLayout.push({ id: id, visible: true });
        });
        hiddenWidgets.forEach(w => {
            newLayout.push(w);
        });

        currentLayout = newLayout;
        sendLayoutToBackend(newLayout);
    }

    function sendLayoutToBackend(layout) {
        fetch('/v3/api/save_layout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ layout: layout })
        })
            .then(response => response.json())
            .then(data => console.log('Saved:', data))
            .catch(error => console.error('Error:', error));
    }

    function hideWidget(id) {
        const el = document.querySelector(`.widget-wrapper[data-id="${id}"]`);
        if (el) {
            el.style.opacity = '0';
            setTimeout(() => {
                el.remove();

                const widgetIndex = currentLayout.findIndex(w => w.id === id);
                if (widgetIndex > -1) {
                    currentLayout[widgetIndex].visible = false;
                }

                saveLayoutOrder();
                updateHiddenMenu();
            }, 300);
        }
    }

    function showWidget(id) {
        const widgetIndex = currentLayout.findIndex(w => w.id === id);
        if (widgetIndex > -1) {
            currentLayout[widgetIndex].visible = true;
        }
        sendLayoutToBackend(currentLayout);
        window.location.reload();
    }

    function updateHiddenMenu() {
        const menu = document.getElementById('hiddenWidgetsMenu');
        const hiddenWidgets = currentLayout.filter(w => !w.visible);

        menu.innerHTML = '<li><h6 class="dropdown-header">Gizli Widgetlar</h6></li>';
        if (hiddenWidgets.length === 0) {
            menu.innerHTML += '<li id="noHiddenWidgetsMsg"><span class="dropdown-item text-muted">TÃ¼m widgetlar aÃ§Ä±k</span></li>';
        } else {
            hiddenWidgets.forEach(w => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'dropdown-item cursor-pointer';
                a.style.cursor = 'pointer';
                a.innerHTML = `<i class="fas fa-eye me-2"></i> ${widgetNames[w.id] || w.id}`;
                a.onclick = function () { showWidget(w.id); };
                li.appendChild(a);
                menu.appendChild(li);
            });
        }
    }

    function savePostit() {
        const content = document.getElementById('postit-content').value;
        localStorage.setItem('v3_postit_content', content);
        const btn = document.querySelector('#widget-3 button');
        if (btn) {
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Kaydedildi';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-dark');
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.add('btn-success');
                btn.classList.remove('btn-dark');
            }, 2000);
        }
    }

    // Load Postit from LocalStorage
    const serverPostit = "{{ postit_content }}";
    if (!serverPostit) {
        const local = localStorage.getItem('v3_postit_content');
        if (local && document.getElementById('postit-content')) {
            document.getElementById('postit-content').value = local;
        }
    }
</script>

<style>
    /* New V3 Card Styles */
    .card-v3 {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        /* Soft shadow */
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        background: #fff;
    }

    .card-v3:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    /* New Header Styles */
    .card-header-v3 {
        background-color: #2c3e50;
        /* Premium Dark Blue */
        color: white;
        font-weight: 600;
        cursor: move;
        /* Drag cursor */
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
        padding: 1rem 1.25rem;
        border-bottom: 2px solid rgba(0, 0, 0, 0.05);
    }

    .card-header-v3 h5 {
        color: white !important;
        font-size: 1.05rem;
        letter-spacing: 0.5px;
    }

    .card-header-v3 .close-widget-btn {
        background-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
        border: none;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .card-header-v3 .close-widget-btn:hover {
        background-color: #e74c3c;
        color: white;
        transform: rotate(90deg);
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Enhancements for inner elements */
    .bg-soft-primary {
        background-color: rgba(59, 130, 246, 0.1) !important;
    }

    .bg-soft-danger {
        background-color: rgba(239, 68, 68, 0.1) !important;
    }

    .sortable-ghost {
        opacity: 0.4;
        background: #e9ecef;
        border: 2px dashed #adb5bd;
    }

    /* Input focus */
    .form-control:focus {
        box-shadow: none;
        border: 1px solid #2c3e50;
    }

    .bg-light-hover:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}